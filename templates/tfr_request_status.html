<!DOCTYPE html>
<html lang="vi">
<head>
    <title>Test Request</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #fffdfc;
            --main-card: #fffdfccf;
            --main-text: #25312b;
            --main-th: #ffe082;
            --main-th-bright: #fff9d1;
            --main-border: #d8d8cc;
            --color-green: #4e8573;
            --color-bronze: #8B6B1E;
            --color-brown: #6B4F1A;
            --color-red-metallic: #A32121;
            --color-pass: #38b430;
            --color-fail: #df2323;
            --color-na: #666;
            --shadow-light: rgba(0,0,0,0.10);
            --shadow-dark: rgba(255,255,255,0.15);
        }
        body.dark, .dark {
            --main-bg: #2b3938;
            --main-card: #374B4A;
            --main-text: #f6f6ef;
            --main-th: #ffe082;
            --main-th-bright: #fffbe6;
            --main-border: #263d3a;
            --color-green: #91b8a2;
            --color-bronze: #ffc970;
            --color-brown: #bfa87b;
            --color-red-metallic: #ef7373;
            --color-pass: #93e5a0;
            --color-fail: #e68282;
            --color-na: #aaa;
            --shadow-light: rgba(255,255,255,0.07);
            --shadow-dark: rgba(0,0,0,0.13);
        }
        body {
            min-height: 100vh;
            background: var(--main-bg);
            color: var(--main-text);
            font-family: 'Inter', Arial, sans-serif;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.22s, color 0.18s;
        }
        .center-wrapper { min-height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; }
        .box {
            background: var(--main-card);
            color: var(--main-text);
            border-radius: 22px;
            box-shadow: 0 8px 40px #bca96b30, 0 1.5px 13px #c49c4850;
            max-width: 1200px;
            width: 97vw;
            margin: 36px auto 0 auto;
            padding: 35px 0px 20px 0px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: fadeGrow 0.7s;
        }
        @keyframes fadeGrow {0% {opacity:0; transform:scale(0.97);} 100%{opacity:1; transform:scale(1);}}
        .back-home-btn {
            position: absolute;
            left: 26px; top: 18px;
            background: #c49c48; color: #fff; border: none; border-radius: 100px;
            font-size: 15px; font-family: 'Inter', Arial, sans-serif; padding: 6px 16px 6px 12px;
            font-weight: 600; box-shadow: 0 2px 8px #bca96b18; cursor: pointer;
            display: flex; align-items: center; gap: 6px; letter-spacing: 0.01em;
            text-decoration: none; z-index: 2; min-width: 0;
            transition: background 0.18s, color 0.16s, box-shadow 0.17s;
        }
        .back-home-btn[href*="tfr_request_form"],
        .back-home-btn[href*="tfr_request_archive"] {
            left: auto; right: 26px; background: #ffe082; color: #35523A;
        }
        .back-home-btn:hover { background: #35523A; color: #ffe082; }
        .back-home-btn[href*="tfr_request_form"]:hover,
        .back-home-btn[href*="tfr_request_archive"]:hover { background: #c49c48; color: #fff; }
        h2 {
            color: var(--color-green);
            font-family: 'Merriweather', serif;
            font-size: 1.38rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 18px;
            letter-spacing: 0.04em;
            text-shadow: 0 3px 18px #c49c4827;
            margin-top: 40px;
        }
        .table-wrap { width: 100%; overflow-x: auto; padding-bottom: 8px; display: flex; justify-content: center; }
        table {
            width: 100%;
            min-width: 820px;
            max-width: 1100px;
            margin: 0 auto;
            border-collapse: collapse;
            background: #fffbe8e5;
            border-radius: 14px;
            font-size: 0.97rem;
            box-shadow: 0 2px 12px #bca96b18;
            table-layout: fixed;
        }
        th, td { padding: 9px 7px; text-align: center; vertical-align: middle; white-space: nowrap; word-break: break-word; width: calc(100% / 9); }
        th { background: var(--main-th); color: #25312b; font-weight: 700; font-size: 1rem; letter-spacing: 0.04em; border: none; }
        tr:first-child th:first-child { border-radius: 12px 0 0 0; }
        tr:first-child th:last-child { border-radius: 0 12px 0 0; }
        tr:last-child td:first-child { border-radius: 0 0 0 12px; }
        tr:last-child td:last-child { border-radius: 0 0 12px 0; }
        tr:nth-child(even) { background: #faf6ea;}
        tr:nth-child(odd) { background: #fffdfc;}
        td.status.Submitted { color: var(--color-bronze); font-weight: bold; }
        td.status.Approved  { color: var(--color-green); font-weight: bold;}
        td.status.Declined  { color: var(--color-fail); font-weight: bold;}
        td.reason { color: var(--color-fail); font-style: italic; }
        .action-cell { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .btn-action {
            padding: 6px 12px; font-size: 13px; border:none; border-radius:100px; font-weight:600; cursor:pointer;
            transition:background 0.13s, color 0.13s; box-shadow: 0 2px 6px #bca96b13;
        }
        .btn-approve { background: var(--color-green); color: var(--main-th-bright); }
        .btn-approve:hover { background: #346559; color: #fff; }
        .btn-decline { background: var(--color-fail); color: var(--main-th-bright); }
        .btn-decline:hover { background: #be1919; color: #fff; }
        .input-reason { padding: 4px 8px; border-radius: 100px; border:1.2px solid #c49c48; font-size:13px; width:84px; outline: none; background: #fdf8ea; margin-top: 2px; }
        .input-reason:focus { border-color: #35523A;}
        .btn-details, .btn-pdf {
            background: #fff; color: var(--color-bronze); border: 1.1px solid var(--main-th);
            border-radius: 100px; padding: 3px 9px; font-size: 13px; font-weight: 600; margin-left: 1px; margin-top: 2px;
            cursor: pointer; transition: background 0.14s, color 0.13s, border 0.13s; display: inline-block;
        }
        .btn-details:hover, .btn-pdf:hover { background: var(--main-th); color: #25312b; border-color: var(--main-th); }
        .btn-pdf { color: #43a047; border-color: #43a047; }
        .btn-pdf:hover { background: #e8fff3; color: #35523A; border-color: #35523A; }

        .table-toolbar { width: 100%; background: transparent; position: sticky; top: 0; z-index: 3; padding-bottom: 8px; display: flex; justify-content: flex-end; padding-right: 14px; gap:8px; align-items:center; flex-wrap:wrap; }
        .table-toolbar input[type="text"] { padding: 7px 13px; font-size: 14px; border-radius: 8px; border:1.2px solid #ccc; width: 185px; background: #fff; }
        .table-wrap { width: 100vw; max-width: 100vw; overflow-x: auto; background: transparent; }
        table { min-width: 880px; width: max-content; max-width: 100vw; border-collapse: collapse; background: #fffbe8e5; border-radius: 14px; font-size: 0.96rem; box-shadow: 0 2px 12px #bca96b18; table-layout: auto; }
        .approve-all-btn { background: var(--color-green); color: var(--main-th-bright); border-radius: 100px; font-size: 13px; font-weight: 600; padding: 5px 15px; box-shadow: 0 2px 8px #bca96b18; margin-top: 4px; min-width: 0; }
        .approve-all-btn[disabled] { opacity: 0.56; cursor: not-allowed; background: #b1bab6 !important; color: #fff; border: none; }

        .legend-mini{ margin-right:auto; display:flex; align-items:center; gap:10px; font-size:12.6px; color:#35523A;}
        .legend-item{ display:flex; align-items:center; gap:6px;}
        .dot{ width:10px; height:10px; border-radius:50%; display:inline-block;}
        .dot-mint{ background:#2db39a;}
        .dot-hot{ background:#d81b60;}

        @media (max-width: 1200px) {
            .box { max-width: 98vw; width: 98vw; }
            .table-wrap { max-width: 100vw; }
            table { max-width: 98vw; min-width: 680px; }
            th, td { font-size: 11.8px; padding: 7px 3px; }
            .legend-mini{ font-size:12px; }
        }
        @media (max-width: 900px) {
            .box { width: 100vw; max-width: 100vw; min-width: 0; }
            .back-home-btn, .back-home-btn[href*="tfr_request_form"],
            .back-home-btn[href*="tfr_request_archive"] {
                font-size: 13px; padding: 5px 10px 5px 8px; top: 11px; border-radius: 100px;
            }
            .back-home-btn[href*="tfr_request_form"], .back-home-btn[href*="tfr_request_archive"] { right: 13px; }
            .back-home-btn { left: 13px; }
            .table-wrap { max-width: 100vw; }
            table { min-width: 580px; font-size: 11px; }
            th, td { font-size: 10.9px; padding: 6px 2.5px; }
            h2 { margin-top: 31px; font-size: 1.1rem; }
        }
        @media (max-width: 600px) {
            .box { max-width: 99vw; width: 99vw; }
            .back-home-btn, .back-home-btn[href*="tfr_request_form"],
            .back-home-btn[href*="tfr_request_archive"] {
                font-size: 11px; padding: 3px 6px 3px 5px; top: 6px; border-radius: 100px;
            }
            .back-home-btn[href*="tfr_request_form"], .back-home-btn[href*="tfr_request_archive"] { right: 6px; }
            .back-home-btn { left: 6px; }
            .table-wrap { max-width: 100vw; }
            table { min-width: 470px; font-size: 10px;}
            th, td { padding: 5px 1.5px;}
            h2 { margin-top: 19px; font-size: 0.99rem;}
            .legend-mini{ font-size:11px; gap:8px; }
        }

        /* Dark mode tweaks */
        body.dark .box { background: var(--main-card) !important; color: var(--main-text) !important; }
        body.dark h2, body.dark th { color: var(--main-th) !important; background: none !important;}
        body.dark th { color: #25312b !important; background: var(--main-th) !important; }
        body.dark table, body.dark tr:nth-child(even), body.dark tr:nth-child(odd) { background: #344833 !important; }
        body.dark td, body.dark th { color: #25312b !important; }
        body.dark .back-home-btn { background: var(--main-th) !important; color: #344833 !important;}
        body.dark .back-home-btn:hover { background: #c49c48 !important; color: #fff !important;}
        body.dark .btn-action, body.dark .btn-update {color:#25312b;}
        body.dark .btn-approve { background: var(--color-green) !important; color: #25312b !important;}
        body.dark .btn-approve:hover { background: #bfe3d1 !important; color: #25312b !important;}
        body.dark .btn-decline { background: var(--color-fail) !important; color: #25312b !important;}
        body.dark .btn-decline:hover { background: #be1919 !important; color: #fff !important;}
        body.dark .btn-details, body.dark .btn-pdf { background: #344833 !important; color: var(--main-th) !important; border-color: var(--main-th);}
        body.dark .btn-details:hover, body.dark .btn-pdf:hover { background: var(--main-th) !important; color: #25312b !important; border-color: var(--main-th);}
        body.dark .input-reason {background:#3f5250 !important; color:#f6f6ef !important; border-color:#91b8a2;}
        body.dark ::selection {background: #c49c48; color: #25312b;}
        body.dark .table-toolbar input { background:#3f5250 !important; color:#f6f6ef !important; border-color:#91b8a2 !important; }
        body.dark input[type="date"]::placeholder { color: #ffe082 !important; opacity: 1; }
        body.dark td { color: #fffbe6 !important; }

        #theme-btn {
            position:fixed; right:24px; bottom:26px; z-index:11001;
            background: var(--main-th);
            color: #344833;
            border-radius: 100px; font-size: 19px;
            padding: 6px 12px; border:none; box-shadow: 0 2px 10px #4d665c35;
            cursor:pointer; height: 42px; width: 42px; min-width:38px;
            display:flex;align-items:center;justify-content:center;opacity:0.96;
            transition: background 0.16s, color 0.16s;
        }
        #theme-btn:hover { background: var(--color-green); color: #fff; }
        body.dark #theme-btn { background: #6c837f; color: #ffe082; }

        .top-bar{ position:absolute; top:18px; left:26px; right:26px; display:flex; justify-content:space-between; align-items:center; z-index:10; }
        .top-bar .right{ display:flex; gap:8px; flex-wrap:wrap; }
        .top-bar .back-home-btn{ position:static !important; left:auto !important; right:auto !important; }
        .home-btn{ background:#c49c48; color:#fff; }
        .archive-btn,.create-btn{ background:#ffe082; color:#35523A; }
        .archive-btn:hover,.create-btn:hover{ background:#c49c48; color:#fff; }

        @media (max-width:600px){
          .top-bar{ top:6px; left:6px; right:6px; }
          .top-bar .right{ gap:5px; }
          .top-bar .back-home-btn{ font-size:11px; padding:3px 6px 3px 5px; }
        }

        /* ====== Modal Detail: ảnh trên, thông tin dưới ====== */
        .detail-img-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 6px 0 12px 0;
            justify-items: center;
        }
        .detail-img-grid img {
            max-width: 180px; max-height: 140px; border-radius: 10px; border: 2px solid #4e8573;
            box-shadow: 0 2px 10px #0002; background: #fff; object-fit: contain; cursor: zoom-in;
            transition: transform .15s, box-shadow .18s, border-color .2s;
        }
        .detail-img-grid img:hover { transform: scale(1.06); box-shadow: 0 8px 26px #4e857355; border-color: #c49c48; }
        .detail-info { font-size: 0.98em; white-space: pre-line; }
        .detail-key { color:#b8922e; font-weight:700; }

        /* Modal wrap */
        #modal-detail-backdrop {
            display:none; position:fixed; inset:0; background:rgba(44,50,36,0.23);
            align-items:center; justify-content:center; z-index:9999;
        }
        #modal-detail-card {
            background:#fff; color:#222; border-radius:16px; box-shadow:0 6px 28px #4d665c88;
            max-width:94vw; min-width:260px; padding:24px 10px 14px 17px; position:relative;
        }

        /* Phóng to ảnh */
        #modal-img {
            display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:10000;
            align-items:center; justify-content:center; padding: 22px;
        }
        #modal-img .inner {
            background:#111; border-radius:12px; padding:10px; position:relative; max-width:95vw; max-height:92vh;
            display:flex; align-items:center; justify-content:center;
        }
        #modal-img img { max-width:92vw; max-height:88vh; object-fit:contain; border-radius:8px; }
        #modal-img button { position:absolute; right:10px; top:8px; border:none; background:none; color:#fff; font-size:1.6em; cursor:pointer; }

        /* Progress modal from your code (giữ nguyên) */
        @keyframes stripeMove { 0% { background-position: 0 0; } 100% { background-position: 40px 0; } }
        .progress-outer { width:100%; height:12px; background:#f0e7c0; border-radius:999px; overflow:hidden; position:relative; box-shadow: inset 0 1px 3px rgba(0,0,0,.08); }
        .progress-inner { height:100%; width:0%; background: repeating-linear-gradient(45deg, rgba(78,133,115,1) 0 16px, rgba(78,133,115,.9) 16px 32px); animation: stripeMove 1.1s linear infinite; transition: width .35s ease; }
        .progress-percent { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:700; color:#35523A; mix-blend-mode: plus-lighter; }
        .modal-head { display:flex; align-items:center; gap:10px; margin-bottom:10px; font-weight:700; color:#35523A; }
        .spin { display:inline-block; width:16px; height:16px; border:2px solid #91b8a2; border-top-color:#35523A; border-radius:50%; animation: spin .8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg);} }
        .badge-done { display:inline-flex; align-items:center; gap:6px; font-weight:700; color:#2e7d32; }
        .fade-in { animation: fadeIn .25s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:translateY(0);} }
        tr.rank-mint td:nth-child(-n+6)  { color: #2db39a !important; font-weight: 700; }
        tr.rank-hot  td:nth-child(-n+6)  { color: #d81b60 !important; font-weight: 800; }

        .legend-mini{
          position:absolute; top:70px; left:26px; display:flex; flex-direction:column; gap:6px; z-index:5;
        }
        .legend-card{
          min-width:110px; display:flex; align-items:center; gap:8px; background:#fffef6;
          border:1px solid #eadca6; border-radius:12px; padding:6px 12px; box-shadow:0 2px 8px rgba(188,169,107,.15);
        }
        .legend-card .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; }
        .dot-mint{ background:#2db39a; } .dot-hot{ background:#d81b60; }
        .legend-text{ font-weight:700; color:#35523A; font-size:13px; }
        body.dark .legend-card{ background:#3f5250; border-color:#91b8a2; box-shadow:0 2px 8px rgba(0,0,0,.25); }
        body.dark .legend-text{ color:#fffbe6; }
    </style>
</head>
<body>
    <button id="theme-btn" title="Chuyển Dark/Light mode"><i class="fa fa-moon"></i></button>
    <div class="center-wrapper">
    <div class="box">
        <div class="top-bar">
            <div class="left">
                <a href="/" class="back-home-btn home-btn"><i class="fa fa-chevron-left"></i> Home</a>
            </div>
            <div class="right">
                <a href="/tfr_request_archive" class="back-home-btn archive-btn">
                    <i class="fa fa-file-alt"></i> Approved Requests
                </a>
                <a href="/tfr_request_form" class="back-home-btn create-btn">
                    <i class="fa fa-file-alt"></i> Create New Request
                </a>
            </div>
        </div>

        <h2>Submitted Test Requests</h2>
        {% if is_admin or is_stl %}
        <div class="legend-mini">
          <div class="legend-card"><span class="dot dot-mint"></span><div class="legend-text">CON, TRANS: +1 day/ FIN, MAT: +2 day</div></div>
          <div class="legend-card"><span class="dot dot-hot"></span><div class="legend-text">CON, TRANS: +2 day/ FIN, MAT: +4 day</div></div>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div style="color:#d32f2f;font-weight:bold;margin-bottom:10px;text-align:center;">
              {{ messages[0] }}
            </div>
          {% endif %}
        {% endwith %}

        <div class="table-toolbar">
            <button id="sort-toggle" class="btn-details">
                <i class="fa fa-sort"></i> Sort: {{ 'Type' if request.args.get('sort')=='type' else 'Date' }}
            </button>
            <input type="text" id="search-id" placeholder="Tìm theo TRQ-ID..." oninput="searchID()">

            {% if is_admin %}
                {% set can_approve_all = true %}
                {% for r in requests %}
                    {% if r.status == "Submitted" and (not r.etd) %}
                        {% set can_approve_all = false %}
                    {% endif %}
                {% endfor %}
                <form method="post" action="/tfr_request_status" class="js-remember" style="display:inline;" onsubmit="openConfirmApproveAll(); return false;">
                    <input type="hidden" name="action" value="approve_all">
                    <input type="hidden" name="return_url" value="{{ request.full_path }}">
                    {% for r in requests %}
                        <input type="hidden" name="etd-{{ real_indices[loop.index0] }}" value="{{ r.etd or '' }}">
                    {% endfor %}
                    <button type="submit"
                        class="btn-action btn-approve approve-all-btn"
                        style="margin-left:12px; margin-bottom:5px; padding: 5px 15px; font-size:13px;"
                        {% if not can_approve_all %}disabled title="Hãy điền đủ ETD cho tất cả trước khi duyệt!"{% endif %}>
                        <i class="fa fa-check-double"></i> Approve all
                    </button>
                </form>
            {% endif %}
        </div>

        <div class="table-wrap">
        <table id="req-table">
            <tr>
                <th>No.</th>
                <th>TRQ-ID</th>
                <th>Type of Test</th>
                <th>Requestor</th>
                <th>Dept.</th>
                <th>Date</th>
                <th>Status</th>
                <th>ETD</th>
                <th>Reason</th>
                <th></th>
            </tr>
            {% for r in requests %}
            {# --- GROUP & RANK --- #}
            {% set grp = (r._group_norm or r.group or r.test_group or r.type_of_test or '')|upper %}
            {# ưu tiên _rank_color (đếm theo TRQ duy nhất). fallback _rank_in_day_group nếu backend chưa update #}
            {% set rk  = r._rank_color if r._rank_color is not none else (r._rank_in_day_group or 0) %}
            {% set row_class = '' %}

            {# --- COLORING RULES BY GROUP --- #}
            {% if is_admin or is_stl %}
            {% if grp in ['CONSTRUCTION', 'TRANSIT'] %}
                {% if 6 <= rk and rk <= 10 %}
                {% set row_class = 'rank-mint' %}
                {% elif 11 <= rk and rk <= 30 %}
                {% set row_class = 'rank-hot' %}
                {% endif %}
            {% elif grp in ['FINISHING', 'MATERIAL'] %}
                {% if 16 <= rk and rk <= 30 %}
                {% set row_class = 'rank-mint' %}
                {% elif 31 <= rk and rk <= 60 %}
                {% set row_class = 'rank-hot' %}
                {% endif %}
            {% endif %}
            {% endif %}

            <tr class="{{ row_class }}"
                data-type="{{ (r.type_of_test or r.test_group or '') | replace(' TEST', '') }}"
                data-date="{{ r.request_date or '' }}"
                data-idx="{{ real_indices[loop.index0] }}">
                <td>{{ loop.index }}</td>
                <td class="col-trq">{{ r.trq_id }}</td>
                <td class="col-type">{{ r.test_group | replace(' TEST', '') }}</td>
                <td>{{ r.requestor }}</td>
                <td>{{ r.department }}</td>
                <td class="col-date" style="min-width:66px;">{{ r.request_date }}</td>
                <td class="status {{ r.status }}" style="min-width:78px;">{{ r.status }}</td>
                <td>
                    {% if is_admin and r.status == "Submitted" %}
                        <form method="post" action="/tfr_request_status" class="js-remember" style="margin:0;display:inline-flex;align-items:center;gap:2px;">
                            <input type="hidden" name="trq_id" value="{{ r.trq_id }}">
                            <input type="hidden" name="edit_idx" value="{{ real_indices[loop.index0] }}">
                            <input type="hidden" name="return_url" value="{{ request.full_path }}">
                            <input type="date" name="etd" value="{{ r.etd or '' }}" required style="padding:4px; font-size:13px; min-width:108px;"
                                onchange="saveETD(this, '{{ r.trq_id }}', {{ real_indices[loop.index0] }})" />
                            <button type="submit" name="action" value="approve" class="btn-action btn-approve" style="margin-left:2px;">Approve</button>
                            <button type="button" class="btn-action btn-decline" onclick="showDecline({{ loop.index0 }})" style="margin-left:2px;">Decline</button>
                        </form>
                    {% else %}
                        {{ r.etd or "N/A" }}
                    {% endif %}
                </td>
                <td class="reason" id="reason-{{ loop.index0 }}">
                    {% if r.status == "Declined" %}{{ r.decline_reason }}{% endif %}
                    {% if is_admin and r.status == "Submitted" %}
                        <form method="post" action="/tfr_request_status" class="js-remember" id="form-decline-{{ loop.index0 }}" style="display:none; margin-top:4px;">
                            <input type="hidden" name="trq_id" value="{{ r.trq_id }}">
                            <input type="hidden" name="edit_idx" value="{{ real_indices[loop.index0] }}">
                            <input type="hidden" name="return_url" value="{{ request.full_path }}">
                            <input type="text" name="decline_reason" class="input-reason" placeholder="Lý do decline..." required>
                            <button type="submit" name="action" value="decline" class="btn-action btn-decline" style="padding:6px 12px;">Xác nhận</button>
                            <button type="button" class="btn-details" onclick="hideDecline({{ loop.index0 }})">Hủy</button>
                        </form>
                    {% endif %}
                </td>
                <td>
                    <!-- Luôn có nút 'mắt' để xem ảnh + chi tiết -->
                    <button class="btn-details" onclick="showDetail({{ loop.index0 }})" title="Chi tiết & ảnh"><i class="fa fa-eye"></i></button>

                    {% if is_admin
                    or (viewer_name and (viewer_name|trim|lower == (r.requestor|trim|lower)))
                    or (viewer_emp_id and ((r.employee_id|string)|trim|lower == (viewer_emp_id|trim|lower))) %}
                    <form method="post" action="/tfr_request_status" class="js-remember" style="display:inline;">
                        <input type="hidden" name="trq_id" value="{{ r.trq_id }}">
                        <input type="hidden" name="edit_idx" value="{{ real_indices[loop.index0] }}">
                        <input type="hidden" name="return_url" value="{{ request.full_path }}">
                        {% if not is_admin %}
                        <input type="hidden" name="staff_id" value="{{ request.args.get('staff_id','') or session.get('staff_id','') }}">
                        {% endif %}
                        <button type="submit" name="action" value="duplicate" class="btn-details"
                                style="background:#e3f7fa; color:#289abf; border-color:#8be4fc; margin-left:3px;"
                                title="{% if is_admin %}Duplicate giữ nguyên TRQ{% else %}Duplicate tạo TRQ mới{% endif %}">
                            <i class="fa fa-copy"></i> Dup
                        </button>
                    </form>
                    {% endif %}
                    <form method="get" action="/tfr_request_form" style="display:inline;">
                        <input type="hidden" name="trq_id" value="{{ r.trq_id }}">
                        <input type="hidden" name="edit_idx" value="{{ real_indices[loop.index0] }}">
                        <button type="submit" class="btn-details" style="background:#fffbe8;color:#c49c48;">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                    </form>
                    <form method="post" action="/tfr_request_status" class="js-remember" style="display:inline;" onsubmit="return confirmDelete('{{ r.requestor }}', '{{ r.trq_id }}');">
                        <input type="hidden" name="trq_id" value="{{ r.trq_id }}">
                        <input type="hidden" name="edit_idx" value="{{ real_indices[loop.index0] }}">
                        <input type="hidden" name="return_url" value="{{ request.full_path }}">
                        <button type="submit" name="action" value="delete" class="btn-details" style="background:#fff3e0; color:#df2323; border-color:#df2323; margin-left:3px;">
                            <i class="fa fa-trash"></i> Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
        </div>

        <!-- Modal chi tiết (ẢNH + THÔNG TIN) -->
        <div id="modal-detail-backdrop">
            <div id="modal-detail-card">
                <button onclick="hideDetail()" style="position:absolute;right:12px;top:8px; border:none; background:none; font-size:1.4em; color:#c49c48; cursor:pointer;"><i class="fa fa-times"></i></button>
                <h3 style="color:#c49c48;text-align:center;margin:0 0 12px 0;font-family:'Merriweather',serif;font-size:1.06em;">Chi tiết Test Request</h3>
                <div id="detail-content"></div>
            </div>
        </div>

        <!-- Modal xem PDF (giữ nguyên nếu cần dùng) -->
        <div id="modal-pdf" style="display:none; position:fixed; inset:0; background:rgba(44,50,36,0.33); align-items:center; justify-content:center; z-index:99999;">
            <div style="background:#222; border-radius:14px; max-width:94vw; width:98vw; height:92vh; box-shadow:0 6px 28px #4d665c88; position:relative; display:flex; flex-direction:column;">
                <button onclick="hidePDF()" style="position:absolute;right:18px;top:11px; border:none; background:none; font-size:1.7em; color:#ffe082; cursor:pointer; z-index:2;"><i class="fa fa-times"></i></button>
                <iframe id="pdf-frame" style="flex:1; width:100%; height:100%; border:none; border-radius:12px;" src=""></iframe>
            </div>
        </div>

        <!-- Modal phóng to ảnh -->
        <div id="modal-img">
            <div class="inner">
                <button onclick="hideImg()"><i class="fa fa-times"></i></button>
                <img id="img-big" src="" alt="image">
            </div>
        </div>

    </div>
    </div>

    <script>
        let cancelRequested = false;

        // ===== helpers =====
        const STATIC_PREFIX = "{{ url_for('static', filename='') }}";
        function toStaticURL(p){
            if(!p) return null;
            if(typeof p !== 'string') return null;
            if(p.startsWith('http://') || p.startsWith('https://') || p.startsWith('data:')) return p;
            if(p.startsWith('/static/')) return p;
            if(p.startsWith('static/')) return '/' + p;
            return (STATIC_PREFIX + p.replace(/^\/+/, ''));
        }

        function confirmDelete(requestor, trq_id) {
            return confirm("Bạn có chắc muốn xóa request của requestor: " + requestor + " (TRQ-ID: " + trq_id + ") không?");
        }
        function saveETD(input, trq_id, idx) {
            const etd = input.value;
            fetch('/save_etd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({trq_id, etd, idx})
            })
            .then(res => res.json())
            .then(data => { if (!data.success) alert('Không lưu được ETD: ' + (data.message || 'Lỗi không xác định!')); });
        }
        // Darkmode toggle
        let dark = localStorage.getItem("vfr-darkmode") === "1";
        function applyDark(b) { document.body.classList.toggle("dark", b); localStorage.setItem("vfr-darkmode", b ? "1" : "0"); }
        applyDark(dark);
        document.getElementById('theme-btn').onclick = () => { dark = !dark; applyDark(dark); };

        // Decline form toggle
        function showDecline(idx) { document.getElementById("form-decline-" + idx).style.display = "inline-block"; }
        function hideDecline(idx) { document.getElementById("form-decline-" + idx).style.display = "none"; }

        // ===== Detail modal (ảnh + json info) =====
        const requests = {{ requests | tojson }};
        function collectImages(obj){
            const imgs = [];
            const push = (v)=>{
                if(!v) return;
                if(Array.isArray(v)) v.forEach(x=>push(x));
                else if(typeof v === 'string') imgs.push(v);
            };
            // Ưu tiên key chuẩn nếu backend đã normalize
            push(obj.initial_images);
            // Fallback các key khác (ĐÃ THÊM initial_img)
            ['initial_img','initial_image','initial_image_url','form_image','form_images','uploaded_images','product_images','images']
            .forEach(k=>push(obj[k]));
            // loại trùng
            const uniq = Array.from(new Set(imgs.map(s=>s.trim()).filter(Boolean)));
            // map về URL có thể hiển thị
            return uniq.map(toStaticURL).filter(Boolean);
        }

        function showDetail(idx) {
            const data = requests[idx] || {};
            const imgUrls = collectImages(data);

            let html = '';
            if (imgUrls.length) {
                html += '<div class="detail-img-grid">';
                html += imgUrls.map(u => `<img src="${u}" alt="img" onclick="openImg('${u}')">`).join('');
                html += '</div>';
            }

            // Thông tin (bỏ status/decline_reason và TẤT CẢ key ảnh)
            html += '<div class="detail-info">';
            for (let k in data) {
                if (!Object.prototype.hasOwnProperty.call(data,k)) continue;
                if ([
                    'status','decline_reason',
                    // Bỏ qua các key ảnh (ĐÃ THÊM initial_img)
                    'initial_images','initial_img','initial_image','initial_image_url',
                    'form_image','form_images','uploaded_images','product_images','images'
                ].includes(k)) continue;

                const label = k.replace(/_/g, " ").replace(/\b\w/g, l=>l.toUpperCase());
                const val = (data[k] == null || data[k] === '') ? "<span style='color:#999;'>N/A</span>" : data[k];
                html += `<b class="detail-key">${label}:</b> ${val}<br/>`;
            }
            html += `<b class="detail-key">Status:</b> ${data.status || 'N/A'}<br/>`;
            if (data.status === "Declined") html += `<b class="detail-key">Reason:</b> ${(data.decline_reason||"")}<br/>`;
            html += '</div>';

            document.getElementById("detail-content").innerHTML = html;
            document.getElementById("modal-detail-backdrop").style.display = "flex";
        }
        function hideDetail() { document.getElementById("modal-detail-backdrop").style.display = "none"; }

        // Phóng to ảnh
        function openImg(src){
            const img = document.getElementById('img-big');
            img.src = src;
            document.getElementById('modal-img').style.display = 'flex';
        }
        function hideImg(){
            document.getElementById('img-big').src = '';
            document.getElementById('modal-img').style.display = 'none';
        }

        // PDF modal (nếu dùng)
        function showPDF(link) { document.getElementById("pdf-frame").src = link; document.getElementById("modal-pdf").style.display = "flex"; }
        function hidePDF() { document.getElementById("pdf-frame").src = ""; document.getElementById("modal-pdf").style.display = "none"; }

        function searchID() {
            const val = document.getElementById("search-id").value.toUpperCase();
            const rows = document.querySelectorAll("#req-table tr");
            for (let i = 1; i < rows.length; i++) {
                const td = rows[i].querySelector("td.col-trq");
                const match = td && td.textContent.toUpperCase().includes(val);
                rows[i].style.display = match ? "" : "none";
            }
        }

        // ====== Sort toggle ======
        const sortBtn = document.getElementById("sort-toggle");
        sortBtn?.addEventListener("click", () => {
            const url = new URL(location.href);
            const cur = url.searchParams.get("sort") || "date";
            url.searchParams.set("sort", (cur === "type") ? "date" : "type");
            location.href = url.toString();
        });

        // ====== APPROVE ALL (giữ nguyên code gốc) ======
        function formatRangeSecToText(minSec, maxSec) {
            function fmt(s){
                const m = Math.floor(s/60), r = s%60;
                if (m >= 60) {
                    const h = Math.floor(m/60), mm = m%60;
                    return mm ? `${h}h ${mm}m` : `${h}h`;
                }
                return r ? `${m}m ${r}s` : `${m}m`;
            }
            return minSec===maxSec ? fmt(minSec) : `${fmt(minSec)} – ${fmt(maxSec)}`;
        }

        let confirmModal;
        function showConfirmModal(count, onOK){
            if (!confirmModal){
                confirmModal = document.createElement('div');
                confirmModal.id = 'modal-confirm';
                confirmModal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100001;';
                confirmModal.innerHTML = `
                  <div style="background:#fff;border-radius:16px;box-shadow:0 10px 35px rgba(0,0,0,.25);width:min(440px,92vw);padding:18px 16px 14px 16px;position:relative;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                      <i class="fa fa-check-double" style="color:#4e8573;"></i>
                      <div style="font-weight:800;color:#35523A;">Xác nhận duyệt tất cả</div>
                    </div>
                    <div id="confirm-summary" style="font-size:14px;color:#25312b;margin:4px 0 10px 0;"></div>
                    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
                      <button id="btn-cancel-confirm" class="btn-details" style="padding:6px 12px;border-radius:10px;">Hủy</button>
                      <button id="btn-ok-confirm" class="btn-action btn-approve" style="padding:6px 14px;border-radius:10px;"><i class="fa fa-play"></i> Bắt đầu</button>
                    </div>
                  </div>`;
                document.body.appendChild(confirmModal);
                confirmModal.addEventListener('click', (e)=>{
                    if (e.target === confirmModal) confirmModal.style.display = 'none';
                });
            }
            const perMin = 15, perMax = 30; // giây / request
            const minSec = count * perMin;
            const maxSec = count * perMax;
            const summary = `
              <div style="display:flex;flex-direction:column;gap:6px;">
                <div><b>Số lượng sẽ duyệt:</b> ${count}</div>
                <div><b>Ước tính thời gian:</b> ${formatRangeSecToText(minSec, maxSec)}</div>
                <div style="font-size:12px;color:#666;">(Ước tính dựa trên 15–30 giây / request)</div>
              </div>`;
            confirmModal.querySelector('#confirm-summary').innerHTML = summary;
            confirmModal.style.display = 'flex';

            confirmModal.querySelector('#btn-cancel-confirm').onclick = () => { confirmModal.style.display = 'none'; };
            confirmModal.querySelector('#btn-ok-confirm').onclick = () => { confirmModal.style.display = 'none'; onOK && onOK(); };
        }

        function openConfirmApproveAll(){
            const rows = Array.from(document.querySelectorAll("#req-table tr[data-type]"));
            const items = [];
            for (const tr of rows) {
                const status = tr.querySelector(".status")?.textContent?.trim();
                const etdInp = tr.querySelector('input[type="date"][name="etd"]');
                const etdVal = etdInp ? etdInp.value : (tr.querySelector("td:nth-child(8)")?.textContent?.trim() || "");
                if (status === "Submitted" && etdVal) {
                    const trq = tr.querySelector(".col-trq")?.textContent?.trim();
                    const type = (tr.getAttribute("data-type") || "").trim();
                    const date = (tr.getAttribute("data-date") || "").trim();
                    const idxAttr = tr.getAttribute("data-idx");
                    const idx = idxAttr ? parseInt(idxAttr, 10) : null;
                    if (trq) items.push({ trq_id: trq, etd: etdVal, type, date, idx });
                }
            }

            function parseDate(s){
                if(!s) return new Date(8640000000000000);
                let d = new Date(s);
                if (!isNaN(d)) return d;
                const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (m){
                    const dd = +m[1], mm = +m[2]-1, yy = +m[3];
                    d = new Date(yy, mm, dd);
                    if (!isNaN(d)) return d;
                }
                return new Date(s);
            }
            items.sort((a,b)=>{
                const d = parseDate(a.date) - parseDate(b.date);
                if (d !== 0) return d;
                return a.type.localeCompare(b.type);
            });

            showConfirmModal(items.length, ()=> startApproveAll(items));
        }

        // ====== Progress modal (giữ nguyên logic cũ) ======
        const modalProgress = document.createElement("div");
        modalProgress.id = "modal-progress";
        modalProgress.style.cssText = "display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:100000; align-items:center; justify-content:center;";
        modalProgress.innerHTML = `
          <div style="background:#fff; color:#25312b; border-radius:16px; padding:18px; width:min(460px,92vw); box-shadow:0 8px 30px rgba(0,0,0,0.25);">
            <div class="modal-head" id="progress-head">
              <span class="spin" id="progress-spin" aria-hidden="true"></span>
              <span id="progress-title">Đang duyệt yêu cầu…</span>
            </div>
            <div id="progress-text" style="font-size:14px; margin:6px 0 10px 0;">Bắt đầu…</div>
            <div class="progress-outer">
              <div id="progress-bar" class="progress-inner"></div>
              <div id="progress-percent" class="progress-percent">0%</div>
            </div>
            <div id="progress-footer" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
              <button id="btn-cancel-progress" style="border:none; border-radius:10px; padding:7px 12px; background:#b71c1c; color:#fff; font-weight:700;">
                <i class="fa fa-ban"></i> Cancel
              </button>
              <button id="btn-close-progress" style="display:none; border:none; border-radius:10px; padding:7px 12px; background:#2e7d32; color:#fff; font-weight:700;">
                <i class="fa fa-check-circle"></i> Xong
              </button>
            </div>
          </div>`;
        document.body.appendChild(modalProgress);

        const bar    = modalProgress.querySelector("#progress-bar");
        const txt    = modalProgress.querySelector("#progress-text");
        const title  = modalProgress.querySelector("#progress-title");
        const spin   = modalProgress.querySelector("#progress-spin");
        const pctEl  = modalProgress.querySelector("#progress-percent");
        const btnOk  = modalProgress.querySelector("#btn-close-progress");
        const btnCancel = modalProgress.querySelector("#btn-cancel-progress");

        btnOk.addEventListener("click", ()=> modalProgress.style.display="none");
        btnCancel.addEventListener("click", ()=>{
            cancelRequested = true;
            title.textContent = "Sẽ dừng sau request hiện tại…";
            btnCancel.disabled = true;
        });

        function setPercent(p){
            const pct = Math.max(0, Math.min(100, Math.round(p)));
            bar.style.width = pct + "%";
            pctEl.textContent = pct + "%";
        }

        async function startApproveAll(items){
            modalProgress.style.display="flex";
            setPercent(0);
            txt.textContent="Bắt đầu…";
            cancelRequested = false;
            btnCancel.disabled = false;
            btnOk.style.display="none";
            spin.style.display="inline-block";

            const resp = await fetch("/approve_all_stream", {
                method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({updates: items})
            });
            if(!resp.body){ txt.textContent="Không nhận được dữ liệu."; return; }

            const reader = resp.body.getReader(), decoder=new TextDecoder();
            let buffer=""; let total=0, done=0;

            while(true){
                const {value,done:streamDone} = await reader.read();
                if(streamDone) break;
                buffer += decoder.decode(value,{stream:true});
                let idx;
                while((idx=buffer.indexOf("\n"))>=0){
                    const line=buffer.slice(0,idx).trim(); buffer=buffer.slice(idx+1);
                    if(!line) continue;
                    try{
                        const msg=JSON.parse(line);
                        if(msg.type==="start"){ total=msg.total; txt.textContent=`0/${total}`; }
                        else if(msg.type==="progress"){
                            done=msg.done; setPercent(done*100/total);
                            txt.textContent=`Đã duyệt ${done}/${total}`;
                            if(cancelRequested){
                                title.textContent="Đã dừng bởi người dùng";
                                spin.style.display="none";
                                btnOk.style.display="inline-flex";
                                return;
                            }
                        }else if(msg.type==="done"){
                            setPercent(100);
                            txt.textContent=`Hoàn tất ${msg.done}/${msg.total}`;
                            spin.style.display="none"; btnOk.style.display="inline-flex";
                            setTimeout(()=>location.reload(),1200);
                        }
                    }catch{}
                }
            }
        }

        // ===== Giữ scroll & sort =====
        document.querySelectorAll('form.js-remember').forEach(f=>{
            f.addEventListener('submit', ()=>{
                sessionStorage.setItem('tfr_scroll', window.scrollY);
                sessionStorage.setItem('tfr_sort', new URL(location.href).searchParams.get("sort")||"date");
            });
        });
        window.addEventListener("load", ()=>{
            const y=sessionStorage.getItem('tfr_scroll');
            if(y){ window.scrollTo(0, parseInt(y)); sessionStorage.removeItem('tfr_scroll'); }
            const s=sessionStorage.getItem('tfr_sort');
            if(s){ const url=new URL(location.href); url.searchParams.set("sort",s); history.replaceState(null,"",url); sessionStorage.removeItem('tfr_sort'); }
        });
    </script>
</body>
</html>
