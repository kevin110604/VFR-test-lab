<!DOCTYPE html>
<html>
<head>
    <title>{{ title['full'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
    :root {
        --main-bg: #fffdfc;               /* nền sáng */
        --main-card: #fffdfccf;           /* thẻ box/card */
        --main-text: #25312b;             /* chữ mặc định */
        --main-th: #ffe082;               /* vàng nhấn */
        --main-th-bright: #fff9d1;        /* vàng sáng nhất cho chữ trên nút */
        --main-border: #d8d8cc;
        --color-green: #4e8573;           /* xanh nút mới */
        --color-bronze: #8B6B1E;
        --color-brown: #6B4F1A;
        --color-red-metallic: #A32121;
        --color-pass: #38b430;
        --color-fail: #df2323;
        --color-na: #666;
        --color-text-dark: #25312b;
        --color-text-light: #F9F7F0;
        --shadow-light: rgba(0,0,0,0.10);
        --shadow-dark: rgba(255,255,255,0.15);
        --dark-pass: #2a4e20;
        --dark-fail: #6a1b1b;
        --color-beige-bg: #F5F1E6;
        --color-accent: #4e8573;  
    }

    body.dark, .dark {
        --main-bg: #2b3938;               /* nền tối */
        --main-card: #374B4A;             /* box/card tối */
        --main-text: #f6f6ef;             /* chữ trắng sữa */
        --main-th: #ffe082;               /* vàng nhấn (giữ nguyên) */
        --main-th-bright: #fffbe6;        /* vàng sáng nhất */
        --main-border: #263d3a;
        --color-green: #91b8a2;           /* xanh nhạt dùng cho dark mode */
        --color-bronze: #ffc970;
        --color-brown: #bfa87b;
        --color-red-metallic: #ef7373;
        --color-pass: #93e5a0;
        --color-fail: #e68282;
        --color-na: #aaa;
        --color-text-dark: #f6f6ef;
        --color-text-light: #f6f6ef;
        --shadow-light: rgba(255,255,255,0.07);
        --shadow-dark: rgba(0,0,0,0.13);
        --dark-pass: #4e7763;
        --dark-fail: #ce4343;
        --color-beige-bg: #374B4A;
        --color-accent: #91b8a2; 
    }
    html, body {
        min-height: 100vh;
        background: var(--main-bg);
        color: var(--main-text);
        font-family: 'Open Sans', Arial, sans-serif;
        margin:0;padding:0;
        transition: background 0.27s, color 0.21s;
    }
    body.dark, .dark {
        color: var(--color-text-light) !important;
        transition: background 0.27s, color 0.21s;
    }
    body.dark .box {
        background: var(--main-card) !important;
        color: var(--main-text) !important;
        box-shadow: 0 4px 32px var(--shadow-dark);
    }
    body.dark h2,
    body.dark .cmt-label,
    body.dark .section b {
        color: var(--main-th) !important;
    }
    body.dark .img-thumb, body.dark .sample-img {
        border-color: var(--color-accent) !important;
        background: #222 !important;
    }
    body.dark .back-btn,
    body.dark .gold-upload-btn,
    body.dark .del-btn {
        background: var(--main-th) !important;
        color: #25312b !important;
        border-color: var(--main-th);
    }
    .report-banner {
        color: #d6c49d;
        font-size: 21px;
        font-weight: bold;
        text-align: center;
        margin-top: 6px;
        margin-bottom: 14px;
        letter-spacing: 1px;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }
    .back-btn,
    .gold-upload-btn,
    .del-btn {
        color: #fff !important;
    }
    #theme-btn {
        position: fixed; right: 24px; bottom: 26px; z-index: 11001;
        background: var(--color-bronze); color: #fff;
        border-radius: 100px; font-size: 17px;
        padding: 6px 11px; border:none; box-shadow: 0 2px 10px var(--shadow-light);
        cursor:pointer; height: 38px; width: 38px; min-width:36px;
        display:flex;align-items:center;justify-content:center;opacity:0.96;
        transition: background 0.16s, color 0.16s;
    }
    #theme-btn:hover { background: var(--color-accent); color: #fff; opacity:1; }
    .sample-img, .img-thumb {
        transition: box-shadow 0.22s, transform 0.18s, background 0.34s, border-color 0.32s;
    }
    .box {
        transition: background 0.38s cubic-bezier(.37,.15,.36,1), color 0.36s cubic-bezier(.44,.09,.42,.97), box-shadow 0.22s;
        background: #fffdfccf;
        max-width: 540px;
        margin: 0 auto 32px auto;
        border-radius: 18px;
        box-shadow: 0 4px 30px var(--shadow-light);
        padding: 34px 20px 32px 20px;
        animation: fadeGrow 0.7s;
        position:relative;
        font-family: 'Open Sans', Arial, sans-serif;
        color: var(--color-text-dark);
    }
    @keyframes fadeGrow {
        0% { opacity: 0; transform: scale(0.98);}
        100% { opacity: 1; transform: scale(1);}
    }
    .back-btn-container {
        text-align: left;
        margin-bottom: 6px;
        margin-top: 0;
    }
    .back-btn {
        background: #faf7ec;
        color: #73592c !important;
        border: 1px solid #d5c69d;
        border-radius: 11px;
        font-family: 'Inter', 'Open Sans', Arial, sans-serif;
        font-size: 13.3px;
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 4px 12px 4px 11px;
        min-width: 0;
        box-shadow: 0 1px 6px #d4c8942a;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        transition: background 0.13s, color 0.13s, border-color 0.13s;
    }
    .back-btn:hover {
        background: #ffe082;
        color: #25312b !important;
        border-color: #ffe082;
    }
    .back-btn svg {
        margin: 0 !important;
    }

    h2 {
        color: var(--color-green);
        margin-bottom: 12px;
        text-align:center;
        font-size: 25px;
        font-weight: bold;
        letter-spacing: 1.1px;
        margin-top: 0;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }

    /* ===== STATUS + COMMENT (giống hot_cold) ===== */
    .status-block { text-align:center; margin-bottom:10px; }
    .inline-status {
        font-size: 20px;
        font-weight: 700;
        margin: 0 auto 6px auto;
        display: inline-block;
        letter-spacing: .04em;
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0;
    }
    .inline-status.pass { color: var(--color-pass); }
    .inline-status.fail { color: var(--color-fail); }
    .inline-status.na   { color: var(--color-na); }

    .missing-img-warn {color:#e33;font-size:16px;text-align:center;margin:4px auto 6px auto;font-weight:bold;}

    .cmt-view { text-align:center; margin-top:6px; }
    .cmt-view span{
        border-radius: 6px;
        background:#f2f6f6;
        padding:6px 11px;
        font-size:15px;
        color:#215d37;
        display:inline-block;
    }
    body.dark .cmt-view span {
        background:#314844;
        color:#ffe082;
    }
    /* ============================================= */

    .section { margin-bottom:28px; text-align:center;}
    .section b { color: var(--color-green); font-size:18px; font-weight:700; letter-spacing: 0.06em;}
    .sample-img {
        border-radius: 13px;
        border: 3px solid var(--color-green);
        max-width: 340px; max-height: 200px;
        min-width: 120px;
        object-fit: contain;
        background: #fff;
        box-shadow: 0 8px 24px var(--shadow-light);
        cursor: zoom-in;
    }
    .sample-img:hover {box-shadow: 0 12px 38px var(--color-accent);transform: scale(1.08) rotate(-1.5deg);}
    .state-btn-group {display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:6px;}
    .state-btn {
        font-size:18px; padding:7px 18px; border:none; border-radius:9px; font-weight:bold;
        color: var(--main-th-bright);
    }
    .pass {background: var(--color-pass); color:white;}
    .fail {background: var(--color-fail); color:white;}
    .na {background:#7a7a7a; color:white;}
    .selected { box-shadow: 0 0 0 3px #93e5a0;}
    .img-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 18px;
        justify-items: center;
        align-items: center;
        margin-bottom: 22px;
        margin-top: 6px;
    }
    .img-thumb-wrap {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 140px;
        height: 140px;
    }
    .img-thumb {
        max-width:130px; max-height:130px;
        border-radius:11px;
        border:2px solid var(--color-green);
        box-shadow:0 4px 18px var(--shadow-light);
        cursor:zoom-in;
        background: #fff;
        transition: box-shadow 0.15s, transform 0.12s, background 0.21s, border-color 0.21s;
        display: block;
        margin: 0 auto;
    }
    .img-thumb:hover {box-shadow:0 8px 26px var(--color-accent);transform: scale(1.06);}
    .del-btn {
        position: absolute;
        top: 8px;
        right: 10px;
        background: var(--color-fail);
        color: #fff;
        border: none;
        border-radius: 100px;
        width: 28px; height: 28px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px #2225;
        opacity: 0.91;
        z-index: 2;
        transition: opacity 0.18s, box-shadow 0.14s, background 0.18s;
        outline: none;
        cursor: pointer;
        padding: 0;
    }
    .del-btn:hover {opacity: 1; background:#760212;}
    .comment-block {text-align:center;margin:18px 0 7px 0;}
    .cmt-label {font-size:17px;color: var(--color-green);}
    .center {text-align:center;}
    .gold-upload-btn {
        background: var(--color-accent);
        color: #fff;
        font-size: 17px;
        padding: 10px 32px;
        border-radius: 9px;
        font-weight: bold;
        border: none;
        margin: 10px auto 0 auto;
        box-shadow: 0 2px 10px var(--shadow-light);
        display: inline-block;
        text-align:center;
        cursor:pointer;
        min-width:135px;
        position: relative;
        overflow: hidden;
    }
    .gold-upload-btn:hover { background: var(--color-brown); color: #fff; }
    body.dark .gold-upload-btn:hover { background: #ffe082; color: #25312b; }
    #img-popup {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.88);
        align-items: center;
        justify-content: center;
        transition: background 0.24s;
    }
    #img-popup.show { display: flex; }
    #img-popup-inner {
        max-width: 88vw; max-height: 80vh;
        border-radius: 18px;
        border: 4px solid #eacb82;
        background: #fff;
        box-shadow: 0 8px 56px #000b;
        object-fit: contain;
        display: block;
        margin:auto;
        transition: background 0.22s, border-color 0.22s, box-shadow 0.18s;
    }
    #img-popup-close {
        position: absolute;
        top: 20px; right: 36px;
        color: #fff;
        font-size: 33px;
        font-weight: bold;
        background: rgba(0,0,0,0.18);
        border: none;
        border-radius: 100px;
        width: 44px; height:44px;
        line-height: 36px;
        text-align: center;
        cursor:pointer;
        z-index: 3200;
        box-shadow: 0 2px 12px #2226;
        transition: background 0.13s;
    }
    #img-popup-close:hover {background:rgba(220,40,40,0.22);}
    .ripple {
      position: absolute; border-radius: 50%; transform: scale(0);
      animation: ripple 0.32s cubic-bezier(0.39, 0.58, 0.57, 1);
      background: rgba(255,255,255,0.29); pointer-events: none; z-index: 10; opacity: 0.77;
    }
    @keyframes ripple { to { transform: scale(1.5); opacity: 0; } }
    textarea {
        width: 97%;
        max-width: 380px;
        border-radius: 8px;
        padding: 7px;
        font-size: 16px;
        border: 1.2px solid var(--main-th);
        background: #fffbe5;
        color: var(--main-text);
        transition: background 0.17s, color 0.16s, border-color 0.14s;
    }
    body.dark textarea {
        background: #3f5250;
        color: #f6f6ef;
        border-color: #91b8a2;
    }
    body.dark textarea:focus {
        border-color: #ffe082;
        background: #405e59;
        color: #fff;
    }
    </style>
</head>
<body>
    <button id="theme-btn" title="Chuyển Dark/Light mode"><i class="fa fa-moon"></i></button>
    <div class="report-banner">
        📝 MÃ REPORT: {{ report }}
    </div>
    <div class="box" role="main">
        <div class="back-btn-container">
            <a href="{{ url_for('test_group_page', report=report, group=group) }}" class="back-btn"
                tabindex="0"
                aria-label="Quay lại chọn mục kiểm tra">
            <i class="fa fa-arrow-left"></i> 
                Quay lại chọn mục kiểm tra
            </a>
        </div>
        <h2>{{ title['short'] }}</h2>

        {# Fallback trạng thái/ghi chú nếu route chưa pass trực tiếp #}
        {% set _st = (status or (test_status[key]['status'] if test_status and key in test_status else None)) %}
        {% set _cm = (comment or (test_status[key]['comment'] if test_status and key in test_status else None)) %}

        <!-- STATUS + COMMENT (đã sửa cho giống hot_cold) -->
        <div class="status-block" role="status" aria-live="polite" aria-atomic="true">
            {% if _st %}
                <div class="inline-status {{ 'pass' if _st == 'PASS' else ('fail' if _st == 'FAIL' else 'na') }}">
                    {{ _st }}
                </div>
            {% endif %}

            {% if (_st == "PASS" or _st == "FAIL") and (imgs|length == 0) %}
                <div class="missing-img-warn">Chưa upload ảnh kiểm thử!</div>
            {% endif %}

            {% if _cm %}
                <div class="cmt-view">
                    <span><i class="fa fa-comment"></i> {{ _cm }}</span>
                </div>
            {% endif %}
        </div>
        <!-- /STATUS + COMMENT -->

        <div class="section">
            <b>Mô tả kiểm thử:</b><br>
            {% for img in title['img'] %}
                <img src="{{ img }}" style="max-width:210px; margin:8px; border-radius:10px; border:2px solid #b8bbcf; box-shadow:0 2px 9px #8884;" alt="Ảnh mẫu kiểm thử"
                     class="sample-img"
                     onclick="showPopup(this)">
            {% endfor %}
            <br>
            <small>Nhấp vào ảnh mẫu để phóng to xem chi tiết</small>
        </div>
        <form method="POST" class="state-btn-group" aria-label="Chọn trạng thái kiểm thử">
            <input type="hidden" name="group" value="{{ group }}">
            <button name="status" value="PASS" type="submit"
                class="state-btn pass {% if _st == 'PASS' %}selected{% endif %}" aria-pressed="{{ 'true' if _st == 'PASS' else 'false' }}">PASS</button>
            <button name="status" value="FAIL" type="submit"
                class="state-btn fail {% if _st == 'FAIL' %}selected{% endif %}" aria-pressed="{{ 'true' if _st == 'FAIL' else 'false' }}">FAIL</button>
            <button name="status" value="N/A" type="submit"
                class="state-btn na {% if _st == 'N/A' %}selected{% endif %}" aria-pressed="{{ 'true' if _st == 'N/A' else 'false' }}">N/A</button>
        </form>
        <form method="POST" enctype="multipart/form-data" style="margin-bottom:13px;text-align:center;position:relative;" aria-label="Upload ảnh kiểm thử">
            <input type="file" name="test_imgs" multiple accept="image/*" style="display:none;" id="test-imgs-upload"
                onchange="submitTestImgs(this, 'test-imgs-fake-btn')">

            <!-- Nút chọn ảnh -->
            <button type="button" class="gold-upload-btn" onclick="triggerUpload('test-imgs-upload')">
                <i class="fa fa-upload"></i> Chọn và tải ảnh
                <span id="test-imgs-fake-btn">Chưa chọn file</span>
            </button>

            <!-- ✅ VÙNG KÉO THẢ MỚI -->
            {% if session.get('role') in ['stl', 'superadmin'] %}
            <div id="drop-zone"
                style="border: 2px dashed #c49c48; border-radius: 12px; margin-top:12px; padding:26px 14px;
                        color:#7a6a3f; font-weight:600; font-size:15px; background:#fffdf3;
                        transition: background 0.22s, border-color 0.22s; cursor:pointer;">
                <i class="fa fa-cloud-upload" style="font-size:22px;color:#c49c48;margin-bottom:6px;"></i><br>
                Kéo và thả hình vào đây để tải lên
            </div>
            {% endif %}
        </form>
        <div class="img-grid" aria-live="polite" aria-atomic="true">
        {% if imgs %}
            {% for img in imgs %}
                <div class="img-thumb-wrap">
                <img src="{{ img }}" class="img-thumb" onclick="showPopup(this)" tabindex="0" alt="Ảnh kiểm thử">
                <form method="POST" action="{{ url_for('delete_test_group_image', report=report, group=group, key=key, imgfile=img.split('/')[-1]) }}">
                    <button type="submit" class="del-btn"><i class="fa fa-trash"></i></button>
                </form>
            </div>
            {% endfor %}
        {% else %}
            <div style="width:100%;text-align:center;"><i>Chưa có ảnh nào.</i></div>
        {% endif %}
        </div>
        <form method="POST" class="comment-block" aria-label="Thêm ghi chú hoặc comment">
            <input type="hidden" name="group" value="{{ group }}">
            <label class="cmt-label" for="comment_input">Thêm ghi chú/comment:</label><br>
            <textarea name="comment_input" id="comment_input" rows="2">{{ _cm or '' }}</textarea>
            <br>
            <button type="submit" name="save_comment" class="gold-upload-btn" style="margin-top:7px; font-size:15px;">Lưu comment</button>
        </form>
    </div>
    <div id="img-popup" role="dialog" aria-modal="true" aria-label="Ảnh kiểm thử phóng to">
        <button id="img-popup-close" title="Đóng">&times;</button>
        <img id="img-popup-inner" src="" alt="Ảnh kiểm thử lớn"/>
    </div>
    <script>
    /* ============================================
    1️⃣ Hiệu ứng Ripple cho tất cả các nút
    ============================================ */
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('button, .test-btn, .gold-upload-btn, .back-btn, .del-btn, #theme-btn')
            .forEach(function(btn) {
                btn.addEventListener('click', function (e) {
                    var circle = document.createElement("span");
                    circle.className = "ripple";
                    var rect = btn.getBoundingClientRect();
                    var size = Math.max(rect.width, rect.height) * 0.58;
                    circle.style.width = circle.style.height = size + 'px';
                    circle.style.left = (e.clientX - rect.left - size/2) + 'px';
                    circle.style.top = (e.clientY - rect.top - size/2) + 'px';
                    btn.appendChild(circle);
                    setTimeout(()=>circle.remove(), 340);
                });
            });
    });

    /* ============================================
    2️⃣ Dark / Light Mode
    ============================================ */
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem("darkmode") === "true") {
            document.documentElement.classList.add('dark');
            document.body.classList.add('dark');
        }
        var themeBtn = document.getElementById('theme-btn');
        function syncDarkModeBtn() {
            var dark = document.body.classList.contains('dark');
            themeBtn.innerHTML = dark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
        }
        themeBtn.onclick = function() {
            var d = document.body.classList.toggle('dark');
            document.documentElement.classList.toggle('dark');
            localStorage.setItem("darkmode", d ? "true" : "false");
            syncDarkModeBtn();
        };
        syncDarkModeBtn();
    });

    /* ============================================
    3️⃣ Phóng to / Thu nhỏ ảnh kiểm thử
    ============================================ */
    function showPopup(img) {
        var popup = document.getElementById('img-popup');
        var popupImg = document.getElementById('img-popup-inner');
        popupImg.src = img.src;
        popup.classList.add('show');
    }
    document.getElementById('img-popup-close').onclick = function(e) {
        var popup = document.getElementById('img-popup');
        popup.classList.remove('show');
        document.getElementById('img-popup-inner').src = '';
        e.stopPropagation();
    };
    document.getElementById('img-popup').onclick = function(e) {
        if (e.target === this) {
            this.classList.remove('show');
            document.getElementById('img-popup-inner').src = '';
        }
    };
    document.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
            var popup = document.getElementById('img-popup');
            popup.classList.remove('show');
            document.getElementById('img-popup-inner').src = '';
        }
    });

    /* ============================================
    4️⃣ Upload ảnh (Click chọn file)
    ============================================ */
    function triggerUpload(inputId) {
        document.getElementById(inputId).click();
    }

    function submitTestImgs(input, spanId) {
        var btn = document.getElementById(spanId);
        if(input.files && input.files.length > 0) {
            btn.innerText = Array.from(input.files).map(f=>f.name).join(', ');
            var form = input.closest('form');
            if(form) setTimeout(()=>form.submit(), 200);
        } else {
            btn.innerText = "Chưa chọn file";
        }
    }

    /* ============================================
    5️⃣ Upload ảnh (Kéo – Thả)
    ============================================ */
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('drop-zone');
        const input = document.getElementById('test-imgs-upload');

        if (!dropZone || !input) return;

        // Khi kéo file vào
        function highlight(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.background = '#fff8dc';
            dropZone.style.borderColor = '#a68c2c';
        }

        // Khi rời hoặc thả file
        function unhighlight(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.background = '#fffdf3';
            dropZone.style.borderColor = '#c49c48';
        }

        // Sự kiện kéo/thả
        ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, highlight));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, unhighlight));

        // Khi thả file
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                input.files = files;
                document.getElementById('test-imgs-fake-btn').innerText =
                    Array.from(files).map(f => f.name).join(', ');
                submitTestImgs(input, 'test-imgs-fake-btn');
            }
        });
    });

    /* ============================================
    6️⃣ Lưu vị trí cuộn trang (Scroll Position)
    ============================================ */
    document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", function() {
            localStorage.setItem("scrollTop", window.scrollY);
        });
    });
    window.addEventListener("DOMContentLoaded", function() {
        let scroll = localStorage.getItem("scrollTop");
        if (scroll !== null) {
            window.scrollTo(0, parseInt(scroll));
            localStorage.removeItem("scrollTop");
        }
    });
    </script>
</body>
</html>
