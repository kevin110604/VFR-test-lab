<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>M∆∞·ª£n h√†ng - {{ area_name }}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    /* ======= Bi·∫øn m√†u & tone gi·ªëng trang Home ======= */
    :root {
      --main-bg: #fffdfc;
      --main-card: #fffdfccf;
      --main-text: #333;
      --main-th: #4d665c;
      --main-border: #4d665c55;
      --main-btn: #c49c48;
      --main-btn-hover: #35523A;
      --main-btn-text: #fff;
      --main-btn-hover-text: #ffe082;
      --main-btn-dark: #97722a;
      --main-btn-dark-hover: #333f20;
    }
    body.darkmode {
      --main-bg: #2b3938;
      --main-card: #374B4A;
      --main-text: #f6f6ef;
      --main-th: #ffe082;
      --main-border: #263d3a;
      --main-btn: #97722a;
      --main-btn-hover: #35523A;
      --main-btn-text: #fff;
      --main-btn-hover-text: #ffe082;
    }

    /* ======= Layout container (gi·ªëng Home) ======= */
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      margin: 0;
      background: var(--main-bg);
      color: var(--main-text);
      transition: background .3s, color .3s;
    }
    .center-form {
      max-width: 820px;
      margin: 60px auto;
      background: var(--main-card);
      border-radius: 22px;
      box-shadow: 0 4px 28px var(--main-border);
      padding: 40px 24px;
      position: relative;
    }
    h2 {
      text-align: center;
      font-size: 28px;
      color: var(--main-th);
      margin: 10px 0 18px 0;
    }

    /* ======= N√∫t quay l·∫°i ======= */
    .back-btn {
      position: absolute; top: 18px; left: 18px; z-index: 1000;
      background: #faf7ec; color: #73592c !important; border: 1px solid #d5c69d; border-radius: 11px;
      font-size: 13.3px; font-weight: 600; letter-spacing: 0.03em; padding: 5px 12px;
      display: inline-flex; align-items: center; gap: 7px; text-decoration: none;
      box-shadow: 0 1px 6px #d4c8942a; transition: background .13s, color .13s, border-color .13s;
    }
    .back-btn:hover { background: #ffe082; color: #25312b !important; border-color: #ffe082; }

    /* ======= Dark/Light button gi·ªëng Home ======= */
    #theme-btn {
      position: fixed; right: 24px; bottom: 26px; z-index: 11001;
      background: #8B6B1E; color: #fff; border-radius: 100px; font-size: 17px;
      padding: 6px 11px; border: none; height: 38px; width: 38px; min-width: 36px;
      display: flex; align-items: center; justify-content: center; opacity: .96;
      box-shadow: 0 2px 10px rgba(0,0,0,.10); cursor: pointer; transition: background .16s, color .16s;
    }
    #theme-btn:hover { background: #C49C48; color: #fff; }
    body.darkmode #theme-btn { background: #6c837f !important; color: #fefefe !important; }

    /* ======= √î t√¨m Code ======= */
    .search-panel {
      background: #fffbe8; border-radius: 12px; border: 1.5px solid #ffe082;
      box-shadow: 0 1px 6px #f7cf3a18; padding: 14px; margin: 6px auto 18px; max-width: 640px;
    }
    .search-row {
      display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;
    }
    .search-row label {
      display: flex; align-items: center; gap: 6px; font-size: 14.7px; font-weight: 700; color: #b78e24; white-space: nowrap;
    }
    .search-row input[type="text"] {
      flex: 1; min-width: 0; height: 34px; font-size: 15px; font-weight: 600;
      border-radius: 7px; border: 1.3px solid #d9bc6d; background: #fff; color: #444; padding: 5px 11px;
      transition: border .13s;
    }
    .search-row input[type="text"]:focus { border-color: #c49c48; outline: none; }
    .btn-primary {
      background: var(--main-btn); color: var(--main-btn-text);
      border: none; border-radius: 7px; font-weight: 800; letter-spacing: .01em;
      height: 34px; padding: 0 14px; box-shadow: 0 1px 7px #c49c4830; cursor: pointer;
      transition: background .16s, color .16s, transform .12s, box-shadow .15s;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary:hover { background: var(--main-btn-hover); color: var(--main-btn-hover-text); transform: translateY(-1px); }

    /* ======= Cards ======= */
    .cards { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; }
    .card-item {
      width: 320px; max-width: 100%;
      border: 2px solid var(--main-btn); border-radius: 14px; background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,.06); padding: 14px;
    }
    .item-head { display: flex; align-items: center; justify-content: space-between; font-weight: 800; color: var(--main-th); }
    .item-meta { color: #444; font-size: 14px; line-height: 1.5; margin-top: 6px; }
    .hint { font-size: 13px; color: #666; }
    .ok   { border-color: #43a047; }
    .warn { border-color: #fbc02d; background: rgba(251,192,45,.07); }
    .fail { border-color: #e74c3c; background: rgba(231,76,60,.07); }
    .status { margin-top: 8px; font-weight: 800; }

    .badge-ok          { color: #1f5130; font-weight: 800; }
    .badge-unavailable { color: #e74c3c; font-weight: 800; }

    /* File input full width, c√°ch n√∫t 10px */
    .card-item input[type="file"] {
      width: 100%; max-width: 100%; box-sizing: border-box; display: block; margin: 0 auto 10px;
    }

    /* ======= Popup ======= */
    .popup-mask{
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.35); backdrop-filter: blur(1px); z-index: 1250;
    }
    .popup-card{
      background: #fffbe8; border: 1.5px solid #ffe082; border-radius: 16px; padding: 22px;
      width: min(92vw, 520px); box-shadow: 0 8px 28px rgba(0,0,0,.18); text-align: center;
    }
    .popup-card .btn-primary { width: 100%; height: 38px; }

    /* ======= Responsive ======= */
    @media (max-width: 768px) {
      .center-form { padding: 24px 14px; }
      h2 { font-size: 22px; }
      .card-item { width: 92%; max-width: 420px; margin-left: auto; margin-right: auto; }
      .search-row { gap: 6px; }
    }
    @media (max-width: 520px) {
      .center-form { padding: 18px 10px; margin: 40px 8px; }
      h2 { font-size: 18px; }
      .search-row { flex-wrap: wrap; }
      .search-row label { width: 100%; }
      .search-row input[type="text"] { width: 100%; }
      .btn-primary { width: 100%; }
    }

    /* ======= Darkmode tweaks ======= */
    body.darkmode .card-item { background: #fffbe8; border-color: #ffe082; }
    body.darkmode .item-meta { color: #232; }
    body.darkmode .hint { color: #333; }
  </style>
</head>
<body>
  <div class="center-form">
    <!-- Back -->
    <a class="back-btn" href="/{{ area }}" title="Quay l·∫°i menu khu v·ª±c">
        <i class="fa fa-arrow-left"></i> Menu
    </a>

    <!-- Logo + ti√™u ƒë·ªÅ -->
    <img src="/static/logo_vfr.jpg" alt="VFR Logo" style="display:block; margin:30px auto 18px; max-width:190px;"/>
    <h2>M∆∞·ª£n h√†ng ‚Äì {{ area_name }}</h2>

    <!-- T√¨m Code -->
    <div class="search-panel">
      <form method="GET" action="/{{ area }}/borrow" class="search-row">
        <label for="code">üîé Code</label>
        <input type="text" id="code" name="code" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m..." value="{{ request.args.get('code','') }}" required>
        <button type="submit" class="btn-primary"><i class="fa fa-search"></i> T√¨m</button>
      </form>
      {% if thong_bao %}
        <div class="hint" style="color:#c0392b; margin-top:8px;"><b>‚ùå</b> {{ thong_bao }}</div>
      {% endif %}
    </div>

    <!-- Danh s√°ch PART ho·∫∑c 1 item -->
    {% macro part_card(row) %}
      {% set used = (row['S·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng']|float) %}
      {% set maxu = (row['S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa']|float) if row['S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa'] is not none else 0 %}
      {% set ratio = (used / maxu) if maxu>0 else 0 %}
      {% set cls = 'ok' %}
      {% if ratio >= 1 %}{% set cls='fail' %}{% elif ratio >= 0.8 %}{% set cls='warn' %}{% endif %}

      <div class="card-item {{ cls }}">
        <div class="item-head">
          <div>üß© Part code: {{ row['Part code'] }}</div>
          <div>{{ '‚úî' if row['T√¨nh tr·∫°ng']=='Available' and ratio<1 else '‚ùå' }}</div>
        </div>

        <div class="item-meta">
          <b>Mi√™u t·∫£:</b> {{ row['Mi√™u t·∫£'] }}<br>
          <b>V·ªã tr√≠:</b> {{ row['V·ªã tr√≠'] }}<br>
          <b>S·ª≠ d·ª•ng:</b> {{ used }} / {{ maxu }}
          {% if row['T√¨nh tr·∫°ng'] != 'Available' %}<br><b>Ng∆∞·ªùi m∆∞·ª£n:</b> {{ row['Ng∆∞·ªùi m∆∞·ª£n'] }}{% endif %}
          <br><b>Tr·∫°ng th√°i:</b>
          {% if row['T√¨nh tr·∫°ng']=='Available' and ratio<1 %}
            <span class="badge-ok">Kh·∫£ d·ª•ng</span>
          {% elif row['T√¨nh tr·∫°ng'] == 'Kh√¥ng t·ªìn t·∫°i' %}
            <span class="badge-unavailable">Kh√¥ng t·ªìn t·∫°i</span>
          {% else %}
            <span class="badge-unavailable">ƒêang m∆∞·ª£n</span>
          {% endif %}
        </div>

        {% if row['·∫¢nh m∆∞·ª£n'] and row['·∫¢nh m∆∞·ª£n'] is string and row['·∫¢nh m∆∞·ª£n']|length>2 %}
          {% set _img = row['·∫¢nh m∆∞·ª£n'] %}
          {% if 'VFR3/' not in _img and 'static/' not in _img %}
            {% set _img = 'VFR3/borrow/' ~ _img %}
          {% endif %}
          <div class="hint" style="margin-top:8px">
            ·∫¢nh x√°c th·ª±c g·∫ßn nh·∫•t:<br>
            <img src="{{ url_for('static', filename=_img) }}"
                 style="max-width:120px;max-height:92px;border:1px solid var(--main-btn);border-radius:8px;cursor:pointer"
                 onclick="showImagePopup(this.src)">
          </div>
        {% endif %}

        {% if row['T√¨nh tr·∫°ng']=='Available' and ratio<1 %}
          <form method="POST" action="/{{ area }}/muon-xac-nhan" enctype="multipart/form-data" onsubmit="handleBorrowSubmit(event)" style="margin-top:12px">
            <input type="hidden" name="code" value="{{ row['Code'] }}">
            <input type="hidden" name="part_code" value="{{ row['Part code'] }}">
            <input type="file" name="anh_muon" accept="image/*" required>
            <button type="submit" class="btn-primary" style="width:100%">‚úÖ X√°c nh·∫≠n m∆∞·ª£n part</button>
          </form>
        {% endif %}

        {% if ratio>=1 %}
          <div class="status fail">S·∫£n ph·∫©m n√†y ƒë√£ b·ªã h∆∞.</div>
        {% elif ratio>=0.8 %}
          <div class="status warn">N√™n thay khu√¥n m·∫´u.</div>
        {% endif %}
      </div>
    {% endmacro %}

    {% if list_parts %}
      <h3 style="text-align:center; color: var(--main-th); margin: 0 0 10px;">üìã Danh s√°ch c√°c part ‚Äì Ch·ªâ m∆∞·ª£n t·ª´ng part</h3>
      <div class="cards">
        {% set sorted_parts = list_parts | sort(attribute='T√¨nh tr·∫°ng', reverse=True) %}
        {% for row in sorted_parts %}
          {{ part_card(row) }}
        {% endfor %}
      </div>
      <div class="hint" style="margin-top:8px; text-align:center;">* S·∫£n ph·∫©m n√†y c√≥ part. Vui l√≤ng m∆∞·ª£n t·ª´ng part ri√™ng bi·ªát.</div>

    {% elif thong_tin and thong_tin['Part code'] is string and thong_tin['Part code']|length>0 and thong_tin['T√¨nh tr·∫°ng'] %}
      <div class="cards">{{ part_card(thong_tin) }}</div>

    {% elif thong_tin %}
      {% set used = thong_tin['S·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng']|float %}
      {% set maxu = thong_tin['S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa']|float if thong_tin['S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa'] is not none else 0 %}
      {% set ratio = (used/maxu) if maxu>0 else 0 %}
      {% set cls = 'ok' %}
      {% if ratio>=1 %}{% set cls='fail' %}{% elif ratio>=0.8 %}{% set cls='warn' %}{% endif %}

      <div class="cards">
        <div class="card-item {{ cls }}" style="max-width:340px;">
          <div class="item-head">
            <div>üè∑Ô∏è Code: {{ thong_tin['Code'] }}</div>
            <div>{{ '‚úî' if thong_tin['T√¨nh tr·∫°ng']=='Available' and ratio<1 else '‚ùå' }}</div>
          </div>

          <div class="item-meta">
            <b>Mi√™u t·∫£:</b> {{ thong_tin['Mi√™u t·∫£'] }}<br>
            <b>V·ªã tr√≠:</b> {{ thong_tin['V·ªã tr√≠'] }}<br>
            <b>S·ª≠ d·ª•ng:</b> {{ used }} / {{ maxu }}
            {% if thong_tin['T√¨nh tr·∫°ng']!='Available' %}<br><b>Ng∆∞·ªùi m∆∞·ª£n:</b> {{ thong_tin['Ng∆∞·ªùi m∆∞·ª£n'] }}{% endif %}
            <br><b>Tr·∫°ng th√°i:</b>
            {% if thong_tin['T√¨nh tr·∫°ng'] == 'Available' and ratio < 1 %}
              <span class="badge-ok">Kh·∫£ d·ª•ng</span>
            {% elif thong_tin['T√¨nh tr·∫°ng'] == 'Kh√¥ng t·ªìn t·∫°i' %}
              <span class="badge-unavailable">Kh√¥ng t·ªìn t·∫°i</span>
            {% else %}
              <span class="badge-unavailable">ƒêang m∆∞·ª£n</span>
            {% endif %}
          </div>

          {% if thong_tin['·∫¢nh m∆∞·ª£n'] is string and thong_tin['·∫¢nh m∆∞·ª£n']|length>2 %}
            {% set _img2 = thong_tin['·∫¢nh m∆∞·ª£n'] %}
            {% if 'VFR3/' not in _img2 and 'static/' not in _img2 %}
              {% set _img2 = 'VFR3/borrow/' ~ _img2 %}
            {% endif %}
            <div class="hint" style="margin-top:8px">
              ·∫¢nh x√°c th·ª±c g·∫ßn nh·∫•t:<br>
              <img src="{{ url_for('static', filename=_img2) }}"
                   style="max-width:120px;max-height:92px;border:1px solid var(--main-btn);border-radius:8px;cursor:pointer"
                   onclick="showImagePopup(this.src)">
            </div>
          {% endif %}

          {% if thong_tin['T√¨nh tr·∫°ng']=='Available' and ratio<1 %}
            <form method="POST" action="/{{ area }}/muon-xac-nhan" enctype="multipart/form-data" onsubmit="handleBorrowSubmit(event)" style="margin-top:12px">
              <input type="hidden" name="code" value="{{ thong_tin['Code'] }}">
              <input type="hidden" name="part_code" value="{{ thong_tin.get('Part code','') }}">
              <input type="file" name="anh_muon" accept="image/*" required>
              <button type="submit" class="btn-primary" style="width:100%">‚úÖ X√°c nh·∫≠n m∆∞·ª£n</button>
            </form>
          {% endif %}

          {% if ratio>=1 %}
            <div class="status fail">S·∫£n ph·∫©m n√†y ƒë√£ b·ªã h∆∞.</div>
          {% elif ratio>=0.8 %}
            <div class="status warn">N√™n thay khu√¥n m·∫´u.</div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Popup ·∫£nh -->
  <div id="imgPopup" class="popup-mask" onclick="this.style.display='none'">
    <img id="imgPopupImg" style="max-width:92vw;max-height:92vh;border-radius:12px;border:1px solid #ffe082;background:#fff">
  </div>

  <!-- Popup th√†nh c√¥ng -->
  <div id="popup-success" class="popup-mask" role="dialog" aria-modal="true">
    <div class="popup-card">
      <div style="font-size:20px; color:#2e7d32; font-weight:800; margin-bottom:10px">‚úÖ M∆∞·ª£n h√†ng th√†nh c√¥ng!</div>
      <div id="popup-content" class="section" style="display:grid; gap:8px;"></div>
      <div style="margin-top:12px">
        <!-- N√∫t ƒê√≥ng quay v·ªÅ ƒë√∫ng /<area> -->
        <button class="btn-primary" onclick="goBackToMenu()"><i class="fa fa-check"></i> ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- N√∫t dark/light -->
  <button id="theme-btn" title="Chuy·ªÉn Dark/Light mode"><i class="fa fa-moon"></i></button>

  <script>
    // ===== Quay v·ªÅ menu: d√πng th·∫≥ng {{ area }} =====
    function goBackToMenu() {
      location.href = "/{{ area }}";
    }

    // ===== Autofocus =====
    document.addEventListener('DOMContentLoaded', () => {
      const ip = document.getElementById('code');
      if (ip && !ip.value) ip.focus();
    });

    // ===== ·∫¢nh popup =====
    function showImagePopup(src){
      document.getElementById('imgPopupImg').src = src;
      document.getElementById('imgPopup').style.display='flex';
    }

    // ===== Darkmode: ƒë·ªìng b·ªô nh∆∞ Home (localStorage key: vfr-darkmode) =====
    function applyDarkMode(dark) {
      document.body.classList.toggle('darkmode', dark);
      const themeBtn = document.getElementById('theme-btn');
      if (themeBtn) themeBtn.innerHTML = dark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
      try { localStorage.setItem('vfr-darkmode', dark ? '1' : '0'); } catch(e) {}
    }
    (function initDark() {
      let dark = false;
      try {
        const saved = localStorage.getItem('vfr-darkmode');
        if (saved !== null) dark = saved === '1';
      } catch(e) {}
      applyDarkMode(dark);
      const btn = document.getElementById('theme-btn');
      if (btn) btn.onclick = function(){ dark = !dark; applyDarkMode(dark); };
    })();

    // ===== Submit m∆∞·ª£n =====
    function handleBorrowSubmit(e){
      e.preventDefault();
      const form = e.target;
      const btn  = form.querySelector('button[type="submit"]');
      const txt  = btn.innerHTML;
      btn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...'; btn.disabled = true;

      fetch(form.action, { method:'POST', body:new FormData(form), redirect:'follow' })
        .then(async (r) => {
            btn.innerHTML = txt; btn.disabled = false;

            if (!r.ok) {
            // Tr·∫£ l·ªói HTTP th·ª±c s·ª±
            const msg = await r.text().catch(()=> '');
            alert(msg || 'C√≥ l·ªói x·∫£y ra!'); 
            return;
            }

            // Th·ª≠ ph√°t hi·ªán JSON
            const ct = (r.headers.get('content-type') || '').toLowerCase();

            if (ct.includes('application/json')) {
            const data = await r.json().catch(() => null);
            if (!data || !data.success) {
                alert((data && data.msg) || 'C√≥ l·ªói x·∫£y ra!'); 
                return;
            }

            // === Nh·∫£y nh∆∞ c≈©: hi·ªán popup th√†nh c√¥ng ===
            const content = document.getElementById('popup-content');
            content.innerHTML = `
                <div style="text-align:left">
                <b>Code:</b> ${data.code||''}<br>
                ${data.part_code?`<b>Part code:</b> ${data.part_code}<br>`:''}
                ${data.mieu_ta?`<b>Mi√™u t·∫£:</b> ${data.mieu_ta}<br>`:''}
                <b>V·ªã tr√≠:</b> ${data.vi_tri||''}
                </div>
                <div class="hint" style="margin-top:8px">
                ·∫¢nh m∆∞·ª£n:<br>
                <img src="/static/VFR3/borrow/${data.img}"
                    style="max-width:200px;max-height:150px;border:1px solid #ffe082;border-radius:8px">
                </div>`;
            document.getElementById('popup-success').style.display='flex';

            // Quay v·ªÅ trang vfr3_area
            setTimeout(goBackToMenu, 1800);
            } else {
            // Server tr·∫£ HTML/redirect: coi nh∆∞ th√†nh c√¥ng v√† quay v·ªÅ menu
            goBackToMenu();
            }
        })
        .catch(err => {
            btn.innerHTML = txt; btn.disabled = false;
            console.error(err);
            alert('C√≥ l·ªói khi m∆∞·ª£n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!');
      });
    }
  </script>
</body>
</html>
