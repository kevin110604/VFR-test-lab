<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Danh s√°ch m·∫´u ƒë√£ l∆∞u</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
  :root{
    --bg:#fffdfc; --card:#ffffffcc; --text:#222;
    --accent:#c49c48; --accent-hover:#35523A; --accent-text:#fff;
    --border:#e1d7b8; --row-even:#f7f2e0; --row-hover:#fffbe2;
    --warn:#fff4c4; --danger:#ffe3e3;
  }
  body.darkmode{
    --bg:#222e2e; --card:#2d3b3b; --text:#f2f2ee;
    --accent:#b9933a; --accent-hover:#476a55; --accent-text:#fff;
    --border:#44524c; --row-even:#34403d; --row-hover:#3c4b48;
    --warn:#665c2a; --danger:#6a2f2f;
  }

  body{
    font-family:'Segoe UI',Arial,Helvetica,sans-serif;
    background:var(--bg); color:var(--text); margin:0; transition:.3s;
  }
  .container{max-width:980px;margin:24px auto;padding:0 10px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 4px 24px #0002;padding:22px 14px 26px}
  h2{margin:4px 0 16px;text-align:center;color:var(--accent-hover)}

  /* ===== Toolbar (1 h√†ng c·∫£ mobile) ===== */
  .toolbar{
    display:flex; align-items:center; gap:8px; margin-bottom:14px;
    flex-wrap:nowrap; justify-content:center;
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:6px;
    border:none; border-radius:8px; padding:8px 12px;
    background:var(--accent); color:var(--accent-text);
    font-weight:600; text-decoration:none; cursor:pointer; transition:.2s;
    flex-shrink:0;
  }
  .btn:hover{background:var(--accent-hover); color:var(--accent-text)}
  .btn-home{
    width:38px; height:38px; padding:0; border-radius:50%; font-size:16px;
    box-shadow:0 2px 5px #0002;
  }
  .search{
    flex:1; min-width:0; display:flex; align-items:center; gap:6px;
  }
  .search input{
    flex:1; min-width:0;
    padding:8px 10px; border:1.4px solid var(--accent); border-radius:8px;
    background:#fffbe8; color:#333;
  }
  .btn-search{white-space:nowrap; padding:8px 12px}

  /* ===== Box header ===== */
  .groups{margin-top:8px}
  .box-header{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    background:#e8d7a1; border:1px solid var(--accent);
    border-radius:10px; padding:10px 12px; margin-top:10px;
  }
  body.darkmode .box-header{background:#5b4e29; border-color:#b58f3a}
  .box-title{font-weight:800}
  .chev{transition:transform .18s}
  .collapsed .chev{transform:rotate(-90deg)}
  .tag{
    display:inline-block; padding:3px 9px; border:1px solid var(--accent);
    border-radius:999px; background:#fffbe8; font-weight:700;
  }
  body.darkmode .tag{background:var(--accent); color:#222}
  .right{margin-left:auto; display:flex; gap:8px; align-items:center}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:3px 8px; border-radius:999px; font-weight:700; font-size:12.5px;
    border:1px solid #0000; background:#0000; color:#000;
  }
  .badge-total{border-color:#9b7a2a; background:#f3e3ad; color:#3b2b05}
  .badge-warn{border-color:#d7b23b; background:#fff0b6; color:#6a5709}
  .badge-danger{border-color:#e08787; background:#ffd2d2; color:#6a2020}

  /* ===== Table (cu·ªôn ngang mobile) ===== */
  .table-wrapper{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:10px}
  table{min-width:680px; width:100%; border-collapse:collapse; margin-top:6px}
  th,td{padding:9px 10px; text-align:center; white-space:nowrap}
  th{background:var(--accent); color:#fff; font-weight:600; position:sticky; top:0}
  tr:nth-child(even){background:var(--row-even)}
  tr:hover{background:var(--row-hover)}
  .status-warn{background:var(--warn)!important}
  .status-danger{background:var(--danger)!important}

  /* Actions */
  .actions{display:flex; gap:6px; justify-content:center}
  .btn-info{background:#35523A} .btn-edit{background:#33A9DD} .btn-del{background:#d04d3d}
  .btn-info:hover,.btn-edit:hover,.btn-del:hover{filter:brightness(1.1)}

  /* Darkmode toggle */
  #theme-btn{
    position:fixed; right:18px; bottom:18px; width:42px; height:42px;
    border:none; border-radius:50%; background:var(--accent-hover); color:#fff;
    cursor:pointer; box-shadow:0 2px 8px #0003;
  }

  .no-data{padding:14px; text-align:center; opacity:.8}

  /* Mobile tweak */
  @media (max-width:720px){
    .btn-home{width:36px; height:36px; font-size:15px}
    .search input{font-size:15px; padding:7px 10px}
    .btn-search{font-size:15px; padding:7px 10px}
    table,th,td{font-size:14px}
    .box-header{font-size:15px}
  }
  .btn-delbox{
    background:#d04d3d;
    padding:6px 9px;
    font-size:14px;
    border-radius:8px;
  }
  .btn-delbox:hover{filter:brightness(1.15);}
    /* --- NEW: popup darkmode --- */
  .batch-backdrop{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    z-index:11000;
  }
  body.darkmode .batch-backdrop{
    background:rgba(0,0,0,0.7);
  }
  .batch-card{
    background:var(--card);
    color:var(--text);
    padding:18px 22px 20px;
    border-radius:18px;
    box-shadow:0 8px 30px var(--shadow-med);
    max-width:900px;
    width:min(95vw,960px);
    max-height:80vh;
    overflow:auto;
    animation:fadeInScale .25s ease-out;
  }
  @keyframes fadeInScale{
    from{opacity:0; transform:scale(.96) translateY(6px);}
    to{opacity:1; transform:scale(1) translateY(0);}
  }

  /* --- NEW: hi·ªáu ·ª©ng highlight khi k√©o ƒë·ªÉ d√°n --- */
  .fill-highlight td{
    background:#fff7c2 !important;
    transition:background .35s;
  }
  body.darkmode .fill-highlight td{
    background:#5b4a1fc2 !important;
  }
  </style>
</head>
<body>
  <button id="theme-btn" title="Dark/Light"><i class="fa fa-moon"></i></button>

  <div class="container">
    <div class="card">
      <h2>Danh s√°ch m·∫´u ƒë√£ l∆∞u</h2>

      <!-- Toolbar: Home b√™n tr√°i + Search + T√¨m c√πng 1 h√†ng -->
      <div class="toolbar">
        <a class="btn btn-home" href="/" title="Trang ch·ªß"><i class="fa fa-home"></i></a>
        <div class="search">
          <i class="fa fa-search"></i>
          <input id="q" type="text" placeholder="T√¨m sample">
          <button class="btn btn-search" id="btnSearch"><i class="fa fa-filter"></i> T√¨m</button>
        </div>

        <!-- ‚úÖ NEW: N√∫t xu·∫•t Excel -->
        <button class="btn" id="btnExport"><i class="fa fa-file-excel"></i> Xu·∫•t Excel</button>
        <button class="btn" id="btnBatchAdd">
            <i class="fa fa-plus"></i> Add more
        </button>
      </div>

      <div id="groups" class="groups"></div>
      <div id="empty" class="no-data" style="display:none;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>
    </div>
  </div>
  <!-- ================= POPUP BATCH TABLE ================= -->
  <div id="batchPopup" class="batch-backdrop" style="display:none;">
    <div class="batch-card">
      <h3 style="margin-top:0; margin-bottom:10px;">Th√™m m·∫´u</h3>

      <div class="batch-toolbar" style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input id="batchRowCount" type="number" min="1" value="1"
                style="width:70px; padding:6px 8px; border:1px solid var(--accent); border-radius:6px;">

        <button type="button" class="btn" onclick="addRowsDynamic()">
          Th√™m d√≤ng
        </button>

        <!-- NEW: n√∫t import Excel -->
        <label class="btn" style="cursor:pointer; display:inline-flex; align-items:center; gap:6px;">
          <i class="fa fa-file-excel"></i> Import t·ª´ Excel
          <input id="excelUpload" type="file" accept=".xlsx,.xls"
                style="display:none" onchange="importFromExcel(this)">
        </label>
      </div>

      <div class="table-wrapper" style="max-height:55vh; overflow:auto; border-radius:12px; border:1px solid var(--border); background:var(--card);">
        <table id="batchTable">
          <thead>
            <tr>
              <th>Report</th>
              <th>Lo·∫°i m·∫´u</th>
              <th>Box</th>
              <th>Ng√†y l∆∞u</th>
              <th>Ng√†y hu·ª∑</th>
              <th>Ghi ch√∫</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- c√°c d√≤ng s·∫Ω ƒë∆∞·ª£c add b·∫±ng JS -->
          </tbody>
        </table>
      </div>

      <div style="text-align:right; margin-top:14px;">
        <button class="btn" type="button" onclick="closeBatch()">H·ªßy</button>
        <button class="btn" type="button" onclick="submitBatchTable()">L∆∞u t·∫•t c·∫£</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Darkmode =====
  function setDark(d){
    document.body.classList.toggle('darkmode', d);
    localStorage.setItem('vfr-darkmode', d ? '1':'0');
    document.getElementById('theme-btn').innerHTML = d ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
  }
  setDark(localStorage.getItem('vfr-darkmode')==='1');
  document.getElementById('theme-btn').onclick=()=>setDark(!document.body.classList.contains('darkmode'));

  // ===== Data t·ª´ server =====
  const DATA = {{ samples_json | safe }};

  // ===== Utils =====
  const $ = s=>document.querySelector(s);
  const normReport = s => (s||'').toString().replace(/[^0-9]/g,'');
  function daysLeft(iso){
    if(!iso) return null;
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(iso + 'T00:00:00');
    return Math.ceil((d - today)/(1000*60*60*24));
  }

  // --- NEW: parse box code d·∫°ng B1-S1 -> {b:1, s:1} ---
  function parseBoxCode(code){
    if(!code) return {b: 9999, s: 9999};
    const m = String(code).match(/^B(\d+)-S(\d+)$/i);
    if(!m) return {b: 9999, s: 9999};
    return {b: parseInt(m[1], 10) || 0, s: parseInt(m[2], 10) || 0};
  }

  // --- NEW: s·∫Øp x·∫øp box theo S tr∆∞·ªõc, r·ªìi t·ªõi B ---
  function sortBoxCodes(a, b){
    if(a === 'NO-BOX') return 1;
    if(b === 'NO-BOX') return -1;

    const A = parseBoxCode(a);
    const B = parseBoxCode(b);

    if(A.s !== B.s) return A.s - B.s;
    if(A.b !== B.b) return A.b - B.b;
    return String(a).localeCompare(String(b));
  }

  // Group by box (ƒë√£ ch·ªânh: d√πng sortBoxCodes)
  function groupByBox(items){
    const g = {};
    items.forEach(it=>{
      const key = it.box_code || 'NO-BOX';
      (g[key] ||= []).push(it);
    });
    return Object.keys(g)
      .sort(sortBoxCodes)
      .map(k=>({box:k, items:g[k]}));
  }

  // ƒê·∫øm m·∫´u h·∫øt h·∫°n / s·∫Øp h·∫øt h·∫°n trong 1 nh√≥m
  function countStatus(items){
    let expired=0, soon=0;
    items.forEach(it=>{
      const left = daysLeft(it.discard_date);
      if(left !== null){
        if(left < 0) expired++;
        else if(left <= 7) soon++;
      }
    });
    return {expired, soon};
  }

  function render(items){
    const root = $('#groups');
    root.innerHTML='';
    const groups = groupByBox(items);
    $('#empty').style.display = groups.length ? 'none' : 'block';

    groups.forEach(({box, items})=>{
      const {expired, soon} = countStatus(items);

      const header = document.createElement('div');
      header.className='box-header collapsed';
      header.innerHTML = `
        <i class="fa fa-chevron-down chev"></i>
        <div class="box-title">Box <span class="tag">${box}</span></div>
        <div class="right">
          <span class="badge badge-total"><i class="fa fa-box-archive"></i> ${items.length} m·∫´u</span>
          <span class="badge badge-danger"><i class="fa fa-triangle-exclamation"></i> ${expired}</span>
          <span class="badge badge-warn"><i class="fa fa-hourglass-end"></i> ${soon}</span>
          <!-- ‚úÖ NEW: n√∫t x√≥a box -->
          <button class="btn btn-delbox" data-box="${box}" title="X√≥a c√°c m·∫´u h·∫øt h·∫°n trong box">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      `;

      const wrap = document.createElement('div');
      wrap.className='table-wrapper';
      wrap.style.display='none';

      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr>
          <th>Report</th>
          <th>Item</th>
          <th>Lo·∫°i m·∫´u</th>
          <th>Ng√†y h·ªßy</th>
          <th>C√≤n l·∫°i</th>
          <th>Thao t√°c</th>
        </tr></thead>
        <tbody></tbody>
      `;
      const tb = table.querySelector('tbody');

      items
        .sort((a,b)=>(a.report||'').localeCompare(b.report||''))
        .forEach(it=>{
          const tr = document.createElement('tr');
          const left = daysLeft(it.discard_date);
          if(left !== null){
            if(left < 0) tr.classList.add('status-danger');
            else if(left <= 7) tr.classList.add('status-warn');
          }
          tr.innerHTML = `
            <td>${it.report || ''}</td>
            <td>${it.item_code || ''}</td>
            <td>${it.sample_type || ''}</td>
            <td>${it.discard_date || ''}</td>
            <td>${left===null?'--':(left>=0? left+' ng√†y':'H·∫æT '+Math.abs(left)+' ng√†y')}</td>
            <td class="actions">
              <a class="btn btn-info" href="/report/${encodeURIComponent(it.report)}/sample/info/${encodeURIComponent(it.box_code)}" title="Th√¥ng tin"><i class="fa fa-circle-info"></i></a>
              <a class="btn btn-edit" href="/report/${encodeURIComponent(it.report)}/sample/edit/${encodeURIComponent(it.box_code)}" title="Ch·ªânh s·ª≠a"><i class="fa fa-pen"></i></a>
              <button class="btn btn-del" data-box="${it.box_code}" data-report="${it.report}" title="X√≥a"><i class="fa fa-trash"></i></button>
            </td>
          `;
          tb.appendChild(tr);
        });

      wrap.appendChild(table);

      // Toggle group
      header.addEventListener('click', ()=>{
        const open = wrap.style.display === 'block';
        wrap.style.display = open ? 'none' : 'block';
        header.classList.toggle('collapsed', open);
      });

      root.appendChild(header);
      root.appendChild(wrap);
    });

    // X√≥a ƒë√∫ng m·∫´u
    root.querySelectorAll('.btn-del').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const box = btn.dataset.box;
        const rep = btn.dataset.report;
        if(!confirm(`X√≥a m·∫´u ${rep} trong box ${box}?`)) return;
        try{
          const res = await fetch(`/samples?box_code=${encodeURIComponent(box)}&report=${encodeURIComponent(rep)}`, {method:'DELETE'});
          if(!res.ok) throw new Error('DELETE /samples failed');
          allData = allData.filter(x=> !(x.box_code===box && x.report===rep));
          render(allData);
        }catch(err){
          console.error(err);
          alert('Kh√¥ng th·ªÉ x√≥a m·∫´u.');
        }
      });
    });
    // ===== X√ìA BOX (ch·ªâ c√°c m·∫´u h·∫øt h·∫°n) =====
    root.querySelectorAll('.btn-delbox').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const box = btn.dataset.box;
        const today = new Date(); today.setHours(0,0,0,0);
        const toDelete = allData.filter(it=>{
          return it.box_code === box && it.discard_date && new Date(it.discard_date) < today;
        });
        if(toDelete.length === 0){
          alert(`Box ${box} kh√¥ng c√≥ m·∫´u h·∫øt h·∫°n.`);
          return;
        }
        if(!confirm(`X√≥a ${toDelete.length} m·∫´u ƒë√£ h·∫øt h·∫°n trong box ${box}?`)) return;
        try{
          for(const it of toDelete){
            const res = await fetch(`/samples?box_code=${encodeURIComponent(box)}&report=${encodeURIComponent(it.report)}`, {method:'DELETE'});
            if(!res.ok) console.warn(`Kh√¥ng th·ªÉ x√≥a ${it.report}`);
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu trong giao di·ªán
            allData = allData.filter(x=> !(x.box_code===box && x.report===it.report));
          }
          render(allData);
          alert(`ƒê√£ x√≥a ${toDelete.length} m·∫´u h·∫øt h·∫°n trong box ${box}.`);
        }catch(err){
          console.error(err);
          alert('L·ªói khi x√≥a box.');
        }
      });
    });
  }

  // Boot
  let allData = Array.isArray(DATA) ? DATA : [];
  render(allData);

  // Chu·∫©n b·ªã popup batch
  enableAutoFill();
  loadBoxes();

  // T√¨m nhanh theo report (nh·∫≠p 25-4212 ho·∫∑c 4212 ƒë·ªÅu ƒë∆∞·ª£c)
  function doSearch(){
    const q = $('#q').value.trim();
    if(!q){
        render(allData);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
    }
    const nq = normReport(q);
    const filtered = allData.filter(it => normReport(it.report||'').includes(nq));
    render(filtered);

    // === M·ªü box ch·ª©a m·∫´u tr√πng ===
    setTimeout(()=>{
        document.querySelectorAll('.box-header + .table-wrapper').forEach((wrap)=>{
        const hasMatch = wrap.querySelector('td:first-child')?.textContent?.replace(/\D/g,'').includes(nq);
        if(hasMatch){
            wrap.style.display = 'block';
            wrap.previousElementSibling.classList.remove('collapsed');
            // Cu·ªôn ƒë·∫øn box n√†y
            wrap.previousElementSibling.scrollIntoView({ behavior:'smooth', block:'center' });
            // Highlight t·∫°m th·ªùi m·∫´u tr√πng
            wrap.querySelectorAll('tr').forEach(tr=>{
            if((tr.children[0].textContent||'').replace(/\D/g,'').includes(nq)){
                tr.style.transition='background 0.3s';
                tr.style.background='#fff19c';
                setTimeout(()=>{ tr.style.background=''; },3000);
            }
            });
        }
        });
    }, 50);
    }

    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('q').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); doSearch(); }
    });
  document.getElementById('btnExport').addEventListener('click', ()=>{
    fetch('/export_expired_samples', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(allData)   // g·ª≠i to√†n b·ªô d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã
    })
    .then(res => {
      if(!res.ok) throw new Error('T·∫£i th·∫•t b·∫°i');
      return res.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'expired_samples.xlsx';
      document.body.appendChild(a);z
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err=>{
      console.error(err);
      alert('Xu·∫•t file Excel th·∫•t b·∫°i.');
    });
  });
    // --- NEW: danh s√°ch box t·ª´ server ---
  let BOX_OPTIONS = [];

  function fillBoxSelect(select, selectedValue){
    if(!select) return;
    select.innerHTML = '<option value="">-- Ch·ªçn box --</option>';
    const sorted = BOX_OPTIONS.slice().sort(sortBoxCodes);
    sorted.forEach(code=>{
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = code;
      if(selectedValue && selectedValue === code){
        opt.selected = true;
      }
      select.appendChild(opt);
    });
  }

  async function loadBoxes(){
    try{
      const res = await fetch('/boxes');
      const data = await res.json();
      BOX_OPTIONS = Array.isArray(data.boxes) ? data.boxes : [];
      document.querySelectorAll('select.cell-box').forEach(sel=>{
        fillBoxSelect(sel, sel.value || null);
      });
    }catch(err){
      console.error('Kh√¥ng load ƒë∆∞·ª£c list box:', err);
      BOX_OPTIONS = [];
    }
  }

  // --- NEW: t·∫°o 1 d√≤ng batch v·ªõi gi√° tr·ªã initial ---
  function createBatchRow(initial={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="cell-report" value="${initial.report || ''}"></td>
      <td>
        <select class="cell-type">
          <option value="">--Ch·ªçn--</option>
          <option value="Line Test" ${initial.sample_type === "Line Test" ? "selected" : ""}>Line Test</option>
          <option value="QA Test" ${initial.sample_type === "QA Test" ? "selected" : ""}>QA Test</option>
        </select>
      </td>
      <td>
        <select class="cell-box"></select>
      </td>
      <td><input type="date" class="cell-save" value="${initial.save_date || ''}"></td>
      <td><input type="date" class="cell-discard" value="${initial.discard_date || ''}"></td>
      <td><input class="cell-note" value="${initial.note || ''}"></td>
      <td><button type="button" onclick="this.parentElement.parentElement.remove()">üóë</button></td>
    `;
    // fill box options cho select trong d√≤ng n√†y
    const sel = tr.querySelector('select.cell-box');
    fillBoxSelect(sel, initial.box_code || '');
    return tr;
  }

  // --- NEW: th√™m n d√≤ng ---
  function addBatchRow(n=1){
    const tbody = document.querySelector("#batchTable tbody");
    for(let i=0;i<n;i++){
      const tr = createBatchRow();
      tbody.appendChild(tr);
    }
    enableAutoFill();
  }
  // --- NEW: th√™m s·ªë d√≤ng theo gi√° tr·ªã ng∆∞·ªùi d√πng nh·∫≠p ---
  function addRowsDynamic(){
    const inp = document.getElementById("batchRowCount");
    let n = parseInt(inp.value);

    if(isNaN(n) || n <= 0){
      alert("Vui l√≤ng nh·∫≠p s·ªë d√≤ng h·ª£p l·ªá!");
      return;
    }

    addBatchRow(n);
  }
    // --- NEW: h√†m t√≠nh ng√†y hu·ª∑ t·ª´ ng√†y l∆∞u (+3 th√°ng) ---
  function calcDiscardDate(saveStr){
    if(!saveStr) return '';
    const d = new Date(saveStr + "T00:00:00");
    if(isNaN(+d)) return '';
    const exp = new Date(d);
    exp.setMonth(exp.getMonth() + 3);
    return exp.toISOString().split("T")[0];
  }

  // Auto discard-date khi g√µ ng√†y l∆∞u
  document.addEventListener("input", e => {
    if (e.target.classList.contains("cell-save")) {
      const disc = calcDiscardDate(e.target.value);
      if(disc){
        const row = e.target.closest('tr');
        const discardInput = row && row.querySelector(".cell-discard");
        if(discardInput) discardInput.value = disc;
      }
    }
  });

  // Excel-like autofill (khi k√©o s·∫Ω highlight v√† auto ng√†y hu·ª∑ n·∫øu k√©o c·ªôt ng√†y l∆∞u)
  function enableAutoFill() {
    const tbody = document.querySelector("#batchTable tbody");
    if(!tbody) return;
    let startCell = null;

    tbody.querySelectorAll("input,select").forEach(cell => {
      cell.onmousedown = () => { startCell = cell; };

      cell.onmouseup = e => {
        if (!startCell || startCell === cell) {
          startCell = null;
          return;
        }

        const startRowEl = startCell.closest('tr');
        const endRowEl   = cell.closest('tr');
        if(!startRowEl || !endRowEl) { startCell = null; return; }

        const rows = Array.from(tbody.querySelectorAll("tr"));
        const startRow = rows.indexOf(startRowEl);
        const endRow   = rows.indexOf(endRowEl);
        if(startRow === -1 || endRow === -1){ startCell = null; return; }

        const col = Array.from(startRowEl.children).indexOf(startCell.parentElement);
        const min = Math.min(startRow, endRow);
        const max = Math.max(startRow, endRow);
        const isSaveCol = startCell.classList.contains('cell-save');

        for (let r = min; r <= max; r++) {
          const rowEl = rows[r];
          const targetCell = rowEl.children[col].querySelector("input,select");
          if(!targetCell) continue;
          targetCell.value = startCell.value;

          // highlight d√≤ng ƒë∆∞·ª£c fill
          rowEl.classList.add('fill-highlight');
          setTimeout(()=> rowEl.classList.remove('fill-highlight'), 600);

          // n·∫øu ƒëang k√©o c·ªôt "ng√†y l∆∞u" -> t·ª± nh·∫£y ng√†y hu·ª∑
          if(isSaveCol){
            const discardInput = rowEl.querySelector('.cell-discard');
            if(discardInput){
              discardInput.value = calcDiscardDate(targetCell.value) || '';
            }
          }
        }

        startCell = null;
      };
    });
  }
    // --- NEW: Import report t·ª´ Excel ---
  async function importFromExcel(input){
    const file = input.files && input.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append('file', file);

    try{
      const res = await fetch('/samples/import_excel_reports', {
        method:'POST',
        body: formData
      });
      const data = await res.json();

      if(!res.ok){
        alert(data.error || 'L·ªói ƒë·ªçc file Excel');
        return;
      }

      const reports = Array.isArray(data.reports) ? data.reports : [];
      if(!reports.length){
        alert('Kh√¥ng t√¨m th·∫•y c·ªôt report trong file Excel.');
        return;
      }

      const tbody = document.querySelector("#batchTable tbody");
      tbody.innerHTML = '';

      reports.forEach(raw => {
        let rep = String(raw).trim();

        // N·∫øu ch·ªâ l√† s·ªë, v√≠ d·ª• "5555" ‚Üí t·ª± th√™m 25-
        if (/^\d+$/.test(rep)) {
          rep = `25-${rep}`;
        }

        // N·∫øu Excel c√≥ d·∫°ng "25 5555" ho·∫∑c "25_5555" ‚Üí chu·∫©n h√≥a v·ªÅ 25-5555
        rep = rep.replace(/[^0-9]/g, match => (match === '-' ? '-' : ''));

        // N·∫øu sau x·ª≠ l√Ω m√† kh√¥ng c√≥ '-', th√™m 25-
        if (!rep.includes('-')) {
          const digits = rep.replace(/\D/g, '');
          rep = `25-${digits}`;
        }

        const tr = createBatchRow({ report: rep });
        tbody.appendChild(tr);
      });

      enableAutoFill();
    }catch(err){
      console.error(err);
      alert('L·ªói khi import Excel.');
    }finally{
      // reset input ƒë·ªÉ l·∫ßn sau ch·ªçn l·∫°i ƒë∆∞·ª£c c√πng 1 file
      input.value = '';
    }
  }
  // ================= POPUP BATCH TABLE =================

  // M·ªü popup
  function openBatch() {
    const popup = document.getElementById("batchPopup");
    if (!popup) return;

    popup.style.display = "flex";

    // N·∫øu ch∆∞a c√≥ d√≤ng n√†o trong b·∫£ng -> t·ª± add 1 d√≤ng
    const tbody = document.querySelector("#batchTable tbody");
    if (tbody && !tbody.querySelector("tr")) {
      // H√ÄM N√ÄY ƒê√É C√ì S·∫¥N ·ªû FILE M·ªöI: addBatchRow(count)
      addBatchRow(1);
    }
  }

  // ƒê√≥ng popup
  function closeBatch() {
    const popup = document.getElementById("batchPopup");
    if (popup) {
      popup.style.display = "none";
    }
  }

  // G·∫Øn n√∫t "Add more" ·ªü list sample
  const btnBatchAdd = document.getElementById("btnBatchAdd");
  if (btnBatchAdd) {
    btnBatchAdd.addEventListener("click", (e) => {
      e.preventDefault();
      openBatch();
    });
  }

  // Click ra n·ªÅn t·ªëi b√™n ngo√†i c≈©ng ƒë√≥ng popup
  const batchBackdrop = document.getElementById("batchPopup");
  if (batchBackdrop) {
    batchBackdrop.addEventListener("click", (e) => {
      if (e.target === batchBackdrop) {
        closeBatch();
      }
    });
  }

  // Esc ƒë·ªÉ ƒë√≥ng nhanh
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeBatch();
    }
  });
  </script>
</body>
</html>