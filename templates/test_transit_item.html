<!DOCTYPE html>
<html>
<head>
    <title>{{ name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
    :root {
        --color-bg: #F5F1E6;
        --color-box: #FFF8E7;
        --color-green: #35523A;
        --color-bronze: #8B6B1E;
        --color-accent: #C49C48;
        --color-brown: #6B4F1A;
        --color-text-dark: #25312b;
        --color-text-light: #F9F7F0;
        --shadow-light: rgba(0,0,0,0.10);
        --shadow-dark: rgba(255,255,255,0.15);
    }
    html, body {
        min-height: 100vh;
        background: url('/static/bg_grass.png') repeat;
        background-size: 420px 420px;
        color: var(--color-text-dark);
        font-family: 'Open Sans', Arial, sans-serif;
        margin:0;padding:0;
        transition: background 0.27s, color 0.21s;
    }
    body.dark, .dark {
        color: var(--color-text-light) !important;
        transition: background 0.27s, color 0.21s;
    }
    body.dark .box {
        background: #344833e8 !important;
        color: var(--color-text-light) !important;
        box-shadow: 0 4px 32px var(--shadow-dark);
    }
    body.dark h2, body.dark .cmt-label, body.dark .section b {
        color: var(--color-accent) !important;
    }
    body.dark .img-thumb, body.dark .sample-img {
        border-color: var(--color-accent) !important;
        background: #222 !important;
    }
    body.dark .back-btn, body.dark .gold-upload-btn, body.dark .del-btn, body.dark .del-img-btn {
        background: var(--color-brown) !important;
        color: #fff !important;
        box-shadow: 0 2px 10px var(--shadow-dark);
    }
    #theme-btn {
      position: fixed; right: 24px; bottom: 26px; z-index: 11001;
      background: var(--color-bronze); color: #fff;
      border-radius: 100px; font-size: 17px;
      padding: 6px 11px; border:none; box-shadow: 0 2px 10px var(--shadow-light);
      cursor:pointer; height: 38px; width: 38px; min-width:36px;
      display:flex;align-items:center;justify-content:center;opacity:0.96;
      transition: background 0.16s, color 0.16s;
      font-family: 'Inter', sans-serif;
    }
    #theme-btn:hover { background: var(--color-accent); color: #fff; opacity:1; }
    .box {
        background: #fffdfccf;
        max-width: 540px;
        margin: 32px auto 34px auto;
        border-radius: 18px;
        box-shadow: 0 4px 30px var(--shadow-light);
        padding: 34px 20px 32px 20px;
        animation: fadeGrow 0.7s;
        position:relative;
        font-family: 'Open Sans', Arial, sans-serif;
        color: var(--color-text-dark);
    }
    @keyframes fadeGrow {
        0% { opacity: 0; transform: scale(0.98);}
        100% { opacity: 1; transform: scale(1);}
    }
    .back-btn-container {
        text-align: left;
        margin-bottom: 8px;
    }
    .back-btn {
        background: var(--color-bronze);
        color: #fff !important;
        font-size: 15px;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 7px 18px;
        box-shadow: 0 2px 10px var(--shadow-light);
        cursor: pointer;
        display: inline-block;
        transition: background 0.18s, color 0.15s;
        text-decoration: none !important;
    }
    .back-btn:hover {
        background: var(--color-accent);
        color: #fff !important;
    }
    h2 {
        color: var(--color-green);
        margin-bottom: 12px;
        text-align:center;
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 1.1px;
        margin-top: 0;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }
    .section { margin-bottom:28px; text-align:center;}
    .section b { color: var(--color-bronze); font-size:18px; font-weight:700; letter-spacing: 0.06em;}
    .sample-img {
        border-radius: 13px;
        border: 3px solid var(--color-green);
        max-width: 340px; max-height: 200px;
        min-width: 120px;
        object-fit: contain;
        background: #fff;
        box-shadow: 0 8px 24px var(--shadow-light);
        transition: box-shadow 0.16s, transform 0.12s, background 0.23s, border-color 0.23s;
        cursor: zoom-in;
    }
    .sample-img:hover {box-shadow: 0 12px 38px var(--color-accent);transform: scale(1.08) rotate(-1.5deg);}
    .img-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 18px;
        justify-items: center;
        align-items: center;
        margin-bottom: 22px;
        margin-top: 6px;
    }
    .img-thumb-wrap {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 140px;
        height: 140px;
    }
    .img-thumb {
        max-width:130px; max-height:130px;
        border-radius:11px;
        border:2px solid var(--color-green);
        box-shadow:0 4px 18px var(--shadow-light);
        cursor:zoom-in;
        background: #fff;
        transition: box-shadow 0.15s, transform 0.12s, background 0.21s, border-color 0.21s;
        display: block;
        margin: 0 auto;
    }
    .img-thumb:hover {box-shadow:0 8px 26px var(--color-accent);filter:brightness(1.08) contrast(1.09);transform: scale(1.1);}
    .gold-upload-btn {
        background: var(--color-accent);
        color: #fff;
        font-size: 17px;
        padding: 10px 32px;
        border-radius: 9px;
        font-weight: bold;
        border: none;
        margin: 10px auto 0 auto;
        box-shadow: 0 2px 10px var(--shadow-light);
        display: inline-block;
        text-align:center;
        cursor:pointer;
        min-width:135px;
        position: relative;
        overflow: hidden;
    }
    .gold-upload-btn:hover {background: var(--color-bronze);}
    .gold-upload-btn.btn-mini {
        min-width: 0 !important;
        padding: 5px 12px !important;
        font-size: 13px !important;
        height: 32px !important;
        line-height: 17px !important;
        margin-top: 0 !important;
    }
    .del-img-btn, .del-btn {
        position: absolute;
        top: 6px; 
        left: 8px;
        background: #e74c3c;
        color: #fff;
        border: 2px solid #fff;
        border-radius: 100px;
        width: 28px; height: 28px;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px #2223;
        opacity: 0.92;
        z-index: 2;
        transition: background 0.15s, color 0.15s, transform 0.13s, box-shadow 0.13s;
        outline: none;
        cursor: pointer;
        padding: 0;
    }
    .del-img-btn:hover, .del-btn:hover {
        background: #c0392b;
        color: #fff;
        border-color: #ffd9d9;
        opacity: 1;
        transform: scale(1.13) rotate(-10deg);
        box-shadow: 0 4px 20px #e74c3c33;
    }
    .del-img-btn i, .del-btn i {
        font-size: 15px;
        pointer-events: none;
    }
    .comment-block {text-align:center;margin:18px 0 7px 0;}
    .cmt-label {font-size:17px;color:var(--color-bronze);}
    .main-btn.save-cmt {
        margin-top:7px;
        background:#35523A;
        color:white;
        font-size:15px;
        border-radius:7px;
        padding:8px 20px;
        font-weight:600;
        border:none;
        transition:background 0.17s;
    }
    .main-btn.save-cmt:hover {
        background: var(--color-accent);
        color: #fff;
    }
    .sample-img {
        min-width: 180px;
        min-height: 80px;
        max-width: 340px;
        max-height: 220px;
        object-fit: contain;
        border-radius: 13px;
        border: 3px solid #35523A;
        box-shadow: 0 8px 24px #0001;
        background: #fff;
        margin: 8px;
        cursor: zoom-in;
    }
    .drop-upload-label {
        font-weight:bold;
        font-size:15.2px;
        color:#222;
        display:block;
        margin-bottom:6px;
        transition: color 0.21s;
    }
    body.dark .drop-upload-label {
        color: var(--color-accent) !important;
    }
    .preview-imgs img {
        border: 1.5px solid #a49c62;
        border-radius: 7px;
        margin: 2px;
        max-width: 70px;
        max-height: 70px;
        box-shadow: 0 2px 6px #5552;
        cursor: zoom-in;
    }
    .upload-loading {
        display: none;
        justify-content: center;
        align-items: center;
        margin: 6px 0 6px 0;
        font-size: 16px;
        gap: 8px;
        color: #c49c48;
        font-weight: 500;
        min-height: 26px;
        min-width: 90px;
    }
    .upload-loading .fa-spinner {
        font-size: 19px;
        color: #c49c48;
        margin-right: 5px;
    }
    .upload-loading.success {
        color: #3cb464;
    }
    .upload-loading.success .fa-check {
        color: #3cb464;
    }
    #img-popup {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.88);
        align-items: center;
        justify-content: center;
        transition: background 0.24s;
    }
    #img-popup.show { display: flex; }
    #img-popup-inner {
        max-width: 88vw; max-height: 80vh;
        border-radius: 18px;
        border: 4px solid #eacb82;
        background: #fff;
        box-shadow: 0 8px 56px #000b;
        object-fit: contain;
        display: block;
        margin:auto;
        transition: background 0.22s, border-color 0.22s, box-shadow 0.18s;
    }
    #img-popup-close {
        position: absolute;
        top: 20px; right: 36px;
        color: #fff;
        font-size: 33px;
        font-weight: bold;
        background: rgba(0,0,0,0.18);
        border: none;
        border-radius: 100px;
        width: 44px; height:44px;
        line-height: 36px;
        text-align: center;
        cursor:pointer;
        z-index: 3200;
        box-shadow: 0 2px 12px #2226;
        transition: background 0.13s;
    }
    #img-popup-close:hover {background:rgba(220,40,40,0.22);} 
    .state-btn-group {
        margin-top: 18px;
        display: flex;
        gap: 16px;
        justify-content: center;
    }
    .state-btn {
        border: 2.2px solid #aaa;
        border-radius: 10px;
        font-size: 17px;
        font-weight: bold;
        padding: 8px 24px;
        background: #fffbe8;
        color: #4d665c;
        cursor: pointer;
        box-shadow: 0 2px 12px #eee4;
        transition: background 0.17s, color 0.14s, border-color 0.16s;
    }
    .state-btn.pass { border-color: #3bb464; color: #286d37; }
    .state-btn.fail { border-color: #df4343; color: #a82323; }
    .state-btn.na   { border-color: #e9ba27; color: #ac8209; }
    .state-btn.selected, .state-btn:active {
        background: #f5ecbe !important;
        color: #fff !important;
        border-color: #c49c48 !important;
        box-shadow: 0 4px 18px #d4b44b44;
    }
    .state-btn:hover { background: #f5ecc2; }
    .report-banner {
        color: #d6c49d;
        font-size: 21px;
        font-weight: bold;
        text-align: center;
        margin-top: 6px;
        margin-bottom: 14px;
        letter-spacing: 1px;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }
        </style>
</head>
<body>
    <!-- Nút darkmode -->
    <<button id="theme-btn" title="Chuyển Dark/Light mode"><i class="fa fa-moon"></i></button>
    <div class="report-banner">
        📝 MÃ REPORT: {{ report }}
    </div>
    <div class="box" role="main">
        <div class="back-btn-container">
            <a href="{{ url_for('test_group_page', report=report, group=group) }}" class="back-btn" tabindex="0" aria-label="Quay lại chọn mục kiểm tra">
                <svg width="19" height="19" style="vertical-align:middle;margin-right:4px;" fill="#fff" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.293 16.293a1 1 0 010-1.414L8.414 11H17a1 1 0 100-2H8.414l3.879-3.879a1 1 0 00-1.414-1.414l-5 5a1 1 0 000 1.414l5 5a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                </svg>
                Quay lại chọn mục kiểm tra
            </a>
        </div>
        <h2>{{ title['short'] }}</h2>
        <div class="section">
            <b>Mô tả kiểm thử:</b><br>
            {% for img in title['img'] %}
                <img src="{{ img }}" style="max-width:210px; margin:8px; border-radius:10px; border:2px solid #b8bbcf; box-shadow:0 2px 9px #8884;" alt="Ảnh mẫu kiểm thử"
                     class="sample-img"
                     onclick="showPopup(this)">
            {% endfor %}
            <br>
            <small>Nhấp vào ảnh mẫu để phóng to xem chi tiết</small>
        </div>
        <form id="main-upload-form" method="POST" enctype="multipart/form-data" style="margin-bottom:13px;text-align:center;" aria-label="Upload ảnh kiểm thử">
            {% if is_rh_np and key == 'step3' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_impact_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_impact_img_{{ zone }}" multiple accept="image/*" style="display:none;" id="rh-impact-upload-{{zone}}" onchange="uploadSpecialImgsAjax(this, 'rh_impact', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-impact-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-impact-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_impact-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_impact-{{zone}}"></i>
                                <span id="loading-text-rh_impact-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_impact-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div style="position:relative;display:inline-block;">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_impact', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step4' %}
                <div class="drop-upload-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    {% for zone, label in rh_vib_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48; padding:8px 14px 11px 14px; border-radius:10px; margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_vib_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-vib-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_vib', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-vib-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-vib-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_vib-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_vib-{{zone}}"></i>
                                <span id="loading-text-rh_vib-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_vib-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div style="position:relative;display:inline-block;">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_vib', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step5' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_second_impact_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_second_impact_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-second-impact-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_second_impact', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-second-impact-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-second-impact-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_second_impact-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_second_impact-{{zone}}"></i>
                                <span id="loading-text-rh_second_impact-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_second_impact-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div style="position:relative;display:inline-block;">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_second_impact', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step12' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_step12_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_step12_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-step12-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_step12', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-step12-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-step12-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_step12-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_step12-{{zone}}"></i>
                                <span id="loading-text-rh_step12-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_step12-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div style="position:relative;display:inline-block;">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_step12', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
             {% elif is_drop %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(10) %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ drop_labels[i] }}</label>
                            <input type="file" name="drop_img_{{ drop_zones[i] }}" multiple accept="image/*" style="display:none;" id="drop-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'drop', {{i}})">
                            <button type="button"
                                    class="gold-upload-btn {% if drop_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('drop-upload-{{i}}')"
                                    style="width:{{ '105px' if drop_imgs[i]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if drop_imgs[i]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if drop_imgs[i]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if drop_imgs[i]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="drop-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-drop-{{i}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-drop-{{i}}"></i>
                                <span id="loading-text-drop-{{i}}">Đang tải ảnh...</span>
                            </div>
                            <div class="preview-imgs" id="drop-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                            <div class="img-grid" id="drop-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in drop_imgs[i] %}
                                    <div style="position:relative;display:inline-block;">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'drop', {{i}})">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_impact %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(4) %}
                    <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                        <label class="drop-upload-label">{{ impact_labels[i] }}</label>
                        <input type="file" name="impact_img_{{ impact_zones[i] }}" multiple accept="image/*" style="display:none;" id="impact-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'impact', {{i}})">
                        <button type="button"
                                class="gold-upload-btn {% if impact_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                onclick="triggerUpload('impact-upload-{{i}}')"
                                style="width:{{ '105px' if impact_imgs[i]|length > 0 else '100%' }};
                                    font-size:{{ '13px' if impact_imgs[i]|length > 0 else '15px' }};
                                    padding:{{ '5px 12px' if impact_imgs[i]|length > 0 else '10px 32px' }};
                                    margin-bottom:7px;">
                            <i class="fa fa-upload"></i>
                            {% if impact_imgs[i]|length == 0 %}
                                Chọn và tải ảnh
                            {% else %}
                                Thêm ảnh
                            {% endif %}
                            <span id="impact-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                        </button>
                        <div class="upload-loading" id="loading-impact-{{i}}">
                            <i class="fa fa-spinner fa-spin" id="loading-spinner-impact-{{i}}"></i>
                            <span id="loading-text-impact-{{i}}">Đang tải ảnh...</span>
                        </div>
                        <div class="preview-imgs" id="impact-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                        <div class="img-grid" id="impact-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                            {% for img in impact_imgs[i] %}
                            <div style="position:relative;display:inline-block;">
                                <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'impact', {{i}})">
                                    <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                    <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% elif is_rot %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(4) %}
                    <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                        <label class="drop-upload-label">{{ rot_labels[i] }}</label>
                        <input type="file" name="rot_img_{{ rot_zones[i] }}" multiple accept="image/*" style="display:none;" id="rot-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'rot', {{i}})">
                        <button type="button"
                                class="gold-upload-btn {% if rot_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                onclick="triggerUpload('rot-upload-{{i}}')"
                                style="width:{{ '105px' if rot_imgs[i]|length > 0 else '100%' }};
                                    font-size:{{ '13px' if rot_imgs[i]|length > 0 else '15px' }};
                                    padding:{{ '5px 12px' if rot_imgs[i]|length > 0 else '10px 32px' }};
                                    margin-bottom:7px;">
                            <i class="fa fa-upload"></i>
                            {% if rot_imgs[i]|length == 0 %}
                                Chọn và tải ảnh
                            {% else %}
                                Thêm ảnh
                            {% endif %}
                            <span id="rot-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                        </button>
                        <div class="upload-loading" id="loading-rot-{{i}}">
                            <i class="fa fa-spinner fa-spin" id="loading-spinner-rot-{{i}}"></i>
                            <span id="loading-text-rot-{{i}}">Đang tải ảnh...</span>
                        </div>
                        <div class="preview-imgs" id="rot-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                        <div class="img-grid" id="rot-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                            {% for img in rot_imgs[i] %}
                            <div style="position:relative;display:inline-block;">
                                <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rot', {{i}})">
                                    <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                    <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <input type="file" name="test_imgs" multiple accept="image/*" style="display:none;" id="test-imgs-upload"
                    onchange="uploadImgsAjax(this)">
                <button type="button" class="gold-upload-btn" onclick="triggerUpload('test-imgs-upload')" id="normal-upload-btn">
                    Chọn và tải ảnh
                    <span id="test-imgs-fake-btn">Chưa chọn file</span>
                </button>
                <div class="upload-loading" id="loading-indicator">
                    <i class="fa fa-spinner fa-spin" id="loading-spinner"></i>
                    <span id="loading-text">Đang tải ảnh...</span>
                </div>
                <div class="img-grid" id="img-list-normal" style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;">
                    {% for img in imgs %}
                        <div style="position:relative;display:inline-block;">
                            <img src="{{ img }}" class="img-thumb" style="max-width:90px;max-height:90px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                            <form method="POST" class="img-del-form" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteImgAjax(this, '{{ img.split('/')[-1] }}')">
                                <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Nút PASS/FAIL/N/A (chỉ các bước được phép) -->
            {% set na_steps = ['step6','step7','step8','step11','step12'] %}
            {% if is_rh_np and key in ['step3','step4','step5'] %}
                <div class="state-btn-group" style="margin-top:18px;display:flex;gap:16px;justify-content:center;">
                    <button type="submit" name="status" value="PASS"
                            class="state-btn pass{% if status_value=='PASS' %} selected{% endif %}">
                        PASS
                    </button>
                    <button type="submit" name="status" value="FAIL"
                            class="state-btn fail{% if status_value=='FAIL' %} selected{% endif %}">
                        FAIL
                    </button>
                </div>
            {% elif is_rh_np and key in ['step6','step7','step8','step11','step12'] %}
                <div class="state-btn-group" style="margin-top:18px;display:flex;gap:16px;justify-content:center;">
                    <button type="submit" name="status" value="N/A"
                            class="state-btn na{% if status_value=='N/A' %} selected{% endif %}">
                        N/A
                    </button>
                </div>
            {% endif %}
            {% if status_value %}
            <div class="status-block" style="margin-top:16px;text-align:center;">
                {% if status_value == "PASS" %}
                    <span class="inline-status pass">PASS</span>
                {% elif status_value == "FAIL" %}
                    <span class="inline-status fail">FAIL</span>
                {% elif status_value == "N/A" %}
                    <span class="inline-status na">N/A</span>
                {% endif %}
            </div>
            {% endif %}
        </form>

        <form method="POST" class="comment-block" aria-label="Thêm ghi chú hoặc comment">
            <label class="cmt-label" for="comment_input">Thêm ghi chú/comment:</label><br>
            <textarea name="comment_input" id="comment_input" rows="2" style="width:97%;max-width:380px;border-radius:8px;padding:7px;font-size:16px;">{{comment or ''}}</textarea>
            <br>
            <button type="submit" name="save_comment" class="main-btn save-cmt">
                <i class="fa fa-save"></i> Lưu comment
            </button>
        </form>
    </div>
    <div id="img-popup" role="dialog" aria-modal="true" aria-label="Ảnh kiểm thử phóng to">
        <button id="img-popup-close" title="Đóng">&times;</button>
        <img id="img-popup-inner" src="" alt="Ảnh kiểm thử lớn"/>
    </div>
    <script>
        // ========== UPLOAD ẢNH AJAX VỚI MỤC THƯỜNG ==========
        function uploadImgsAjax(input) {
            var files = input.files;
            var btn = document.getElementById('test-imgs-fake-btn');
            var loading = document.getElementById('loading-indicator');
            var spinner = document.getElementById('loading-spinner');
            var loadingText = document.getElementById('loading-text');
            btn.innerText = files.length ? Array.from(files).map(f=>f.name).join(', ') : "Chưa chọn file";
            if (!files.length) return;
            loading.style.display = 'flex';
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
            loading.classList.remove('success');
            var formData = new FormData();
            for (var i = 0; i < files.length; i++) formData.append("test_imgs", files[i]);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", window.location.href, true);
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.onload = function() {
                spinner.className = 'fa fa-check';
                loadingText.innerText = 'Đã upload ảnh xong!';
                loading.classList.add('success');
                setTimeout(function() {
                    loading.style.display = 'none';
                    loading.classList.remove('success');
                    spinner.className = 'fa fa-spinner fa-spin';
                    loadingText.innerText = 'Đang tải ảnh...';
                }, 1800);
                if (xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    updateNormalImgList(data.imgs);
                }
                input.value = "";
                btn.innerText = "Chưa chọn file";
            };
            xhr.send(formData);
        }
        function updateNormalImgList(imgs) {
            var html = "";
            imgs.forEach(function(img) {
                html += `
                <div style="position:relative;display:inline-block;">
                    <img src="${img}" class="img-thumb" style="max-width:90px;max-height:90px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                    <form method="POST" class="img-del-form" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteImgAjax(this, '${img.split('/').pop()}')">
                        <input type="hidden" name="delete_img" value="${img.split('/').pop()}">
                        <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                            <i class="fa fa-trash"></i>
                        </button>
                    </form>
                </div>`;
            });
            document.getElementById('img-list-normal').innerHTML = html;
        }
        function deleteImgAjax(form, fname) {
            var formData = new FormData();
            formData.append("delete_img", fname);
            var loading = document.getElementById('loading-indicator');
            var spinner = document.getElementById('loading-spinner');
            var loadingText = document.getElementById('loading-text');
            loading.style.display = 'flex';
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
            loading.classList.remove('success');
            var xhr = new XMLHttpRequest();
            xhr.open("POST", window.location.href, true);
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.onload = function() {
                spinner.className = 'fa fa-check';
                loadingText.innerText = 'Đã upload ảnh xong!';
                loading.classList.add('success');
                setTimeout(function() {
                    loading.style.display = 'none';
                    loading.classList.remove('success');
                    spinner.className = 'fa fa-spinner fa-spin';
                    loadingText.innerText = 'Đang tải ảnh...';
                }, 1400);
                if (xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    updateNormalImgList(data.imgs);
                }
            };
            xhr.send(formData);
            return false;
        }

        // ========== UPLOAD ẢNH AJAX CHO DROP/IMPACT/ROTATION ==========
        function uploadSpecialImgsAjax(input, kind, idx) {
            var btn = document.getElementById(kind + "-upload-fake-btn-" + idx);
            var loading = document.getElementById('loading-' + kind + '-' + idx);
            var spinner = document.getElementById('loading-spinner-' + kind + '-' + idx);
            var loadingText = document.getElementById('loading-text-' + kind + '-' + idx);

            btn.innerText = input.files.length ? Array.from(input.files).map(f=>f.name).join(', ') : "Chưa chọn file";
            if (!input.files.length) return;
            loading.style.display = 'flex';
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
            loading.classList.remove('success');
            var formData = new FormData();
            for (var i = 0; i < input.files.length; i++) formData.append(input.name, input.files[i]);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", window.location.href, true);
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.onload = function() {
                spinner.className = 'fa fa-check';
                loadingText.innerText = 'Đã upload ảnh xong!';
                loading.classList.add('success');
                setTimeout(function() {
                    loading.style.display = 'none';
                    loading.classList.remove('success');
                    spinner.className = 'fa fa-spinner fa-spin';
                    loadingText.innerText = 'Đang tải ảnh...';
                }, 1800);
                if (xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    updateSpecialImgList(kind, idx, data.imgs[idx]);
                }
                input.value = "";
                btn.innerText = "Chưa chọn file";
            };
            xhr.send(formData);
        }
        function updateSpecialImgList(kind, idx, imgs) {
            var html = "";
            imgs.forEach(function(img) {
                html += `
                <div style="position:relative;display:inline-block;">
                    <img src="${img}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                    <form method="POST" style="display:inline;position:absolute;top:6px;left:8px;" onsubmit="return deleteSpecialImgAjax(event, '${img.split('/').pop()}', '${kind}', ${idx})">
                        <input type="hidden" name="delete_img" value="${img.split('/').pop()}">
                        <button type="submit" class="del-img-btn" title="Xóa ảnh này">
                            <i class="fa fa-trash"></i>
                        </button>
                    </form>
                </div>`;
            });
            document.getElementById(kind + '-img-list-' + idx).innerHTML = html;
        }
        function deleteSpecialImgAjax(e, fname, kind, idx) {
            e.preventDefault();
            var formData = new FormData();
            formData.append("delete_img", fname);
            formData.append("kind", kind);
            formData.append("zone_idx", idx);
            var loading = document.getElementById('loading-' + kind + '-' + idx);
            var spinner = document.getElementById('loading-spinner-' + kind + '-' + idx);
            var loadingText = document.getElementById('loading-text-' + kind + '-' + idx);
            loading.style.display = 'flex';
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
            loading.classList.remove('success');
            var xhr = new XMLHttpRequest();
            xhr.open("POST", window.location.href, true);
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.onload = function() {
                spinner.className = 'fa fa-check';
                loadingText.innerText = 'Đã upload ảnh xong!';
                loading.classList.add('success');
                setTimeout(function() {
                    loading.style.display = 'none';
                    loading.classList.remove('success');
                    spinner.className = 'fa fa-spinner fa-spin';
                    loadingText.innerText = 'Đang tải ảnh...';
                }, 1400);
                if (xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    updateSpecialImgList(kind, idx, data.imgs[idx]);
                }
            };
            xhr.send(formData);
            return false;
        }

        // ========== UI/UX ==========
        function showPopup(img) {
            var popup = document.getElementById('img-popup');
            var popupImg = document.getElementById('img-popup-inner');
            popupImg.src = img.src;
            popup.classList.add('show');
        }
        document.getElementById('img-popup-close').onclick = function(e) {
            var popup = document.getElementById('img-popup');
            var popupImg = document.getElementById('img-popup-inner');
            popup.classList.remove('show');
            popupImg.src = '';
            e.stopPropagation();
        };
        document.getElementById('img-popup').onclick = function(e) {
            if (e.target === this) {
                this.classList.remove('show');
                document.getElementById('img-popup-inner').src = '';
            }
        };
        document.addEventListener('keydown', function(e) {
            if (e.key === "Escape") {
                var popup = document.getElementById('img-popup');
                popup.classList.remove('show');
                document.getElementById('img-popup-inner').src = '';
            }
        });
        function triggerUpload(inputId) {
            document.getElementById(inputId).click();
        }
        // Darkmode toggle
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem("darkmode") === "true") {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark');
            }
            var themeBtn = document.getElementById('theme-btn');
            function syncDarkModeBtn() {
                var dark = document.body.classList.contains('dark');
                themeBtn.innerHTML = dark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
            }
            themeBtn.onclick = function() {
                var d = document.body.classList.toggle('dark');
                document.documentElement.classList.toggle('dark');
                localStorage.setItem("darkmode", d ? "true" : "false");
                syncDarkModeBtn();
            };
            syncDarkModeBtn();
        });
    </script>
</body>
</html>
