<!DOCTYPE html>
<html>
<head>
    <title>{{ name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
    :root {
        --main-bg: #fffdfc;
        --main-card: #fffdfccf;
        --main-text: #25312b;
        --main-th: #ffe082;
        --main-th-bright: #fff9d1;
        --main-border: #d8d8cc;
        --color-green: #4e8573;
        --color-bronze: #8B6B1E;
        --color-brown: #6B4F1A;
        --color-red-metallic: #A32121;
        --color-pass: #38b430;
        --color-fail: #df2323;
        --color-na: #666;
        --color-text-dark: #25312b;
        --color-text-light: #F9F7F0;
        --shadow-light: rgba(0,0,0,0.10);
        --shadow-dark: rgba(255,255,255,0.15);
        --dark-pass: #2a4e20;
        --dark-fail: #6a1b1b;
        --color-beige-bg: #F5F1E6;
    }
    body.dark, .dark {
        --main-bg: #2b3938;
        --main-card: #374B4A;
        --main-text: #f6f6ef;
        --main-th: #ffe082;
        --main-th-bright: #fffbe6;
        --main-border: #263d3a;
        --color-green: #91b8a2;
        --color-bronze: #ffc970;
        --color-brown: #bfa87b;
        --color-red-metallic: #ef7373;
        --color-pass: #93e5a0;
        --color-fail: #e68282;
        --color-na: #aaa;
        --color-text-dark: #f6f6ef;
        --color-text-light: #f6f6ef;
        --shadow-light: rgba(255,255,255,0.07);
        --shadow-dark: rgba(0,0,0,0.13);
        --dark-pass: #4e7763;
        --dark-fail: #ce4343;
        --color-beige-bg: #374B4A;
    }
    html, body {
        min-height: 100vh;
        background: var(--main-bg);
        color: var(--main-text);
        font-family: 'Inter', 'Open Sans', Arial, sans-serif;
        margin:0;padding:0;
        transition: background 0.27s, color 0.21s;
    }
    body.dark, .dark {
        color: var(--color-text-light) !important;
        transition: background 0.27s, color 0.21s;
    }
    body.dark .box {
        background: var(--main-card) !important;
        color: var(--main-text) !important;
        box-shadow: 0 4px 32px var(--shadow-dark);
    }
    body.dark h2,
    body.dark .cmt-label,
    body.dark .section b {
        color: var(--main-th) !important;
    }
    body.dark .img-thumb, body.dark .sample-img {
        border-color: var(--color-green) !important;
        background: #222 !important;
    }
    body.dark .back-btn,
    body.dark .gold-upload-btn,
    body.dark .del-btn {
        background: var(--main-th) !important;
        color: #25312b !important;
        border-color: var(--main-th);
    }
    .report-banner {
        color: #d6c49d;
        font-size: 21px;
        font-weight: bold;
        text-align: center;
        margin-top: 6px;
        margin-bottom: 14px;
        letter-spacing: 1px;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }
    .back-btn, .del-btn {
        color: var(--color-green) !important;
    }
    #theme-btn {
        position: fixed; right: 24px; bottom: 26px; z-index: 11001;
        background: var(--color-bronze); color: #fff;
        border-radius: 100px; font-size: 17px;
        padding: 6px 11px; border:none; box-shadow: 0 2px 10px var(--shadow-light);
        cursor:pointer; height: 38px; width: 38px; min-width:36px;
        display:flex;align-items:center;justify-content:center;opacity:0.96;
        transition: background 0.16s, color 0.16s;
    }
    #theme-btn:hover { background: var(--color-green); color: #fff; opacity:1; }
    .box {
        background: var(--main-card);
        max-width: 540px;
        margin: 0 auto 32px auto;
        border-radius: 18px;
        box-shadow: 0 4px 30px var(--shadow-light);
        padding: 34px 20px 32px 20px;
        animation: fadeGrow 0.7s;
        position:relative;
        font-family: 'Inter', 'Open Sans', Arial, sans-serif;
        color: var(--color-text-dark);
        transition: background 0.38s, color 0.36s, box-shadow 0.22s;
    }
    @keyframes fadeGrow {
        0% { opacity: 0; transform: scale(0.98);}
        100% { opacity: 1; transform: scale(1);}
    }
    .back-btn-container {
        text-align: left;
        margin-bottom: 6px;
        margin-top: 0;
    }
    .back-btn {
        background: #faf7ec;
        color: #73592c !important;
        border: 1px solid #d5c69d;
        border-radius: 11px;
        font-family: 'Inter', 'Open Sans', Arial, sans-serif;
        font-size: 13.3px;
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 4px 12px 4px 11px;
        min-width: 0;
        box-shadow: 0 1px 6px #d4c8942a;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        transition: background 0.13s, color 0.13s, border-color 0.13s;
    }
    .back-btn:hover {
        background: #ffe082;
        color: #25312b !important;
        border-color: #ffe082;
    }
    .back-btn svg {
        margin: 0 !important;
    }
    h2 {
        color: var(--color-green);
        margin-bottom: 12px;
        text-align:center;
        font-size: 25px;
        font-weight: bold;
        letter-spacing: 1.1px;
        margin-top: 0;
        text-shadow: 0 2px 14px #c49c484a;
        font-family: 'Merriweather', serif;
    }
    .status-block {text-align:center;margin-bottom:14px;}
    .inline-status {
        font-size: 22px;
        font-weight: bold;
        margin: 0 auto 7px auto;
        border-radius: 10px;
        padding: 5px 22px;
        display: inline-block;
        letter-spacing: 0.08em;
        box-shadow: 0 2px 13px #0002;
        background: #f8fff8;
        color: var(--color-pass);
        border: 2px solid var(--color-pass);
        transition: background 0.38s, color 0.36s, border-color 0.36s;
    }
    .inline-status.fail {
        background: #fff5f7;
        color: var(--color-fail) !important;
        border: 2px solid var(--color-fail);
    }
    .inline-status.na {
        background: #f1f1f1;
        color: var(--color-na);
        border: 2px solid #b8b8b8;
    }
    body.dark .inline-status {
        background: #f8fff8 !important;
        color: var(--color-pass) !important;
        border-color: var(--color-pass) !important;
    }
    body.dark .inline-status.fail {
        background: #fff5f7 !important;
        color: var(--color-fail) !important;
        border-color: var(--color-fail) !important;
    }
    body.dark .inline-status.na {
        background: #f1f1f1 !important;
        color: var(--color-na) !important;
        border-color: #b8b8b8 !important;
    }
    .missing-img-warn {color:#e33;font-size:16px;text-align:center;margin:4px auto 6px auto;font-weight:bold;}
    .cmt-view {
        border-radius:8px;
        background:#f2f6f6;
        padding:8px 13px;
        margin:8px auto 0 auto;
        font-size:17px;
        color:#215d37;
        min-height:25px;
        max-width:95%;
        border: 1.2px solid #b6c3c0;
        display: inline-block;
    }
    .section { margin-bottom:28px; text-align:center;}
    .section b { color: var(--color-green); font-size:18px; font-weight:700; letter-spacing: 0.06em;}
    .sample-img {
        border-radius: 13px;
        border: 3px solid var(--color-green);
        max-width: 340px; max-height: 200px;
        min-width: 120px;
        object-fit: contain;
        background: #fff;
        box-shadow: 0 8px 24px var(--shadow-light);
        transition: box-shadow 0.16s, transform 0.12s, background 0.23s, border-color 0.23s;
        cursor: zoom-in;
    }
    .sample-img:hover {box-shadow: 0 12px 38px var(--color-green);transform: scale(1.08) rotate(-1.5deg);}
    .state-btn-group {display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:6px;}
    .state-btn {
        font-size:18px; padding:7px 18px; border:none; border-radius:9px; font-weight:bold;
        color: var(--main-th-bright);
        transition: box-shadow 0.17s, background 0.19s;
    }
    .pass {background: var(--color-pass); color:white;}
    .fail {background: var(--color-fail); color:white;}
    .na {background:#7a7a7a; color:white;}
    .selected { box-shadow: 0 0 0 3px #93e5a0;}
    .img-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 18px;
        justify-items: center;
        align-items: center;
        margin-bottom: 22px;
        margin-top: 6px;
    }
    .img-thumb-wrap {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 140px;
        height: 140px;
    }
    .img-thumb {
        max-width:130px; max-height:130px;
        border-radius:11px;
        border:2px solid var(--color-green);
        box-shadow:0 4px 18px var(--shadow-light);
        cursor:zoom-in;
        background: #fff;
        transition: box-shadow 0.15s, transform 0.12s, background 0.21s, border-color 0.21s;
        display: block;
        margin: 0 auto;
    }
    .img-thumb:hover {box-shadow:0 8px 26px var(--color-green);transform: scale(1.06);}
    .del-btn {
        position: absolute;
        top: 8px;
        right: 10px;
        background: var(--color-fail);
        color: #fff;
        border: none;
        border-radius: 100px;
        width: 28px; height: 28px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px #2225;
        opacity: 0.91;
        z-index: 2;
        transition: opacity 0.18s, box-shadow 0.14s, background 0.18s;
        outline: none;
        cursor: pointer;
        padding: 0;
    }
    .del-btn:hover {opacity: 1; background:#760212;}
    .comment-block {text-align:center;margin:18px 0 7px 0;}
    .cmt-label {font-size:17px;color: var(--color-green);}
    .center {text-align:center;}
    .gold-upload-btn {
        background: var(--color-green);
        color: #fff;
        font-size: 17px;
        padding: 10px 32px;
        border-radius: 999px;
        font-weight: bold;
        border: none;
        margin: 10px auto 0 auto;
        box-shadow: 0 2px 10px var(--shadow-light);
        display: inline-block;
        text-align:center;
        cursor:pointer;
        min-width:135px;
        position: relative;
        overflow: hidden;
        transition: background 0.14s, color 0.14s;
    }
    .gold-upload-btn:hover { background: var(--color-brown); color: #fff; }
    body.dark .gold-upload-btn { background: var(--color-green); color: #fff; }
    body.dark .gold-upload-btn:hover { background: #ffe082; color: #25312b; }
    /* Nút lưu comment (bo tròn đẹp như upload) */
    .main-btn.save-cmt {
        background: var(--color-green);
        color: #fff;
        font-size: 17px;
        padding: 10px 32px;
        border-radius: 999px;
        font-weight: bold;
        border: none;
        margin: 10px auto 0 auto;
        box-shadow: 0 2px 10px var(--shadow-light);
        display: inline-block;
        text-align:center;
        cursor:pointer;
        min-width:135px;
        position: relative;
        overflow: hidden;
        transition: background 0.14s, color 0.14s;
    }
    .main-btn.save-cmt:hover { background: var(--color-brown); color: #fff; }
    body.dark .main-btn.save-cmt { background: var(--color-green); color: #fff; }
    body.dark .main-btn.save-cmt:hover { background: #ffe082; color: #25312b; }
    textarea {
        width: 97%;
        max-width: 380px;
        border-radius: 8px;
        padding: 7px;
        font-size: 16px;
        border: 1.2px solid var(--main-th);
        background: #fffbe5;
        color: var(--main-text);
        transition: background 0.17s, color 0.16s, border-color 0.14s;
    }
    body.dark textarea {
        background: #3f5250;
        color: #f6f6ef;
        border-color: #91b8a2;
    }
    body.dark textarea:focus {
        border-color: #ffe082;
        background: #405e59;
        color: #fff;
    }
    /* Loading */
    .upload-loading {
        display: none;
        align-items: center;
        gap: 7px;
        font-size: 15px;
        color: #4e8573;
        margin: 10px 0 0 0;
        justify-content: center;
        min-height: 27px;
        transition: color 0.18s;
    }
    .upload-loading.success { color: #38b430; }
    #img-popup {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.88);
        align-items: center;
        justify-content: center;
        transition: background 0.24s;
    }
    #img-popup.show { display: flex; }
    #img-popup-inner {
        max-width: 88vw; max-height: 80vh;
        border-radius: 18px;
        border: 4px solid #eacb82;
        background: #fff;
        box-shadow: 0 8px 56px #000b;
        object-fit: contain;
        display: block;
        margin:auto;
        transition: background 0.22s, border-color 0.22s, box-shadow 0.18s;
    }
    #img-popup-close {
        position: absolute;
        top: 20px; right: 36px;
        color: #fff;
        font-size: 33px;
        font-weight: bold;
        background: rgba(0,0,0,0.18);
        border: none;
        border-radius: 100px;
        width: 44px; height:44px;
        line-height: 36px;
        text-align: center;
        cursor:pointer;
        z-index: 3200;
        box-shadow: 0 2px 12px #2226;
        transition: background 0.13s;
    }
    #img-popup-close:hover {background:rgba(220,40,40,0.22);}
    .ripple {
        position: absolute; border-radius: 50%; transform: scale(0);
        animation: ripple 0.32s cubic-bezier(0.39, 0.58, 0.57, 1);
        background: rgba(255,255,255,0.29); pointer-events: none; z-index: 10; opacity: 0.77;
    }
    @keyframes ripple { to { transform: scale(1.5); opacity: 0; } }
    </style>
</head>
<body>
    <!-- Nút darkmode -->
    <button id="theme-btn" title="Chuyển Dark/Light mode"><i class="fa fa-moon"></i></button>
    <div class="report-banner">
        📝 MÃ REPORT: {{ report }}
    </div>
    <div class="box" role="main">
        <div class="back-btn-container">
            <a href="{{ url_for('test_group_page', report=report, group=group) }}" class="back-btn"
                tabindex="0"
                aria-label="Quay lại chọn mục kiểm tra">
            <i class="fa fa-arrow-left"></i> 
                Quay lại chọn mục kiểm tra
            </a>
        </div>
        <h2>{{ title['short'] }}</h2>
        <div class="section">
            <b>Mô tả kiểm thử:</b><br>
            {% for img in title['img'] %}
                <img src="{{ img }}" style="max-width:210px; margin:8px; border-radius:10px; border:2px solid #b8bbcf; box-shadow:0 2px 9px #8884;" alt="Ảnh mẫu kiểm thử"
                     class="sample-img"
                     onclick="showPopup(this)">
            {% endfor %}
            <br>
            <small>Nhấp vào ảnh mẫu để phóng to xem chi tiết</small>
        </div>
        <form id="main-upload-form" method="POST" enctype="multipart/form-data" style="margin-bottom:13px;text-align:center;" aria-label="Upload ảnh kiểm thử">
            {% if is_rh_np and key == 'step3' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_impact_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_impact_img_{{ zone }}" multiple accept="image/*" style="display:none;" id="rh-impact-upload-{{zone}}" onchange="uploadSpecialImgsAjax(this, 'rh_impact', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-impact-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-impact-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_impact-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_impact-{{zone}}"></i>
                                <span id="loading-text-rh_impact-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_impact-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_impact', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step4' %}
                <div class="drop-upload-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    {% for zone, label in rh_vib_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48; padding:8px 14px 11px 14px; border-radius:10px; margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_vib_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-vib-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_vib', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-vib-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-vib-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_vib-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_vib-{{zone}}"></i>
                                <span id="loading-text-rh_vib-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_vib-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_vib', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step5' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_second_impact_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_second_impact_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-second-impact-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_second_impact', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-second-impact-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-second-impact-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_second_impact-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_second_impact-{{zone}}"></i>
                                <span id="loading-text-rh_second_impact-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_second_impact-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_second_impact', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rh_np and key == 'step12' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    {% for zone, label in rh_step12_zones %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ label }}</label>
                            <input type="file" name="rh_step12_img_{{ zone }}" multiple accept="image/*"
                                style="display:none;" id="rh-step12-upload-{{zone}}"
                                onchange="uploadSpecialImgsAjax(this, 'rh_step12', '{{zone}}')">
                            <button type="button"
                                    class="gold-upload-btn {% if zone_imgs[zone]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('rh-step12-upload-{{zone}}')"
                                    style="width:{{ '105px' if zone_imgs[zone]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if zone_imgs[zone]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if zone_imgs[zone]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if zone_imgs[zone]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="rh-step12-upload-fake-btn-{{zone}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-rh_step12-{{zone}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-rh_step12-{{zone}}"></i>
                                <span id="loading-text-rh_step12-{{zone}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="rh_step12-img-list-{{zone}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in zone_imgs[zone] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rh_step12', '{{zone}}')">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
             {% elif is_drop %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(10) %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ drop_labels[i] }}</label>
                            <input type="file" name="drop_img_{{ drop_zones[i] }}" multiple accept="image/*" style="display:none;" id="drop-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'drop', {{i}})">
                            <button type="button"
                                    class="gold-upload-btn {% if drop_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('drop-upload-{{i}}')"
                                    style="width:{{ '105px' if drop_imgs[i]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if drop_imgs[i]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if drop_imgs[i]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if drop_imgs[i]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="drop-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-drop-{{i}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-drop-{{i}}"></i>
                                <span id="loading-text-drop-{{i}}">Đang tải ảnh...</span>
                            </div>
                            <div class="preview-imgs" id="drop-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                            <div class="img-grid" id="drop-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in drop_imgs[i] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'drop', {{i}})">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_impact %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(4) %}
                    <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                        <label class="drop-upload-label">{{ impact_labels[i] }}</label>
                        <input type="file" name="impact_img_{{ impact_zones[i] }}" multiple accept="image/*" style="display:none;" id="impact-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'impact', {{i}})">
                        <button type="button"
                                class="gold-upload-btn {% if impact_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                onclick="triggerUpload('impact-upload-{{i}}')"
                                style="width:{{ '105px' if impact_imgs[i]|length > 0 else '100%' }};
                                    font-size:{{ '13px' if impact_imgs[i]|length > 0 else '15px' }};
                                    padding:{{ '5px 12px' if impact_imgs[i]|length > 0 else '10px 32px' }};
                                    margin-bottom:7px;">
                            <i class="fa fa-upload"></i>
                            {% if impact_imgs[i]|length == 0 %}
                                Chọn và tải ảnh
                            {% else %}
                                Thêm ảnh
                            {% endif %}
                            <span id="impact-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                        </button>
                        <div class="upload-loading" id="loading-impact-{{i}}">
                            <i class="fa fa-spinner fa-spin" id="loading-spinner-impact-{{i}}"></i>
                            <span id="loading-text-impact-{{i}}">Đang tải ảnh...</span>
                        </div>
                        <div class="preview-imgs" id="impact-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                        <div class="img-grid" id="impact-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                            {% for img in impact_imgs[i] %}
                            <div class="img-thumb-wrap">
                                <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'impact', {{i}})">
                                    <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                    <button type="submit" class="del-btn" title="Xóa ảnh này">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% elif group == 'transit_181_gt68' and key == 'step4' %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(6) %}
                        <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                            <label class="drop-upload-label">{{ gt68_face_labels[i] }}</label>
                            <input type="file" name="gt68_face_img_{{ gt68_face_zones[i] }}" multiple accept="image/*" style="display:none;" id="gt68-face-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'gt68_face', {{i}})">
                            <button type="button"
                                    class="gold-upload-btn {% if gt68_face_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                    onclick="triggerUpload('gt68-face-upload-{{i}}')"
                                    style="width:{{ '105px' if gt68_face_imgs[i]|length > 0 else '100%' }};
                                        font-size:{{ '13px' if gt68_face_imgs[i]|length > 0 else '15px' }};
                                        padding:{{ '5px 12px' if gt68_face_imgs[i]|length > 0 else '10px 32px' }};
                                        margin-bottom:7px;">
                                <i class="fa fa-upload"></i>
                                {% if gt68_face_imgs[i]|length == 0 %}
                                    Chọn và tải ảnh
                                {% else %}
                                    Thêm ảnh
                                {% endif %}
                                <span id="gt68-face-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                            </button>
                            <div class="upload-loading" id="loading-gt68_face-{{i}}">
                                <i class="fa fa-spinner fa-spin" id="loading-spinner-gt68_face-{{i}}"></i>
                                <span id="loading-text-gt68_face-{{i}}">Đang tải ảnh...</span>
                            </div>
                            <div class="img-grid" id="gt68_face-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                                {% for img in gt68_face_imgs[i] %}
                                    <div class="img-thumb-wrap">
                                        <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                        <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'gt68_face', {{i}})">
                                            <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                            <button type="submit" class="del-btn" title="Xóa ảnh này">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif is_rot %}
                <div class="drop-upload-group" style="display:grid;grid-template-columns:1fr 1fr;gap:18px 24px;justify-content:center;">
                    {% for i in range(4) %}
                    <div class="drop-upload-zone" style="border:1px solid #c49c48;padding:8px 14px 11px 14px;border-radius:10px;margin-bottom:8px;">
                        <label class="drop-upload-label">{{ rot_labels[i] }}</label>
                        <input type="file" name="rot_img_{{ rot_zones[i] }}" multiple accept="image/*" style="display:none;" id="rot-upload-{{i}}" onchange="uploadSpecialImgsAjax(this, 'rot', {{i}})">
                        <button type="button"
                                class="gold-upload-btn {% if rot_imgs[i]|length > 0 %}btn-mini{% endif %}"
                                onclick="triggerUpload('rot-upload-{{i}}')"
                                style="width:{{ '105px' if rot_imgs[i]|length > 0 else '100%' }};
                                    font-size:{{ '13px' if rot_imgs[i]|length > 0 else '15px' }};
                                    padding:{{ '5px 12px' if rot_imgs[i]|length > 0 else '10px 32px' }};
                                    margin-bottom:7px;">
                            <i class="fa fa-upload"></i>
                            {% if rot_imgs[i]|length == 0 %}
                                Chọn và tải ảnh
                            {% else %}
                                Thêm ảnh
                            {% endif %}
                            <span id="rot-upload-fake-btn-{{i}}" style="font-size:12px;color:#333;padding-left:7px;">Chưa chọn file</span>
                        </button>
                        <div class="upload-loading" id="loading-rot-{{i}}">
                            <i class="fa fa-spinner fa-spin" id="loading-spinner-rot-{{i}}"></i>
                            <span id="loading-text-rot-{{i}}">Đang tải ảnh...</span>
                        </div>
                        <div class="preview-imgs" id="rot-preview-{{i}}" style="display:flex;gap:7px;margin:4px 0 0 0;"></div>
                        <div class="img-grid" id="rot-img-list-{{i}}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;justify-content:left;">
                            {% for img in rot_imgs[i] %}
                            <div class="img-thumb-wrap">
                                <img src="{{ img }}" class="img-thumb" style="max-width:78px;max-height:78px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                                <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteSpecialImgAjax(event, '{{ img.split('/')[-1] }}', 'rot', {{i}})">
                                    <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                    <button type="submit" class="del-btn" title="Xóa ảnh này">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <input type="file" name="test_imgs" multiple accept="image/*" style="display:none;" id="test-imgs-upload"
                    onchange="uploadImgsAjax(this)">
                <button type="button" class="gold-upload-btn" onclick="triggerUpload('test-imgs-upload')" id="normal-upload-btn">
                    Chọn và tải ảnh
                    <span id="test-imgs-fake-btn">Chưa chọn file</span>
                </button>
                <div class="upload-loading" id="loading-indicator">
                    <i class="fa fa-spinner fa-spin" id="loading-spinner"></i>
                    <span id="loading-text">Đang tải ảnh...</span>
                </div>
                <div class="img-grid" id="img-list-normal" style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;">
                    {% for img in imgs %}
                        <div class="img-thumb-wrap">
                            <img src="{{ img }}" class="img-thumb" style="max-width:90px;max-height:90px;border-radius:8px;border:2px solid #4d665c;margin:2px;" onclick="showPopup(this)">
                            <form method="POST" class="img-del-form" style="display:inline;position:absolute;top:8px;right:10px;" onsubmit="return deleteImgAjax(this, '{{ img.split('/')[-1] }}')">
                                <input type="hidden" name="delete_img" value="{{ img.split('/')[-1] }}">
                                <button type="submit" class="del-btn" title="Xóa ảnh này">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Nút PASS/FAIL/N/A (chỉ các bước được phép) -->
            {% set na_steps = ['step6','step7','step8','step11','step12'] %}
            {% if is_rh_np and key in ['step3','step4','step5'] %}
                <div class="state-btn-group" style="margin-top:18px;display:flex;gap:16px;justify-content:center;">
                    <button type="submit" name="status" value="PASS"
                            class="state-btn pass{% if status_value=='PASS' %} selected{% endif %}">
                        PASS
                    </button>
                    <button type="submit" name="status" value="FAIL"
                            class="state-btn fail{% if status_value=='FAIL' %} selected{% endif %}">
                        FAIL
                    </button>
                </div>
            {% elif is_rh_np and key in ['step6','step7','step8','step11','step12'] %}
                <div class="state-btn-group" style="margin-top:18px;display:flex;gap:16px;justify-content:center;">
                    <button type="submit" name="status" value="N/A"
                            class="state-btn na{% if status_value=='N/A' %} selected{% endif %}">
                        N/A
                    </button>
                </div>
            {% endif %}
            {% if status_value %}
            <div class="status-block" style="margin-top:16px;text-align:center;">
                {% if status_value == "PASS" %}
                    <span class="inline-status pass">PASS</span>
                {% elif status_value == "FAIL" %}
                    <span class="inline-status fail">FAIL</span>
                {% elif status_value == "N/A" %}
                    <span class="inline-status na">N/A</span>
                {% endif %}
            </div>
            {% endif %}
        </form>
        <form method="POST" class="comment-block" aria-label="Thêm ghi chú hoặc comment">
            <label class="cmt-label" for="comment_input">Thêm ghi chú/comment:</label><br>
            <textarea name="comment_input" id="comment_input" rows="2" style="width:97%;max-width:380px;border-radius:8px;padding:7px;font-size:16px;">{{comment or ''}}</textarea>
            <br>
            <button type="submit" name="save_comment" class="main-btn save-cmt">
                <i class="fa fa-save"></i> Lưu comment
            </button>
        </form>
    </div>
    <div id="img-popup" role="dialog" aria-modal="true" aria-label="Ảnh kiểm thử phóng to">
        <button id="img-popup-close" title="Đóng">&times;</button>
        <img id="img-popup-inner" src="" alt="Ảnh kiểm thử lớn"/>
    </div>
    <script>

    function getRespList(data, type, zone) {
    var key1 = String(zone);
    var key2 = (type === 'gt68_face') ? ('gt68_' + key1) : key1;
    if (!data || !data.imgs) return [];
    return data.imgs[key1] || data.imgs[key2] || [];
    }

    /* ===== Upload ảnh thường (không theo vùng) ===== */
    function uploadImgsAjax(input) {
    var files = input.files;
    var btn = document.getElementById('test-imgs-fake-btn');
    var loading = document.getElementById('loading-indicator');
    var spinner = document.getElementById('loading-spinner');
    var loadingText = document.getElementById('loading-text');

    loading.style.display = 'none';
    btn.innerText = files.length ? Array.from(files).map(f=>f.name).join(', ') : "Chưa chọn file";
    if (!files.length) return;

    loading.style.display = 'flex';
    spinner.className = 'fa fa-spinner fa-spin';
    loadingText.innerText = 'Đang tải ảnh...';
    loading.classList.remove('success');

    var formData = new FormData();
    for (var i = 0; i < files.length; i++) formData.append("test_imgs", files[i]);

    var xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
    xhr.onload = function() {
        if (xhr.status === 200) {
        spinner.className = 'fa fa-check';
        loadingText.innerText = 'Đã upload ảnh xong!';
        loading.classList.add('success');
        try {
            var data = JSON.parse(xhr.responseText);
            updateNormalImgList(data.imgs || []);
        } catch(e) {}
        setTimeout(function() {
            loading.style.display = 'none';
            loading.classList.remove('success');
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
        }, 1500);
        } else {
        spinner.className = 'fa fa-times';
        loadingText.innerText = `Lỗi upload (${xhr.status}).`;
        setTimeout(function(){ loading.style.display = 'none'; }, 2500);
        }
        input.value = "";
        btn.innerText = "Chưa chọn file";
    };
    xhr.send(formData);
    }

    /* ===== Upload ảnh theo vùng (RH/Drop/Impact/Rot/GT68) ===== */
    function uploadSpecialImgsAjax(input, type, zone) {
    var files = input.files;
    var fakeBtn   = document.getElementById(`${type}-upload-fake-btn-${zone}`);
    var loading   = document.getElementById(`loading-${type}-${zone}`);
    var spinner   = document.getElementById(`loading-spinner-${type}-${zone}`);
    var loadingTx = document.getElementById(`loading-text-${type}-${zone}`);

    if (loading) loading.style.display = 'none';
    if (fakeBtn)  fakeBtn.innerText = files.length ? Array.from(files).map(f=>f.name).join(', ') : "Chưa chọn file";
    if (!files.length) return;

    if (loading) loading.style.display = 'flex';
    if (spinner) spinner.className = 'fa fa-spinner fa-spin';
    if (loadingTx) loadingTx.innerText = 'Đang tải ảnh...';
    if (loading) loading.classList.remove('success');

    var formData = new FormData();
    // ⭐ Quan trọng: dùng đúng tên field từ chính input
    var field = input.name;
    for (var i = 0; i < files.length; i++) formData.append(field, files[i]);

    var xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
    xhr.onload = function() {
        if (xhr.status === 200) {
        if (spinner)   spinner.className = 'fa fa-check';
        if (loadingTx) loadingTx.innerText = 'Đã upload ảnh xong!';
        if (loading)   loading.classList.add('success');

        try {
            var data = JSON.parse(xhr.responseText);
            var list = getRespList(data, type, zone);
            var imgGrid = document.getElementById(`${type}-img-list-${zone}`);
            if (imgGrid) {
            var html = '';
            list.forEach(function(img) {
                var fname = img.split('/').pop();
                html += `
                <div class="img-thumb-wrap">
                    <img src="${img}" class="img-thumb" onclick="showPopup(this)" alt="Ảnh kiểm thử">
                    <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;"
                        onsubmit="return deleteSpecialImgAjax(event, '${fname}', '${type}', '${zone}')">
                    <input type="hidden" name="delete_img" value="${fname}">
                    <button type="submit" class="del-btn" title="Xóa ảnh này">
                        <i class="fa fa-trash"></i>
                    </button>
                    </form>
                </div>`;
            });
            imgGrid.innerHTML = html;
            }
        } catch(e) {}

        setTimeout(function() {
            if (loading) loading.style.display = 'none';
            if (loading) loading.classList.remove('success');
            if (spinner) spinner.className = 'fa fa-spinner fa-spin';
            if (loadingTx) loadingTx.innerText = 'Đang tải ảnh...';
        }, 1200);
        } else {
        if (spinner) spinner.className = 'fa fa-times';
        if (loadingTx) loadingTx.innerText = `Lỗi upload (${xhr.status}).`;
        setTimeout(function(){ if (loading) loading.style.display = 'none'; }, 2500);
        }

        input.value = "";
        if (fakeBtn) fakeBtn.innerText = "Chưa chọn file";
    };
    xhr.send(formData);
    }

    /* ===== Render lại danh sách ảnh thường ===== */
    function updateNormalImgList(imgs) {
    var html = "";
    imgs.forEach(function(img) {
        var fname = img.split('/').pop();
        html += `
        <div class="img-thumb-wrap">
            <img src="${img}" class="img-thumb" onclick="showPopup(this)" alt="Ảnh kiểm thử">
            <form method="POST" class="img-del-form" style="display:inline;position:absolute;top:8px;right:10px;"
                onsubmit="return deleteImgAjax(this, '${fname}')">
            <input type="hidden" name="delete_img" value="${fname}">
            <button type="submit" class="del-btn" title="Xóa ảnh này">
                <i class="fa fa-trash"></i>
            </button>
            </form>
        </div>`;
    });
    var grid = document.getElementById('img-list-normal');
    if (grid) grid.innerHTML = html;
    }

    /* ===== Xoá ảnh thường ===== */
    function deleteImgAjax(form, fname) {
    var formData = new FormData();
    formData.append("delete_img", fname);

    var loading = document.getElementById('loading-indicator');
    var spinner = document.getElementById('loading-spinner');
    var loadingText = document.getElementById('loading-text');

    loading.style.display = 'flex';
    spinner.className = 'fa fa-spinner fa-spin';
    loadingText.innerText = 'Đang xóa ảnh...';
    loading.classList.remove('success');

    var xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
    xhr.onload = function() {
        if (xhr.status === 200) {
        spinner.className = 'fa fa-check';
        loadingText.innerText = 'Đã xóa ảnh!';
        loading.classList.add('success');
        try {
            var data = JSON.parse(xhr.responseText);
            updateNormalImgList(data.imgs || []);
        } catch(e) {}
        setTimeout(function() {
            loading.style.display = 'none';
            loading.classList.remove('success');
            spinner.className = 'fa fa-spinner fa-spin';
            loadingText.innerText = 'Đang tải ảnh...';
        }, 1200);
        } else {
        spinner.className = 'fa fa-times';
        loadingText.innerText = `Lỗi xóa (${xhr.status}).`;
        setTimeout(function(){ loading.style.display = 'none'; }, 2500);
        }
    };
    xhr.send(formData);
    return false;
    }

    /* ===== Xoá ảnh theo vùng ===== */
    function deleteSpecialImgAjax(event, fname, type, zone) {
    event.preventDefault();

    var formData = new FormData();
    formData.append("delete_img", fname);

    var loading   = document.getElementById(`loading-${type}-${zone}`);
    var spinner   = document.getElementById(`loading-spinner-${type}-${zone}`);
    var loadingTx = document.getElementById(`loading-text-${type}-${zone}`);

    if (loading) loading.style.display = 'flex';
    if (spinner) spinner.className = 'fa fa-spinner fa-spin';
    if (loadingTx) loadingTx.innerText = 'Đang xóa ảnh...';
    if (loading) loading.classList.remove('success');

    var xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
    xhr.onload = function() {
        if (xhr.status === 200) {
        if (spinner) spinner.className = 'fa fa-check';
        if (loadingTx) loadingTx.innerText = 'Đã xóa ảnh!';
        if (loading) loading.classList.add('success');
        try {
            var data = JSON.parse(xhr.responseText);
            var list = getRespList(data, type, zone);
            var imgGrid = document.getElementById(`${type}-img-list-${zone}`);
            if (imgGrid) {
            var html = '';
            list.forEach(function(img) {
                var fn = img.split('/').pop();
                html += `
                <div class="img-thumb-wrap">
                    <img src="${img}" class="img-thumb" onclick="showPopup(this)" alt="Ảnh kiểm thử">
                    <form method="POST" style="display:inline;position:absolute;top:8px;right:10px;"
                        onsubmit="return deleteSpecialImgAjax(event, '${fn}', '${type}', '${zone}')">
                    <input type="hidden" name="delete_img" value="${fn}">
                    <button type="submit" class="del-btn" title="Xóa ảnh này">
                        <i class="fa fa-trash"></i>
                    </button>
                    </form>
                </div>`;
            });
            imgGrid.innerHTML = html;
            }
        } catch(e) {}
        setTimeout(function() {
            if (loading) loading.style.display = 'none';
            if (loading) loading.classList.remove('success');
            if (spinner) spinner.className = 'fa fa-spinner fa-spin';
            if (loadingTx) loadingTx.innerText = 'Đang tải ảnh...';
        }, 1200);
        } else {
        if (spinner) spinner.className = 'fa fa-times';
        if (loadingTx) loadingTx.innerText = `Lỗi xóa (${xhr.status}).`;
        setTimeout(function(){ if (loading) loading.style.display = 'none'; }, 2500);
        }
    };
    xhr.send(formData);
    return false;
    }

    /* ===== Phóng to ảnh ===== */
    function showPopup(img) {
    var popup = document.getElementById('img-popup');
    var popupImg = document.getElementById('img-popup-inner');
    popupImg.src = img.src;
    popup.classList.add('show');
    }
    document.getElementById('img-popup-close').onclick = function(e) {
    var popup = document.getElementById('img-popup');
    var popupImg = document.getElementById('img-popup-inner');
    popup.classList.remove('show');
    popupImg.src = '';
    e.stopPropagation();
    };
    document.getElementById('img-popup').onclick = function(e) {
    if (e.target === this) {
        this.classList.remove('show');
        document.getElementById('img-popup-inner').src = '';
    }
    };
    document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
        var popup = document.getElementById('img-popup');
        popup.classList.remove('show');
        document.getElementById('img-popup-inner').src = '';
    }
    });

    /* ===== Mở hộp thoại chọn file ===== */
    function triggerUpload(inputId) {
    var el = document.getElementById(inputId);
    if (el) el.click();
    }

    /* ===== Dark mode ===== */
    document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem("darkmode") === "true") {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');
    }
    var themeBtn = document.getElementById('theme-btn');
    function syncDarkModeBtn() {
        var dark = document.body.classList.contains('dark');
        themeBtn.innerHTML = dark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
    }
    themeBtn.onclick = function() {
        var d = document.body.classList.toggle('dark');
        document.documentElement.classList.toggle('dark');
        localStorage.setItem("darkmode", d ? "true" : "false");
        syncDarkModeBtn();
    };
    syncDarkModeBtn();
    });
    </script>
</body>
</html>