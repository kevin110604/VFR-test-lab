<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="cache-control" content="no-store"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VFR Display</title>
  <style>
    :root {
      --bg: #0b0f14; --fg: #e6edf3; --accent:#ffe082; --muted:#8aa0a8;
      --late:#f87171; --due:#fbbf24; --must:#38bdf8; --active:#4ade80;
      --card:#10161b; --line:#1f2a33;
    }
    {% if not dark %}
    :root { --bg:#fffdfc; --fg:#25312b; --card:#fffdfc; --line:#d8d8cc; --muted:#6b6b6b; }
    {% endif %}

    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:500 18px/1.45 "Segoe UI", Inter, system-ui, -apple-system, Arial; }
    * { cursor: none !important; }
    .wrap { display:flex; flex-direction:column; height:100%; }

    .header {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 18px; border-bottom:1px solid var(--line); background:var(--card);
      position:sticky; top:0; z-index:2;
    }
    .header .title { font-weight:800; letter-spacing:.02em; }
    .header .ts { font-size:14px; color:var(--muted); }

    .summary {
      padding:10px 18px; background:var(--card); border-bottom:1px solid var(--line);
    }
    .summary table { width:100%; border-collapse:separate; border-spacing:0; }
    .summary th, .summary td { padding:8px 10px; text-align:center; border-bottom:1px solid var(--line); }
    .summary th { color:#b78e24; background:#fffbe80f; font-size:14px; letter-spacing:.04em; }
    .summary .late { color:var(--late); font-weight:800; }
    .summary .due { color:var(--due); font-weight:800; }
    .summary .must { color:var(--must); font-weight:800; }
    .summary .active { color:var(--active); font-weight:800; }

    .table-box { flex:1; overflow:hidden; padding:10px 18px 14px; }
    table#board { width:100%; border-collapse:collapse; table-layout:fixed; }
    #board th, #board td { border-bottom:1px solid var(--line); padding:10px 8px; text-align:center; }
    #board th { position:sticky; top:0; background:var(--card); font-size:15px; z-index:1; }
    #board td { font-size:18px; }
    #board .status { font-weight:800; -webkit-text-stroke:0.5px #0003; text-shadow:0 1px 2px #0006; letter-spacing:.03em; }
    #board .LATE { color:var(--late); }
    #board .DUE { color:var(--due); }
    #board .MUST { color:var(--must); }
    #board .ACTIVE { color:var(--active); }

    .footer {
      display:flex; align-items:center; justify-content:center; gap:18px;
      padding:8px 12px; border-top:1px solid var(--line); background:var(--card); font-size:14px; color:var(--muted);
    }

    /* chữ to hơn cho xa (có thể chỉnh) */
    @media (min-width:1400px){
      #board td { font-size:20px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">VFR – TEST LAB BOARD</div>
    <div class="ts" id="ts">—</div>
  </div>

  <!-- Bảng tổng trạng thái -->
  <div class="summary">
    <div style="overflow-x:auto;">
      <table id="sum">
        <thead>
          <tr>
            <th>TRẠNG THÁI</th>
            <th id="sum-head"></th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="late">LATE</td><td id="sum-late"></td></tr>
          <tr><td class="due">DUE</td><td id="sum-due"></td></tr>
          <tr><td class="must">MUST</td><td id="sum-must"></td></tr>
          <tr><td class="active">ACTIVE</td><td id="sum-active"></td></tr>
          <tr><td><b>TOTAL</b></td><td id="sum-total" style="font-weight:800;"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bảng report (auto phân trang) -->
  <div class="table-box">
    <div style="overflow:auto; height:100%;">
      <table id="board">
        <thead>
          <tr>
            <th style="width:18%;">REPORT#</th>
            <th style="width:22%;">ITEM#</th>
            <th style="width:18%;">TYPE OF</th>
            <th style="width:14%;">STATUS</th>
            <th style="width:14%;">LOG IN DATE</th>
            <th style="width:14%;">ETD</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <div>Trang <span id="page">1</span>/<span id="pages">1</span></div>
    <div>Auto refresh mỗi {{ refresh_sec }}s – lật trang mỗi {{ rotate_sec }}s</div>
  </div>
</div>

<script>
  const TOKEN = "{{ token }}";
  const PAGE_LEN = {{ page_len }};
  const ROTATE_SEC = {{ rotate_sec }};
  const REFRESH_SEC = {{ refresh_sec }};

  let data = { summary:[], reports:[], generated_at:"" };
  let page = 0, pages = 1;

  function fmt(x){ return (x==null||x==="") ? "" : x; }

  function renderSummary() {
    const s = data.summary || [];
    const head = document.getElementById('sum-head');
    const late = document.getElementById('sum-late');
    const due  = document.getElementById('sum-due');
    const must = document.getElementById('sum-must');
    const act  = document.getElementById('sum-active');
    const tot  = document.getElementById('sum-total');

    // Tạo dãy tiêu đề theo short code: TR | TT | ...
    head.textContent = s.map(x => x.short).join(' | ');
    late.textContent = s.map(x => x.late).join(' | ');
    due.textContent  = s.map(x => x.due).join(' | ');
    must.textContent = s.map(x => x.must).join(' | ');
    act.textContent  = s.map(x => x.active).join(' | ');
    tot.textContent  = s.map(x => x.total).join(' | ');

    // thời gian
    document.getElementById('ts').textContent = "Cập nhật: " + (data.generated_at || "");
  }

  function renderPage() {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = "";
    const arr = data.reports || [];
    pages = Math.max(1, Math.ceil(arr.length / PAGE_LEN));
    if (page >= pages) page = 0;
    const start = page * PAGE_LEN;
    const end   = Math.min(arr.length, start + PAGE_LEN);
    for (let i=start; i<end; i++){
      const r = arr[i];
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${fmt(r.report)}</td>
         <td>${fmt(r.item)}</td>
         <td>${fmt(r.type_of)}</td>
         <td><span class="status ${fmt(r.status)}">${fmt(r.status)}</span></td>
         <td>${fmt(r.log_date)}</td>
         <td>${fmt(r.etd)}</td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('page').textContent = (page+1);
    document.getElementById('pages').textContent = pages;
  }

  async function refreshData() {
    try{
      const res = await fetch(`/api/display_data?t=${encodeURIComponent(TOKEN)}`, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      data = json || {summary:[], reports:[], generated_at:""};
      renderSummary();
      renderPage();
    }catch(e){
      // giữ nguyên dữ liệu cũ nếu lỗi
    }
  }

  // Khởi chạy
  (async function(){
    await refreshData();
    setInterval(refreshData, REFRESH_SEC*1000);
    setInterval(()=>{ page = (page+1)%pages; renderPage(); }, ROTATE_SEC*1000);
  })();
</script>
</body>
</html>
