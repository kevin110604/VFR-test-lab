<!DOCTYPE html>
<html>
<head>
    <title>Test Request Form (TFR)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #e9efec;
            font-family: 'Inter', Arial, sans-serif;
            color: #25312b;
            margin: 0;
            transition: color 0.22s, background-color 0.21s;
        }
        .container-center {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            width: 100vw;
            box-sizing: border-box;
        }
        .box {
            background: #fffdfccf;
            border-radius: 22px;
            box-shadow: 0 4px 32px #4d665c44;
            max-width: 1200px;
            width: 100vw;
            margin: 32px 24px 32px 24px;
            padding: 40px 48px 38px 48px;
            animation: fadeGrow 0.7s;
            transition: background 0.22s, color 0.16s;
            text-align: left;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        @keyframes fadeGrow {0% {opacity:0;transform:scale(0.98);}100%{opacity:1;transform:scale(1);}}

        /* ID và LangBtn */
        .top-right-tools {
            position: absolute;
            top: 13px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 9px;
            z-index: 12;
        }
        .trq-id-label {
            font-weight: bold;
            color: #c49c48;
            font-size: 15.7px;
            background: rgba(255,255,255,0.75);
            border-radius: 10px;
            padding: 5px 14px 5px 13px;
            box-shadow: 0 1px 5px #c49c4820;
            margin-bottom: 0;
            margin-right: 0;
            white-space: nowrap;
        }
        #lang-btn {
            background: #ffe082;
            color: #35523A;
            border-radius: 100px;
            font-size: 15px;
            padding: 5px 14px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.10);
            cursor:pointer;
            min-width: 0;
            font-weight:600;
            display:flex;
            align-items:center;
            gap:7px;
            opacity:0.97;
            letter-spacing:0.03em;
            transition: background 0.16s, color 0.16s;
            height: 33px;
        }
        #lang-btn:hover { background: #c49c48; color: #fff; }
        body.dark #lang-btn {
            background: #374B4A; color: #ffe082;
            box-shadow: 0 2px 10px rgba(0,0,0,0.19);
        }
        body.dark #lang-btn:hover { background: #ffe082; color: #35523A;}
        body.dark .trq-id-label {
            background: #2f3e3d;
            color: #ffe082 !important;
        }
        /* Back home btn */
        .back-home-btn {
            position: absolute;
            left: 16px;
            top: 13px;
            background: #c49c48;
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13.5px;
            padding: 4px 12px 4px 9px;
            font-weight: 600;
            box-shadow: 0 1.5px 6px #bca96b18;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 10;
            letter-spacing: 0.01em;
            text-decoration: none;
            min-width: 0;
            height: 28px;
            line-height: 1.2;
            width: auto;
            transition: background 0.18s, color 0.16s, font-size 0.13s, padding 0.13s;
        }
        .back-home-btn i {
            font-size: 13px;
            margin-right: 2px;
        }
        .back-home-btn:hover {
            background: #35523A;
            color: #ffe082;
        }
        /* Tiêu đề cách xa nút */
        h2.text-title {
            margin-top: 36px !important;
            text-align: center;
        }
        @media (max-width: 900px) {
            .top-right-tools {
                top: 8px;
                right: 5px;
                gap: 6px;
            }
            .trq-id-label {
                font-size: 13.3px;
                padding: 3px 7px;
                border-radius: 8px;
            }
            #lang-btn {
                font-size: 13px;
                padding: 3px 8px;
                height: 25px;
                gap: 5px;
            }
            .back-home-btn {
                top: 7px;
                left: 6px;
                font-size: 12.2px;
                padding: 3px 8px 3px 6px;
                min-width: 0;
                height: 24px;
                gap: 3px;
                border-radius: 100px;
            }
            .back-home-btn i {
                font-size: 11.5px;
            }
            h2.text-title { margin-top: 34px !important; }
        }
        @media (max-width: 600px) {
            .top-right-tools {
                top: 5px;
                right: 2px;
                gap: 3px;
            }
            .trq-id-label {
                font-size: 12px;
                padding: 2px 4px;
                border-radius: 6px;
            }
            #lang-btn {
                font-size: 11.5px;
                padding: 2px 4px;
                height: 18px;
                gap: 2px;
            }
            .back-home-btn {
                font-size: 11.2px;
                padding: 2px 5px 2px 4px;
                min-width: 0;
                height: 18px;
                gap: 2px;
            }
            .back-home-btn i {
                font-size: 10px;
            }
            h2.text-title { margin-top: 28px !important; font-size: 15.5px; }
        }
        .lab-info-box {
            margin-bottom: 18px;
            background: #fffbe8 !important;
            border: 2px solid #ffe082;
            border-radius: 13px;
            padding: 18px 16px;
            box-shadow: 0 3px 14px #f7cf3a33;
            font-size: 15.5px;
            line-height: 1.7;
            color: #775d17;
        }
        .lab-info-title {
            font-weight: bold;
            font-size: 18px;
            color: #c49c48;
            margin-bottom: 8px;
        }
        .error { color: #e33; font-size: 16px; text-align: center; margin-bottom: 16px; }
        .has-error input,
        .has-error select,
        .has-error textarea {
            border-color: #e33 !important;
            background: #fff2f2 !important;
        }
        .error-msg {
            color: #e33;
            font-size: 14px;
            margin-top: 2px;
            text-align: left;
            width: 100%;
        }
        label {
            font-weight: 600;
            color: #c49c48;
            font-size: 17px;
            margin-bottom: 4px;
            letter-spacing: 0.03em;
            display: block;
        }
        .required { color: #e33; }
        .form-group {
            margin-bottom: 14px;
            width: 100%;
        }
        textarea,
        input[type="text"], input[type="number"], input[type="date"] {
            font-size: 16.3px;
            padding: 9px 14px;
            border-radius: 8px;
            border: 1.3px solid #4d665c;
            background: #f9f8f1;
            color: #25312b;
            width: 100%;
            font-family: 'Inter', Arial, sans-serif;
            transition: background 0.16s, color 0.13s, border-color 0.16s;
            text-align:left;
            margin-bottom: 3px;
            box-sizing: border-box;
        }
        textarea { resize: vertical; }
        .input-na-wrap { display: flex; align-items: center; width: 100%; gap: 10px; flex-wrap: wrap;}
        .na-checkbox { display: flex; align-items: center; gap: 6px; margin-left: 7px; min-width: 70px;}
        .radio-row, .checkbox-row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            margin-top: 7px;
            margin-bottom: 7px;
        }
        .radio-row label, .checkbox-row label {
            font-weight: 500;
            font-size:15px;
            margin-bottom:0;
            color: #35523A;
            letter-spacing:0.01em;
            cursor:pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .na-label { font-weight: 400; color: #888; margin-left: 6px; }
        button[type="submit"] {
            background: #c49c48;
            color: #fff;
            font-size: 18px;
            padding: 13px 0;
            border-radius: 10px;
            border: none;
            width: 100%;
            font-weight: bold;
            font-family: 'Inter', Arial, sans-serif;
            box-shadow: 0 2px 10px #c49c4822;
            cursor: pointer;
            margin: 17px 0 0 0;
            transition: background 0.14s, color 0.16s;
        }
        button[type="submit"]:hover { background: #35523A; color: #ffe082;}
        .modern-form-grid {
            display: flex;
            flex-direction: column;
            gap: 26px;
        }
        .form-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 16px #4d665c1a;
            padding: 30px 28px 24px 28px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-card-title {
            font-size: 18.5px;
            font-weight: 700;
            color: #35523A;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 9px;
            letter-spacing: 0.01em;
        }
        .form-row-2 {
            display: flex;
            gap: 24px;
            width: 100%;
        }
        .form-row-2 > .form-group {
            flex: 1 1 0;
            margin-bottom: 10px;
        }
        .form-row-2 > .form-group label {
            margin-bottom: 4px;
        }
        /* Test status row nằm 1 hàng ngang cả mobile/desktop */
        .test-status-row {
            flex-wrap: nowrap !important;
            gap: 10px !important;
            width: 100%;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        .test-status-row label {
            min-width: unset;
            white-space: nowrap;
        }
        .test-status-row .nth-label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 0;
        }
        .input-nth {
            width: 48px !important;
            min-width: 36px !important;
            font-size: 15px;
            padding: 5px 4px !important;
            margin-left: 0;
            border-radius: 6px;
            border: 1.1px solid #c49c48;
            background: #f9f8f1;
            color: #25312b;
            outline: none;
            transition: border 0.16s, background 0.16s;
            text-align: center;
        }
        .input-nth:disabled {
            background: #e0ded6 !important;
            color: #bcbcb3 !important;
            border-color: #dad8bc !important;
            cursor: not-allowed;
        }
        body.dark .input-nth {
            background: #31423d;
            color: #ffe082;
            border-color: #ffe082;
        }
        body.dark .input-nth:disabled {
            background: #38433d !important;
            color: #8b917d !important;
            border-color: #4c615f !important;
        }
        .input-date {
            max-width: 150px;
            min-width: 90px;
            width: 100%;
            display: inline-block;
        }
        @media (max-width: 900px) {
            .modern-form-grid { gap: 14px; }
            .form-card { padding: 16px 8px 10px 8px; }
            .form-card-title { font-size: 14.8px; margin-bottom: 8px;}
            .form-row-2 { flex-direction: column; gap: 0;}
            .lab-info-box { font-size: 13.7px; }
            .form-card-title { font-size: 13.3px; }
            .form-row-2 { gap: 0; }
            .form-group { margin-bottom: 10px; }
            .input-date { max-width: 110px; min-width: 60px; }
        }
        @media (max-width: 600px) {
            html, body {
                padding: 0;
                margin: 0;
                width: 100vw;
                overflow-x: hidden;
            }
            .container-center {
                min-height: unset;
                align-items: flex-start;
                width: 100vw;
                padding: 0;
                margin: 0;
            }
            .box {
                max-width: 99vw !important;
                width: 99vw !important;
                min-width: 0 !important;
                margin: 3vw 0 3vw 0;
                padding: 6vw 2vw 5vw 2vw;
                border-radius: 11px;
                box-shadow: 0 1.5px 8px #4d665c1a;
                background: #fffdfccf;
                flex-direction: column;
            }
            .error-msg { font-size: 12px; }
            h2.text-title { font-size: 15.5px; margin-top: 28px !important;}
            .form-row-2 { gap: 0; }
            .input-date { max-width: 88px; min-width: 55px; }
            .test-status-row { gap: 8px !important; }
        }
        body.dark, .dark {
            color: #F1F1EB !important;
            background-color: #1f2a29;
        }
        body.dark .box {
            background: #374B4A !important;
            color: #F1F1EB !important;
            box-shadow: 0 4px 32px #000a;
        }
        body.dark .form-card {
            background: #2f3e3d !important;
            color: #f1f1eb !important;
            box-shadow: 0 4px 16px #000a;
        }
        body.dark h2,
        body.dark .form-card-title,
        body.dark label {
            color: #ffe082 !important;
        }
        body.dark input,
        body.dark textarea,
        body.dark select {
            background: #31423d !important;
            color: #f1f1eb !important;
            border-color: #4c615f !important;
        }
        body.dark input[readonly] {
            background: #2f3e3d !important;
            color: #aab8b7 !important;
        }
        body.dark .lab-info-box {
            background: #fffbe8 !important;
            color: #775d17 !important;
            border-color: #ffe082 !important;
        }
        #theme-btn {
            position:fixed; right:24px; bottom:26px; z-index:11001;
            background: #4C615F; color: #fff;
            border-radius: 100px; font-size: 19px;
            padding: 6px 12px; border:none; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
            cursor:pointer; height: 42px; width: 42px; min-width:38px;
            display:flex;align-items:center;justify-content:center;opacity:0.96;
            transition: background 0.16s, color 0.16s;
        }
        #theme-btn:hover { background: #35523A; color: #ffe082; opacity:1; }
    </style>
</head>
<body>
    <button id="theme-btn" title="Toggle Dark/Light mode"><i class="fa fa-moon"></i></button>
    <div class="container-center">
    <div class="box">
        <div class="top-right-tools">
            <div class="trq-id-label">
                <span class="text-id-label">ID:</span> {{ form_data.get('trq_id', 'Đang tạo...') }}
            </div>
            <button id="lang-btn" title="Đổi ngôn ngữ/Change language"><i class="fa fa-language"></i> <span>EN</span></button>
        </div>
        <a href="/" class="back-home-btn"><i class="fa fa-chevron-left"></i> <span class="text-home">Trang chủ</span></a>
        <h2 class="text-title">TẠO TEST REQUEST FORM</h2>
        <div class="lab-info-box">
            <div class="lab-info-title text-lab-info-title"><i class="fa fa-clock" style="margin-right: 6px;"></i><span>Lab Information</span></div>
            <div><strong class="text-working-hours-title">Working hours:</strong> <span class="text-working-hours-detail">Mon - Sat: 8:00 – 16:45</span></div>
            <div><strong class="text-leadtime-title">Standard Leadtime:</strong></div>
            <div style="margin-left: 14px;">
                • <span class="text-construction-test">CONSTRUCTION - TRANSIT TEST:</span> <span class="text-construction-days">3 working days</span><br>
                • <span class="text-material-test">MATERIAL - FINISHING TEST:</span> <span class="text-material-days">4–5 working days</span>
            </div>
            <div style="margin-top: 6px;"><em class="text-cutoff">* Cut off time: 15:00</em></div>
        </div>
        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}
        <form method="POST" action="">
            <input type="hidden" name="trq_id" value="{{ form_data.get('trq_id', '') }}">
            <div class="modern-form-grid">
                <!-- Card 1: Người gửi -->
                <div class="form-card">
                    <div class="form-card-title"><i class="fa fa-user"></i> <span class="text-sender">Thông tin người gửi</span></div>
                    <div class="form-row-2">
                        <div class="form-group {% if 'requestor' in missing_fields %}has-error{% endif %}">
                            <label class="text-requestor">Người yêu cầu <span class="required">*</span></label>
                            <input type="text" name="requestor" required value="{{ form_data.get('requestor', '') }}">
                            {% if 'requestor' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập</div>{% endif %}
                        </div>
                        <div class="form-group {% if 'employee_id' in missing_fields %}has-error{% endif %}">
                            <label class="text-employee-id">Mã nhân viên <span class="required">*</span></label>
                            <input type="text" name="employee_id" required value="{{ form_data.get('employee_id', '') }}">
                            {% if 'employee_id' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập</div>{% endif %}
                        </div>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group {% if 'department' in missing_fields %}has-error{% endif %}">
                            <label class="text-department">Phòng ban <span class="required">*</span></label>
                            <input type="text" name="department" required value="{{ form_data.get('department', '') }}">
                            {% if 'department' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập</div>{% endif %}
                        </div>
                        <div class="form-group {% if 'request_date' in missing_fields %}has-error{% endif %}">
                            <label class="text-request-date">Ngày yêu cầu <span class="required">*</span></label>
                            <input type="date" name="request_date" required value="{{ form_data.get('request_date', '') }}" class="input-date" autocomplete="off" inputmode="none">
                            {% if 'request_date' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập</div>{% endif %}
                        </div>
                    </div>
                </div>
                <!-- Card 2: Thông tin mẫu -->
                <div class="form-card">
                    <div class="form-card-title"><i class="fa fa-cube"></i> <span class="text-sample-info">Thông tin mẫu test</span></div>
                    <div class="form-row-2">
                        <div class="form-group {% if 'sample_description' in missing_fields %}has-error{% endif %}">
                            <label class="text-sample-desc">Mô tả mẫu <span class="required">*</span></label>
                            <div class="input-na-wrap">
                                <input type="text" name="sample_description" style="flex:1 1 0;" id="sample_description_input"
                                    value="{{ '' if form_data.get('sample_description_na') else form_data.get('sample_description','') }}">
                                <span class="na-checkbox">
                                    <input type="checkbox" name="sample_description_na" value="1" id="sample_description_na"
                                        {% if form_data.get('sample_description_na') %}checked{% endif %}>
                                    <span class="text-na">N/A</span>
                                </span>
                            </div>
                            {% if 'sample_description' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập/chọn N/A</div>{% endif %}
                        </div>
                        <div class="form-group">
                            <label class="text-item-code">Mã Item/Fin <span class="required">*</span></label>
                            <div class="input-na-wrap">
                                <input type="text" name="item_code" style="flex:1 1 0;" id="item_code_input"
                                    value="{{ '' if form_data.get('item_code_na') else form_data.get('item_code','') }}">
                                <span class="na-checkbox">
                                    <input type="checkbox" name="item_code_na" value="1" id="item_code_na"
                                        {% if form_data.get('item_code_na') %}checked{% endif %}>
                                    <span class="text-na">N/A</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label class="text-supplier">Nhà cung cấp <span class="required">*</span></label>
                            <div class="input-na-wrap">
                                <input type="text" name="supplier" style="flex:1 1 0;" id="supplier_input"
                                    value="{{ '' if form_data.get('supplier_na') else form_data.get('supplier','') }}">
                                <span class="na-checkbox">
                                    <input type="checkbox" name="supplier_na" value="1" id="supplier_na"
                                        {% if form_data.get('supplier_na') %}checked{% endif %}>
                                    <span class="text-na">N/A</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="text-subcon">Thầu phụ <span class="required">*</span></label>
                            <div class="input-na-wrap">
                                <input type="text" name="subcon" style="flex:1 1 0;" id="subcon_input"
                                    value="{{ '' if form_data.get('subcon_na') else form_data.get('subcon','') }}">
                                <span class="na-checkbox">
                                    <input type="checkbox" name="subcon_na" value="1" id="subcon_na"
                                        {% if form_data.get('subcon_na') %}checked{% endif %}>
                                    <span class="text-na">N/A</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Card 3: Chi tiết test -->
                <div class="form-card">
                    <div class="form-card-title"><i class="fa fa-clipboard-list"></i> <span class="text-test-detail">Chi tiết test</span></div>
                    <div class="form-group {% if 'test_group' in missing_fields %}has-error{% endif %}">
                        <label class="text-test-group">Chọn nhóm test<span class="required">*</span></label>
                        <div class="radio-row">
                            <label>
                                <input type="radio" name="test_group" value="CONSTRUCTION TEST"
                                    {% if form_data.get('test_group') == 'CONSTRUCTION TEST' %}checked{% endif %}>
                                CONSTRUCTION TEST
                            </label>
                            <label>
                                <input type="radio" name="test_group" value="TRANSIT TEST"
                                    {% if form_data.get('test_group') == 'TRANSIT TEST' %}checked{% endif %}>
                                TRANSIT TEST
                            </label>
                            <label>
                                <input type="radio" name="test_group" value="MATERIAL TEST"
                                    {% if form_data.get('test_group') == 'MATERIAL TEST' %}checked{% endif %}>
                                MATERIAL TEST
                            </label>
                            <label>
                                <input type="radio" name="test_group" value="FINISHING TEST"
                                    {% if form_data.get('test_group') == 'FINISHING TEST' %}checked{% endif %}>
                                FINISHING TEST
                            </label>
                            <label>
                                <input type="radio" name="test_group" value="ENVIRONMENTAL TEST"
                                    {% if form_data.get('test_group') == 'ENVIRONMENTAL TEST' %}checked{% endif %}>
                                ENVIRONMENTAL TEST
                            </label>
                        </div>
                        {% if 'test_group' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc chọn</div>{% endif %}
                    </div>
                    
                    <!-- Block Finishing QA/LINE TEST -->
                    <div id="finishing-detail-row" style="display:none; margin-top:14px;">
                        <label><span style="color:#c49c48;font-weight:600;" class="text-finishing-type-label">Chọn loại Finishing Test <span class="required">*</span></span></label>
                        <div class="radio-row" style="margin-top:8px;">
                            <label>
                                <input type="radio" name="finishing_type" value="QA TEST"
                                    {% if form_data.get('finishing_type') == 'QA TEST' %}checked{% endif %}>
                                <span class="text-qa-test">QA TEST</span>
                            </label>
                            <label>
                                <input type="radio" name="finishing_type" value="LINE TEST"
                                    {% if form_data.get('finishing_type') == 'LINE TEST' %}checked{% endif %}>
                                <span class="text-line-test">LINE TEST</span>
                            </label>
                        </div>
                        <div id="finishing_type_error" class="error-msg" style="display:none;">Bắt buộc chọn QA TEST hoặc LINE TEST</div>
                        <div id="material-type-row" style="display:none; margin-top:10px;">
                            <label><span style="color:#c49c48;font-weight:600;" class="text-material-type-label">Chọn loại vật liệu <span class="required">*</span></span></label>
                            <div class="radio-row" style="margin-top:8px;">
                                <label>
                                    <input type="radio" name="material_type" value="WOOD">
                                    <span class="text-wood">WOOD</span>
                                </label>
                                <label>
                                    <input type="radio" name="material_type" value="METAL">
                                    <span class="text-metal">METAL</span>
                                </label>
                            </div>
                            <div id="material_type_error" class="error-msg" style="display:none;">Bắt buộc chọn Wood hoặc Metal</div>
                        </div>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group {% if 'test_status' in missing_fields %}has-error{% endif %}">
                            <label class="text-test-status">Lần test <span class="required">*</span></label>
                            <div class="radio-row test-status-row">
                                <label>
                                    <input type="radio" name="test_status" value="1st" required
                                        {% if form_data.get('test_status') == '1st' %}checked{% endif %}>
                                    <span class="text-1st">Lần 1</span>
                                </label>
                                <label>
                                    <input type="radio" name="test_status" value="2nd" required
                                        {% if form_data.get('test_status') == '2nd' %}checked{% endif %}>
                                    <span class="text-2nd">Lần 2</span>
                                </label>
                                <label>
                                    <input type="radio" name="test_status" value="3rd" required
                                        {% if form_data.get('test_status') == '3rd' %}checked{% endif %}>
                                    <span class="text-3rd">Lần 3</span>
                                </label>
                                <label class="nth-label">
                                    <input type="radio" name="test_status" value="nth" required
                                        {% if form_data.get('test_status') not in ['1st','2nd','3rd','',None] %}checked{% endif %}>
                                    <span class="text-nth">Lần ...</span>
                                    <input type="number" class="input-nth" name="test_status_nth" min="4" placeholder="số"
                                        {% if form_data.get('test_status') not in ['1st','2nd','3rd','',None] %}
                                            value="{{ form_data.get('test_status').replace('th','') }}"
                                        {% else %}
                                            disabled
                                        {% endif %}
                                    >
                                </label>
                            </div>
                            {% if 'test_status' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc chọn</div>{% endif %}
                        </div>
                        <div class="form-group {% if 'furniture_testing' in missing_fields %}has-error{% endif %}">
                            <label class="text-furniture-test">Loại sản phẩm <span class="required">*</span></label>
                            <div class="radio-row">
                                <label><input type="radio" name="furniture_testing" value="Indoor"
                                    {% if form_data.get('furniture_testing') == 'Indoor' %}checked{% endif %}> INDOOR</label>
                                <label><input type="radio" name="furniture_testing" value="Outdoor"
                                    {% if form_data.get('furniture_testing') == 'Outdoor' %}checked{% endif %}> OUTDOOR</label>
                            </div>
                            {% if 'furniture_testing' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc chọn</div>{% endif %}
                        </div>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group {% if 'quantity' in missing_fields %}has-error{% endif %}">
                            <label class="text-quantity">Số lượng <span class="required">*</span></label>
                            <input type="number" name="quantity" min="1" required value="{{ form_data.get('quantity','') }}">
                            {% if 'quantity' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc nhập</div>{% endif %}
                        </div>
                    </div>
                </div>
                <!-- Card 4 giữ nguyên -->
                <div class="form-card">
                    <div class="form-card-title"><i class="fa fa-cog"></i> <span class="text-option">Tùy chọn</span></div>
                    <div class="form-group {% if 'sample_return' in missing_fields %}has-error{% endif %}">
                        <label class="text-sample-return">Trả mẫu <span class="required">*</span></label>
                        <div class="radio-row">
                            <label>
                                <input type="radio" name="sample_return" value="Yes"
                                    {% if form_data.get('sample_return') == 'Yes' %}checked{% endif %}> <span class="text-yes">Có</span>
                            </label>
                            <label>
                                <input type="radio" name="sample_return" value="No"
                                    {% if form_data.get('sample_return') == 'No' %}checked{% endif %}> <span class="text-no">Không</span>
                            </label>
                        </div>
                        {% if 'sample_return' in missing_fields %}<div class="error-msg text-required-msg">Bắt buộc chọn</div>{% endif %}
                        <div class="sample-return-alert" style="margin-top: 8px; background: #fff0cc; color: #b85012; font-weight: bold; border-radius: 9px; border: 1.6px solid #f7bc3d; padding: 9px 12px; font-size: 15.2px; text-align: center;">
                            <i class="fa fa-exclamation-triangle" style="color: #ee9100;"></i>
                            <span class="text-sample-destroy">
                                Nếu không yêu cầu trả mẫu, mẫu sẽ được <span style="color:#d32f2f;">hủy sau 30 ngày</span>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="text-remark">Ghi chú (nếu có)</label>
                        <textarea name="remark" rows="3" placeholder="Ghi chú thêm nếu cần..." class="text-remark-placeholder">{{ form_data.get('remark', '') }}</textarea>
                    </div>
                    <button type="submit"><i class="fa fa-file-export"></i> <span class="text-export-btn">Xuất TFR</span></button>
                </div>
            </div>
        </form>
    </div>
    </div>
    <script>
        // ======== SYNC với server ========
        function setPref(key, value) {
            localStorage.setItem("vfr-" + key, value);
            fetch('/set_pref', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, value })
            }).catch(()=>{});
        }

        // ===================== DARKMODE TOGGLE =====================
        let dark = localStorage.getItem("vfr-darkmode") === "1";
        function applyDark(b) {
            document.body.classList.toggle("darkmode", b);
            let btn = document.getElementById('theme-btn');
            if (btn) btn.innerHTML = b ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
            setPref("darkmode", b ? "1" : "0");
        }
        document.addEventListener('DOMContentLoaded', function() {
            applyDark(dark);
            let themeBtn = document.getElementById('theme-btn');
            if (themeBtn) {
                themeBtn.onclick = function() {
                    dark = !dark;
                    applyDark(dark);
                };
            }
        });

        // ===================== LANGUAGE TOGGLE (multi-language, có bổ sung) =====================
        let lang = localStorage.getItem("vfr-lang") || "vi";
        const LANG = {
            vi: {
                "text-title": "TẠO PHIẾU YÊU CẦU THỬ NGHIỆM",
                "text-home": "Trang chủ",
                "text-lab-info-title": "Thông tin Lab",
                "text-working-hours-title": "Thời gian làm việc:",
                "text-working-hours-detail": "Thứ 2 - Thứ 7: 8:00 – 16:45",
                "text-leadtime-title": "Thời gian trả kết quả:",
                "text-construction-test": "CONSTRUCTION - TRANSIT TEST:",
                "text-construction-days": "3 ngày làm việc",
                "text-material-test": "MATERIAL - FINISHING TEST:",
                "text-material-days": "4–5 ngày làm việc",
                "text-cutoff": "* Nhận mẫu đến: 15:00",
                "text-id-label": "Mã:",
                "text-sender": "Thông tin người gửi",
                "text-requestor": "Người yêu cầu <span class='required'>*</span>",
                "text-employee-id": "Mã nhân viên <span class='required'>*</span>",
                "text-department": "Phòng ban <span class='required'>*</span>",
                "text-request-date": "Ngày yêu cầu <span class='required'>*</span>",
                "text-sample-info": "Thông tin mẫu test",
                "text-sample-desc": "Mô tả mẫu <span class='required'>*</span>",
                "text-na": "N/A",
                "text-item-code": "Mã Item/Fin <span class='required'>*</span>",
                "text-supplier": "Nhà cung cấp <span class='required'>*</span>",
                "text-subcon": "Thầu phụ <span class='required'>*</span>",
                "text-test-detail": "Chi tiết test",
                "text-test-group": "Chọn nhóm test<span class='required'>*</span>",
                "text-1st": "Lần 1",
                "text-2nd": "Lần 2",
                "text-3rd": "Lần 3",
                "text-nth": "Lần ...",
                "text-test-status": "Lần test <span class='required'>*</span>",
                "text-furniture-test": "Loại sản phẩm <span class='required'>*</span>",
                "text-quantity": "Số lượng <span class='required'>*</span>",
                "text-option": "Tùy chọn",
                "text-sample-return": "Trả mẫu <span class='required'>*</span>",
                "text-yes": "Có",
                "text-no": "Không",
                "text-sample-destroy": "Nếu không yêu cầu trả mẫu, mẫu sẽ được <span style='color:#d32f2f;'>hủy sau 30 ngày</span>",
                "text-remark": "Ghi chú (nếu có)",
                "text-remark-placeholder": "Nhập ghi chú thêm nếu cần...",
                "text-export-btn": "Xuất TFR",
                "text-required-msg": "Bắt buộc nhập/chọn",
                // Dịch bổ sung
                "text-finishing-type-label": "Chọn loại Finishing Test <span class='required'>*</span>",
                "text-qa-test": "QA TEST",
                "text-line-test": "LINE TEST",
                "text-material-type-label": "Chọn loại vật liệu <span class='required'>*</span>",
                "text-wood": "GỖ",
                "text-metal": "KIM LOẠI"
            },
            en: {
                "text-title": "CREATE TEST REQUEST FORM",
                "text-home": "Home",
                "text-lab-info-title": "Lab Information",
                "text-working-hours-title": "Working hours:",
                "text-working-hours-detail": "Mon - Sat: 8:00 – 16:45",
                "text-leadtime-title": "Standard Leadtime:",
                "text-construction-test": "CONSTRUCTION - TRANSIT TEST:",
                "text-construction-days": "3 working days",
                "text-material-test": "MATERIAL - FINISHING TEST:",
                "text-material-days": "4–5 working days",
                "text-cutoff": "* Cut off time: 15:00",
                "text-id-label": "ID:",
                "text-sender": "Sender information",
                "text-requestor": "Requestor <span class='required'>*</span>",
                "text-employee-id": "Employee ID <span class='required'>*</span>",
                "text-department": "Department <span class='required'>*</span>",
                "text-request-date": "Request Date <span class='required'>*</span>",
                "text-sample-info": "Sample information",
                "text-sample-desc": "Sample description <span class='required'>*</span>",
                "text-na": "N/A",
                "text-item-code": "Item/Fin Code <span class='required'>*</span>",
                "text-supplier": "Supplier <span class='required'>*</span>",
                "text-subcon": "Subcon <span class='required'>*</span>",
                "text-test-detail": "Test details",
                "text-test-group": "Choose group test<span class='required'>*</span>",
                "text-1st": "1ST",
                "text-2nd": "2ND",
                "text-3rd": "3RD",
                "text-nth": "...th",
                "text-test-status": "Test status <span class='required'>*</span>",
                "text-furniture-test": "Furniture testing <span class='required'>*</span>",
                "text-quantity": "Quantity <span class='required'>*</span>",
                "text-option": "Options",
                "text-sample-return": "Sample return <span class='required'>*</span>",
                "text-yes": "Yes",
                "text-no": "No",
                "text-sample-destroy": "If tested/remaining samples are <u>not requested to return</u>, they will be <span style='color:#d32f2f;'>destroyed after 30 days</span>",
                "text-remark": "Remark (if any)",
                "text-remark-placeholder": "Add remark if needed...",
                "text-export-btn": "Export TFR",
                "text-required-msg": "Required",
                // Dịch bổ sung
                "text-finishing-type-label": "Choose Finishing Test type <span class='required'>*</span>",
                "text-qa-test": "QA TEST",
                "text-line-test": "LINE TEST",
                "text-material-type-label": "Choose material type <span class='required'>*</span>",
                "text-wood": "WOOD",
                "text-metal": "METAL"
            }
        };
        function applyLang(lang) {
            for(const key in LANG[lang]) {
                let els = document.getElementsByClassName(key);
                for(let i=0; i<els.length; i++) {
                    if (els[i].tagName === "INPUT" || els[i].tagName === "TEXTAREA") {
                        if (key === "text-remark-placeholder") els[i].placeholder = LANG[lang][key];
                    } else {
                        els[i].innerHTML = LANG[lang][key];
                    }
                }
            }
            let langBtn = document.getElementById('lang-btn');
            if (langBtn && langBtn.children[1]) {
                langBtn.children[1].innerText = lang === "en" ? "VI" : "EN";
            }
            setPref("lang", lang);
        }
        document.addEventListener('DOMContentLoaded', function() {
            applyLang(lang);
            let langBtn = document.getElementById('lang-btn');
            if (langBtn) {
                langBtn.onclick = function() {
                    lang = (lang === "en" ? "vi" : "en");
                    applyLang(lang);
                };
            }
        });

        // =============== N/A input logic ===============
        function handleNaInput(textId, naId) {
            const input = document.getElementById(textId);
            const checkbox = document.getElementById(naId);
            checkbox.addEventListener("change", function() {
                if(this.checked) {
                    input.value = "";
                    input.setAttribute("disabled", "disabled");
                    input.removeAttribute("required");
                } else {
                    input.removeAttribute("disabled");
                    input.setAttribute("required", "required");
                }
            });
            input.addEventListener("input", function() {
                if(this.value.trim().length > 0) checkbox.checked = false;
            });
        }
        handleNaInput("sample_description_input", "sample_description_na");
        handleNaInput("item_code_input", "item_code_na");
        handleNaInput("supplier_input", "supplier_na");
        handleNaInput("subcon_input", "subcon_na");

        // =============== Test status nth input enable/disable ===============
        function nthRadioHandler() {
            let nthRadio = document.querySelector('input[name="test_status"][value="nth"]');
            let nthInput = document.querySelector('.input-nth');
            let radios = document.querySelectorAll('input[name="test_status"]');
            if(!nthRadio || !nthInput) return;
            function update() {
                if(nthRadio.checked) {
                    nthInput.disabled = false;
                    nthInput.focus();
                } else {
                    nthInput.disabled = true;
                }
            }
            radios.forEach(radio => radio.addEventListener('change', update));
            update();
        }
        nthRadioHandler();

        // =============== Scroll đến trường lỗi đầu tiên nếu có lỗi ===============
        {% if missing_fields %}
        document.addEventListener("DOMContentLoaded", function() {
            var firstError = document.querySelector('.has-error input, .has-error select, .has-error textarea');
            if (firstError) {
                firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
                firstError.focus();
            }
        });
        {% endif %}

        // =============== FINISHING TEST: Show/hide QA/LINE  ===============
        function updateFinishingTypeRow() {
            let testGroup = document.querySelector('input[name="test_group"]:checked');
            let finishingRow = document.getElementById('finishing-detail-row');
            if (testGroup && testGroup.value === 'FINISHING TEST') {
                finishingRow.style.display = '';
            } else {
                finishingRow.style.display = 'none';
                let radios = finishingRow.querySelectorAll('input[name="finishing_type"]');
                radios.forEach(r => r.checked = false);
                document.getElementById('finishing_type_error').style.display = 'none';

                // Ẩn luôn block vật liệu
                let materialRow = document.getElementById('material-type-row');
                materialRow.style.display = 'none';
                let radios2 = materialRow.querySelectorAll('input[name="material_type"]');
                radios2.forEach(r => r.checked = false);
                document.getElementById('material_type_error').style.display = 'none';
            }
        }
        let testGroupRadios = document.querySelectorAll('input[name="test_group"]');
        testGroupRadios.forEach(radio => radio.addEventListener('change', updateFinishingTypeRow));
        updateFinishingTypeRow();

        // =============== Hiện/ẩn lựa chọn Wood/Metal khi chọn QA/LINE TEST ===============
        function updateMaterialTypeRow() {
            let finishingType = document.querySelector('input[name="finishing_type"]:checked');
            let materialRow = document.getElementById('material-type-row');
            if (finishingType && (finishingType.value === 'QA TEST' || finishingType.value === 'LINE TEST')) {
                materialRow.style.display = '';
            } else {
                materialRow.style.display = 'none';
                let radios = materialRow.querySelectorAll('input[name="material_type"]');
                radios.forEach(r => r.checked = false);
                document.getElementById('material_type_error').style.display = 'none';
            }
        }
        let finishingTypeRadios = document.querySelectorAll('input[name="finishing_type"]');
        finishingTypeRadios.forEach(radio => radio.addEventListener('change', updateMaterialTypeRow));
        updateMaterialTypeRow();

        // =============== Bắt buộc phải chọn Wood/Metal nếu QA/LINE TEST ===============
        document.querySelector('form').addEventListener('submit', function(e) {
            let testGroup = document.querySelector('input[name="test_group"]:checked');
            let finishingType = document.querySelector('input[name="finishing_type"]:checked');
            if (testGroup && testGroup.value === 'FINISHING TEST' && finishingType &&
                (finishingType.value === 'QA TEST' || finishingType.value === 'LINE TEST')) {
                let materialChecked = document.querySelector('input[name="material_type"]:checked');
                if (!materialChecked) {
                    e.preventDefault();
                    document.getElementById('material_type_error').style.display = '';
                    document.getElementById('material-type-row').scrollIntoView({behavior:'smooth', block:'center'});
                } else {
                    document.getElementById('material_type_error').style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>