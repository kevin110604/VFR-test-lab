<!DOCTYPE html>
<html>
<head>
    <title>VFR - Tra cứu sản phẩm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --main-bg: #fffdfc;
        --main-card: #fffdfccf;
        --main-text: #333;
        --main-th: #4d665c;
        --main-border: #4d665c55;
        --main-btn: #c49c48;
        --main-btn-hover: #35523A;
        --main-btn-text: #fff;
        --main-btn-hover-text: #ffe082;
        --main-btn-dark: #97722a;
        --main-btn-dark-hover: #333f20;
    }
    body.darkmode {
        --main-bg: #2b3938;
        --main-card: #374B4A;
        --main-text: #f6f6ef;
        --main-th: #ffe082;
        --main-border: #263d3a;
        --main-btn: #97722a;
        --main-btn-hover: #35523A;
        --main-btn-text: #fff;
        --main-btn-hover-text: #ffe082;
    }
    body {
        font-family: 'Segoe UI', sans-serif;
        background-color: var(--main-bg);
        margin: 0;
        padding: 0;
        color: var(--main-text);
        transition: background 0.5s, color 0.4s;
    }
    .center-form {
        max-width: 820px;
        margin: 60px auto;
        background: var(--main-card);
        border-radius: 22px;
        box-shadow: 0 4px 28px var(--main-border);
        padding: 40px;
        position: relative; /* để #mode-chip bám vào */
    }
    h2 {
        text-align: center;
        font-size: 28px;
        color: var(--main-th);
        margin-bottom: 30px;
    }
    /* ==== REQUEST BUTTONS HÀNG NGANG ==== */
    .request-menu-row {
        display: flex;
        flex-direction: row;
        gap: 14px;
        justify-content: center;
        margin: 10px auto 19px auto;
        max-width: 99vw;
        width: 100%;
        flex-wrap: wrap;
    }
    .request-btn {
        flex: 1 1 0;
        min-width: 120px;
        max-width: 220px;
        text-align: center;
        background: var(--main-btn);
        color: var(--main-btn-text);
        font-size: 17px;
        font-weight: 600;
        border: none;
        border-radius: 13px;
        padding: 11px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 2px 11px #c49c4840;
        text-decoration: none;
        transition: background 0.16s, color 0.15s, transform 0.12s, box-shadow 0.15s;
        cursor: pointer;
        white-space: nowrap;
    }
    .request-btn:hover {
        background: var(--main-btn-hover);
        color: var(--main-btn-hover-text);
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 4px 18px #c49c4844;
    }
    body.darkmode .request-btn {
        background: var(--main-btn);
        color: var(--main-btn-text);
    }
    body.darkmode .request-btn:hover {
        background: var(--main-btn-hover);
        color: var(--main-btn-hover-text);
    }
    /* ==== TÌM ITEM: LUÔN 1 HÀNG NGANG ==== */
    .item-search-form-modern {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 7px;
        background: #fffbe8;
        border-radius: 9px;
        box-shadow: 0 1px 5px #f7cf3a15;
        padding: 3px 7px;
        margin: 16px auto 12px auto;
        max-width: 430px;
        width: 90%;
    }
    .item-search-form-modern label {
        display: flex;
        align-items: center;
        font-size: 14.7px;
        font-weight: 600;
        color: #b78e24;
        margin: 0 2px 0 0;
        white-space: nowrap;
        min-width: 68px;
    }
    .item-search-form-modern input {
        font-size: 15px;
        border-radius: 6px;
        border: 1.2px solid #d9bc6d;
        background: #fff;
        color: #444;
        font-weight: 600;
        padding: 5px 11px;
        flex: 1 1 0;
        min-width: 80px;
        max-width: 999px;
        width: 100%;
        margin-right: 2px;
        transition: border 0.13s;
        height: 32px;
    }
    .item-search-form-modern input:focus { border-color: #c49c48; outline: none; }
    .item-search-form-modern button {
        font-size: 13.5px;
        padding: 4px 14px;
        border-radius: 7px;
        background: var(--main-btn);
        color: var(--main-btn-text);
        font-weight: 700;
        border: none;
        min-width: 52px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.13s, color 0.13s;
        box-shadow: 0 1px 7px #c49c4830;
        letter-spacing: 0.01em;
        flex: 0 0 auto;
    }
    .item-search-form-modern button:hover { background: var(--main-btn-hover); color: var(--main-btn-hover-text); }

    /* Mobile responsive */
    @media (max-width: 600px) {
        .item-search-form-modern { flex-direction: row; gap: 4px; padding: 2px 3vw; max-width: 99vw; }
        .item-search-form-modern label,
        .item-search-form-modern button,
        .item-search-form-modern input { font-size: 12px; height: 28px; }
        .item-search-form-modern input { min-width: 60px; max-width: 200px; width: 77px; padding: 3px 7px; }
    }
    @media (max-width: 420px) {
        .item-search-form-modern { flex-direction: column; align-items: stretch; gap: 5px; padding: 2px 2vw; }
        .item-search-form-modern label,
        .item-search-form-modern input,
        .item-search-form-modern button { width: 100%; min-width: 0; max-width: 99vw; }
        .item-search-form-modern input { margin-right: 0; }
    }
    h3 { color: var(--main-th); }

    /* ---------- FILTER BAR STYLE (MỚI) --------- */
    .type-filter-form {
        display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-start;
        gap: 9px 13px; margin-bottom: 10px; margin-top: 8px; font-size: 15px;
        width: 100%;
    }
    .type-filter-label { font-size: 14px; font-weight: 600; color: #c49c48; margin-bottom: 0; margin-right: 3px; }
    .type-filter-select, .dropdown-status-btn {
        font-size: 14px; padding: 6px 12px; border-radius: 7px; border: 1.3px solid #ffe082;
        background: #fffbe8; color: #775d17; font-weight: 600; outline: none; box-shadow: 0 1px 8px #f7cf3a10;
        min-width: 85px; max-width: 145px; width: auto; margin-right: 2px; margin-bottom: 0;
    }
    .dropdown-status-btn { display: flex; align-items: center; gap: 6px; min-width: 92px; }
    .dropdown-status-filter { position: relative; display: inline-block; vertical-align: middle; }
    .dropdown-status-menu {
        position: absolute; top: 115%; right: 0; min-width: 105px; max-width: 97vw; background: #fffbe8;
        border: 1.3px solid #ffe082; border-radius: 10px; box-shadow: 0 5px 20px #3331; z-index: 1100;
        margin-top: 5px; animation: fadeIn 0.23s; padding: 7px 0 1px 0; font-size: 13px;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-9px);} to { opacity: 1; transform: translateY(0);} }
    .dropdown-status-menu label {
        display: flex; align-items: center; gap: 7px; font-size: 13.2px; padding: 4px 12px 3px 10px; cursor: pointer;
        user-select: none; transition: background 0.16s, color 0.12s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        max-width: 92vw;
    }
    .dropdown-status-menu label:hover { background: #ffe08233; }
    .dropdown-status-menu input[type="checkbox"] { accent-color: #b78e24; margin-right: 4px; width: 16px; height: 16px; }
    .dropdown-status-menu .status-filter-btn-box { padding: 7px 12px 3px 12px; text-align: right; }
    .dropdown-status-menu button[type="submit"] {
        padding: 5px 18px; border-radius: 7px; font-size: 14px; font-weight: 600; background: #c49c48; color: #fff; border: none; cursor: pointer; transition: background 0.16s;
    }
    .dropdown-status-menu button[type="submit"]:hover { background: #35523A; color: #ffe082; }

    .overview-board { display: flex; gap: 20px; margin: 10px 0 20px 0; justify-content: center; flex-wrap: wrap; }
    .stat-card { background: #fffbe8; border-radius: 13px; min-width: 90px; min-height: 65px; flex: 1 1 0; padding: 10px 18px; text-align: center; box-shadow: 0 2px 8px #c49c4822; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 1; transition: opacity 0.2s; max-width: 180px; }
    .stat-card.late { border: 2.2px solid #df2323; }
    .stat-card.due { border: 2.2px solid #fbc02d; }
    .stat-card.must { border: 2.2px solid #00bcd4; }
    .stat-card.active { border: 2.2px solid #43a047; }
    .stat-num { font-size: 25px; font-weight: bold; margin-bottom: 3px; }
    .stat-label { font-size: 12.7px; font-weight: 600; letter-spacing: 0.01em; }
    .stat-label span { display: block; font-size: 11px; color: #a1887f; font-weight: 400;}
    .info-row { text-align: center; font-size: 13.4px; color: #b78e24; margin-bottom: 8px; }
    .info-row span { font-weight: 600; }
    .info-row .late { color: #df2323; }
    .info-row .due { color: #ff9800; }
    .info-row .must { color: #00bcd4; }
    .info-row .active { color: #43a047; }
    form { text-align: center; margin-bottom: 20px; }
    input[type=text], input[type=password] {
        font-size: 18px; padding: 10px 14px; width: 80%; margin: 10px 0; border-radius: 9px;
        border: 1.7px solid var(--main-th); color: var(--main-text); background: var(--main-bg);
        transition: background 0.3s, color 0.3s;
    }
    button {
        font-size: 17px; padding: 9px 24px; border-radius: 9px; background: var(--main-th); color: white;
        border: none; cursor: pointer; transition: background 0.3s;
    }
    button:hover { box-shadow: 0 3px 12px #0002; transform: scale(1.02); }
    .error-message { color: #e33; margin-top: 10px; text-align: center; }

    .table-responsive { width: 100%; overflow-x: auto; margin-top: 18px; }
    table { width: 100%; border-collapse: collapse; min-width: 680px; font-size: 16px; background: var(--main-bg); color: var(--main-text); }
    th, td { border: 1px solid #999; padding: 10px 12px; text-align: center; }
    th { background-color: var(--main-th); color: white; }
    td button { font-size: 15px; padding: 6px 12px; }

    .logout-link { display: inline-block; margin-top: 16px; text-align: center; }
    .logout-link a {
        color: #4d665c; font-weight: bold; text-decoration: none; font-size: 14px; transition: color 0.3s ease;
    }
    .logout-link a:hover { text-decoration: underline; }
    body.darkmode .logout-link a { color: #ffe082; }

    .status-late { color: #d32f2f; font-weight: bold; -webkit-text-stroke: 0.5px #222; text-shadow: 0 1px 2px #000c; letter-spacing: 1px; }
    .status-must { color: #FFD600; font-weight: bold; -webkit-text-stroke: 0.5px #222; text-shadow: 0 1px 2px #000c; letter-spacing: 1px; }
    .status-due  { color: #FF9800; font-weight: bold; -webkit-text-stroke: 0.5px #222; text-shadow: 0 1px 2px #000c; letter-spacing: 1px; }

    .counter-block { color: #232323 }

    /* --------- Darkmode --------- */
    body.darkmode, body.darkmode td, body.darkmode .stat-label, body.darkmode .stat-num { color: #f6f6ef !important; }
    body.darkmode .counter-block { background: #272917; color: #232323 !important; }
    body.darkmode th { color: #222 !important; }
    body.darkmode h2, body.darkmode h3, body.darkmode .info-row { color: #ffe082 !important; }
    body.darkmode table { background: #23252c; }
    body.darkmode .stat-card { background: #24283b !important; }
    body.darkmode .overview-board .stat-card.late { border-color: #f87171; }
    body.darkmode .overview-board .stat-card.due { border-color: #fbbf24; }
    body.darkmode .overview-board .stat-card.must { border-color: #38bdf8; }
    body.darkmode .overview-board .stat-card.active { border-color: #4ade80; }

    /* Darkmode filter */
    body.darkmode .type-filter-label { color: #b78e24 !important; }
    body.darkmode .type-filter-select,
    body.darkmode .dropdown-status-btn,
    body.darkmode .dropdown-status-menu { background: #ffe082 !important; color: #232 !important; border-color: #ffe082 !important; }
    body.darkmode .dropdown-status-menu label { color: #232 !important; }
    body.darkmode button, body.darkmode button[type="submit"] { color: #232323 !important; background: #ffe082 !important; }
    body.darkmode a button { color: #232323 !important; background: #ffe082 !important; }

    /* Responsive filter bar for mobile */
    @media (max-width: 600px) {
        .type-filter-form { flex-direction: row; flex-wrap: wrap; gap: 4px 3px; font-size: 12.7px; }
        .type-filter-label { font-size: 12px; margin-right: 2px; }
        .type-filter-select, .dropdown-status-btn { font-size: 12.3px; padding: 5px 7px; min-width: 62px; max-width: 99vw; width: auto; }
        .dropdown-status-menu { font-size: 12px; }
    }
    @media (max-width: 430px) {
        .type-filter-form { gap: 2px 1px; font-size: 11px; }
        .type-filter-select, .dropdown-status-btn { font-size: 11px; padding: 4px 5px; min-width: 48px; }
    }
    @media (max-width: 800px) {
        .center-form { padding: 16px 1vw; }
        table { font-size: 13px; min-width: 520px; }
        th, td { padding: 7px 6px; }
        form { margin-bottom: 12px; }
        h2 { font-size: 22px; }
        .overview-board { gap: 10px; }
        .stat-card { min-width: 65px; min-height: 52px; padding: 8px 7px; }
        .stat-num { font-size: 18px;}
    }
    @media (max-width: 520px) {
        .center-form { padding: 3vw 1vw; }
        table { font-size: 11px; min-width: 390px; }
        th, td { padding: 6px 3px; }
        h2 { font-size: 18px; }
        .stat-card { min-width: 47px; min-height: 32px; padding: 4px 3px; }
        .stat-num { font-size: 13px;}
    }

    .status-info-box {
        background: #fffbe8; border-radius: 12px; box-shadow: 0 1px 8px #f7cf3a18;
        padding: 8px 15px 7px 15px; margin: 28px auto 8px auto; max-width: 430px; border: 1.5px solid #ffe082;
    }
    .status-info-row {
        display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 9px;
        font-size: 14.2px; font-weight: 500; letter-spacing: 0.01em; color: #b78e24;
    }
    .status-label { font-weight: 700; }
    .status-label.late   { color: #df2323; }
    .status-label.due    { color: #ff9800; }
    .status-label.must   { color: #00bcd4; }
    .status-label.active { color: #43a047; }
    .status-sep { color: #ccc; margin: 0 4px; font-weight: 300;}
    body.darkmode .status-info-box { background: #ffe082; border-color: #ffe082; }
    body.darkmode .status-info-row, body.darkmode .status-label { color: #222 !important; }
    body.darkmode .status-label.late   { color: #d32f2f !important; }
    body.darkmode .status-label.due    { color: #b98509 !important; }
    body.darkmode .status-label.must   { color: #0c6bb0 !important; }
    body.darkmode .status-label.active { color: #0a7422 !important; }

    .status-summary-board {
        margin-left: auto; margin-right: auto; width: 100%; max-width: 700px;
        background: var(--main-card); border-radius: 13px; box-shadow: 0 2px 16px #fbc02d23; padding: 12px 10px 8px 10px; overflow: visible;
    }
    .status-summary-scroll { width: 100%; overflow-x: auto; }
    .status-summary-table {
        width: 100%; border-collapse: separate; border-spacing: 0; font-size: 15px; background: transparent;
        min-width: 340px; max-width: 100%; margin: 0 auto;
    }
    .status-summary-table th, .status-summary-table td { padding: 8px 9px; border-bottom: 1.2px solid #ffe08288; text-align: center; background: none; white-space: nowrap; }
    .status-summary-table th {
        background: #fffbe8; color: #b78e24; font-size: 13.5px; font-weight: 800; border-top: none; border-bottom: 2px solid #ffe082; letter-spacing: 0.04em;
    }
    .status-summary-table td { background: transparent; font-size: 13.5px; }
    .status-summary-table .late-col   { color: #df2323 !important; font-weight: 700;}
    .status-summary-table .due-col    { color: #ff9800 !important; font-weight: 700;}
    .status-summary-table .must-col   { color: #00bcd4 !important; font-weight: 700;}
    .status-summary-table .active-col { color: #43a047 !important; font-weight: 700;}

    @media (max-width: 600px) {
        .status-summary-board { padding: 7px 0 7px 0; }
        .status-summary-table th, .status-summary-table td { padding: 3px 1px; font-size: 13px; }
        .status-summary-table th { font-size: 14px; }
    }
    @media (max-width: 370px) {
        .status-summary-table { min-width: 80px;}
        .status-summary-table th, .status-summary-table td { padding: 1.7px 1px; font-size: 8px;}
    }
    body.darkmode .status-summary-board { background: #ffe082 !important; box-shadow: 0 1px 10px #2222; }
    body.darkmode .status-summary-table th { background: #ffe082 !important; color: #222 !important; }
    body.darkmode .status-summary-table td { background: transparent !important; }
    body.darkmode .status-summary-table .late-col   { color: #df2323 !important; }
    body.darkmode .status-summary-table .due-col    { color: #ff9800 !important; }
    body.darkmode .status-summary-table .must-col   { color: #00bcd4 !important; }
    body.darkmode .status-summary-table .active-col { color: #43a047 !important; }

    /* Pagination style */
    .pagination-box { display: flex; justify-content: center; align-items: center; gap: 5px; margin: 18px 0 12px 0; }
    .pagination-btn {
        display: inline-block; min-width: 32px; padding: 6px 12px; margin: 0 2px; font-size: 16px; font-weight: 500;
        color: #b78e24; background: #fffbe8; border: 1.2px solid #ffe082; border-radius: 7px; cursor: pointer; text-decoration: none;
        transition: background 0.15s, color 0.15s, border 0.15s; z-index: 11; position: relative; user-select: none; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.15);
    }
    .pagination-btn.active, .pagination-btn:hover { background: #ffe082; color: #232323; border-color: #fbc02d; font-weight: 700; pointer-events: none; }

    body.darkmode .pagination-btn { background: #ffe082 !important; color: #222 !important; border-color: #ffe082 !important; }
    body.darkmode .pagination-btn.active { background: #fffbe8 !important; color: #dcb300 !important; border-color: #ffe082 !important; }

    .main-btn:hover { background: #c49c48 !important; color: #232826 !important; }

    .btn-more {
        background: #c49c48; color: #fff; border: none; border-radius: 100px; width: 44px; height: 44px; font-size: 20px;
        display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 18px #a3936840, 0 1.5px 8px #c49c4822;
        transition: background 0.15s, color 0.12s, box-shadow 0.13s; cursor: pointer; outline: none;
    }
    .btn-more:hover { background: #35523A; color: #ffe082; }

    .dropdown-content {
        display: none; position: absolute; right: 0; top: 52px; min-width: 175px; background: #fff; border-radius: 13px;
        box-shadow: 0 4px 16px #bca04044; font-size: 15.5px; overflow: hidden; z-index: 1001; border: 1.5px solid #f3e1a2;
    }
    .dropdown-content a {
        display: flex; align-items: center; gap: 8px; color: #333; padding: 12px 19px 12px 14px; text-decoration: none; border-bottom: 1px solid #eee2b8;
        font-weight: 500; transition: background 0.16s, color 0.13s;
    }
    .dropdown-content a:last-child { border-bottom: none; }
    .dropdown-content a:hover { background: #ffe082; color: #35523A; }

    .show { display: block; }

    .form-pw.login-row {
        display: flex; gap: 8px; align-items: center; justify-content: stretch; width: 100%; margin-bottom: 0; margin-top: 0;
    }
    .form-pw .pw-input { width: 100%; min-width: 0; flex: 1 1 0; box-sizing: border-box; height: 44px; }
    .form-pw .pw-btn { flex: 0 0 auto; padding-left: 20px; padding-right: 20px; margin-left: 0; height: 44px; white-space: nowrap; border-radius: 9px; background: var(--main-th); color: white; border: none; font-size: 17px; font-weight: 600; transition: background 0.3s; box-sizing: border-box; }
    .form-pw .pw-btn:hover { background: #35523A; color: #ffe082; }
    .form-pw #toggle-pw {
        right: 10px; top: 0; height: 100%; display: flex; align-items: center; background: transparent; border: none; cursor: pointer;
        color: #b78e24; font-size: 18px; opacity: 0.84; z-index: 2; padding: 0 2px; position: absolute;
    }

    .toolbar-top { width: 100%; max-width: 700px; margin: 0 auto 10px auto; display: flex; flex-direction: column; align-items: center; gap: 0; }
    .stat-btn-bar { width: 100%; display: flex; justify-content: center; margin-bottom: 10px; }
    .type-filter-form { width: 100%; justify-content: flex-end; }

    @media (max-width: 600px) {
        .form-pw.login-row { flex-direction: column; gap: 6px; align-items: stretch; }
        .form-pw .pw-btn { width: 100%; margin-left: 0; margin-top: 6px; }
        .form-pw .pw-input { width: 100%; }
        .toolbar-top, .stat-btn-bar { max-width: 98vw; }
        .stat-btn-bar { margin-bottom: 7px; }
        .type-filter-form { margin-top: 8px; }
    }

    input[type=text], input[type=password], button { box-sizing: border-box; }
    /* Thêm tối ưu cho select/option cho mobile không tràn */
    select, .type-filter-select, .dropdown-status-btn { max-width: 100vw; width: auto; min-width: 0; }

    #theme-btn {
        position: fixed; right: 24px; bottom: 26px; z-index: 11001; background: #8B6B1E; color: #fff; border-radius: 100px; font-size: 17px; padding: 6px 11px; border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.10); cursor: pointer; height: 38px; width: 38px; min-width: 36px; display: flex; align-items: center; justify-content: center; opacity: 0.96;
        transition: background 0.16s, color 0.16s; font-family: 'Inter', sans-serif;
    }
    #theme-btn:hover { background: #C49C48; color: #fff; opacity: 1; }
    body.dark #theme-btn, body.darkmode #theme-btn { background: #6c837f !important; color: #fefefe !important; transition: background 0.23s, color 0.23s; }

    .item-search-form { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
    .item-search-label { font-size: 14px; font-weight: 600; color: #c49c48; margin-bottom: 0; white-space: nowrap; height: 38px; display: flex; align-items: center; }
    .item-search-input {
        font-size: 15px; padding: 7px 13px; border-radius: 7px; border: 1.3px solid #ffe082; background: #fffbe8; color: #775d17; font-weight: 600; outline: none;
        min-width: 140px; max-width: 220px; width: 180px; box-sizing: border-box;
    }
    .item-search-btn { font-size: 15px; padding: 7px 22px; border-radius: 7px; background: #c49c48; color: #fff; border: none; cursor: pointer; font-weight: 600; transition: background 0.17s, color 0.17s; display: flex; align-items: center; height: 38px; }
    .item-search-btn:hover { background: #35523A; color: #ffe082; }

    @media (max-width: 600px) {
        .item-search-form { gap: 4px; }
        .item-search-label { font-size: 12px; height: 32px; }
        .item-search-input { font-size: 13px; padding: 6px 9px; min-width: 130px; max-width: 200px; width: 170px; height: 32px; }
        .item-search-btn { font-size: 13px; padding: 6px 13px; height: 32px; }
    }
    @media (max-width: 430px) {
        .item-search-form { flex-direction: column; align-items: stretch; }
        .item-search-label, .item-search-input, .item-search-btn { width: 50%; min-width: 0; max-width: 99vw; justify-content: flex-start; }
        .item-search-label { margin-bottom: 3px; height: auto; }
    }

    .staff-id { text-align: right; font-size: 14.3px; font-style: italic; margin-top: -6px; color: #968015; }
    body.darkmode .staff-id { color: #ffe082; }

    .item-search-table { width: 100%; border-collapse: collapse; font-size: 15px; background: var(--main-bg); color: var(--main-text); margin-top: 10px; }
    .item-search-table th, .item-search-table td { border: 1px solid #bbb; padding: 8px 9px; text-align: center; background: transparent; }
    .item-search-table th { background: #ffe082; color: #b78e24; font-weight: 800; font-size: 13.5px; }
    .item-search-table .status-late { color: #d32f2f; font-weight: bold; }
    .item-search-table .status-must { color: #FFD600; font-weight: bold; }
    .item-search-table .status-due  { color: #FF9800; font-weight: bold; }
    .item-search-table .status-active { color: #43a047; font-weight: bold; }

    /* Ẩn các khối TEST LAB khi vào VFR3 – KHÔNG ẩn logout nữa */
    body.vfr3-mode .request-menu-row:not(#vfr3-panel),
    body.vfr3-mode .item-search-form-modern,
    body.vfr3-mode .dropdown,
    /* body.vfr3-mode .logout-link,  <-- đã bỏ để còn logout */
    body.vfr3-mode .toolbar-top,
    body.vfr3-mode #report-table-box,
    body.vfr3-mode .status-info-box,
    body.vfr3-mode .status-summary-board,
    body.vfr3-mode .counter-block,
    body.vfr3-mode form[action="/go_report"],
    body.vfr3-mode .table-responsive .item-search-table,
    body.vfr3-mode h3,
    body.vfr3-mode .info-row,
    body.vfr3-mode .overview-board,
    body.vfr3-mode .pagination-box {
        display: none !important;
    }

    /* Panel VFR3 — hiển thị thay thế cụm request khi ở VFR3 mode */
    #vfr3-panel { display: none; }
    body.vfr3-mode #vfr3-panel { display: flex !important; }

    /* Style cho panel VFR3 và nút */
    #vfr3-panel {
        justify-content: center; align-items: center; gap: 16px; margin: 20px auto 10px; flex-wrap: wrap;
    }
    .vfr3-btn {
        min-width: 180px; max-width: 260px; padding: 14px 18px; border-radius: 14px; border: none; background: var(--main-btn);
        color: var(--main-btn-text); font-weight: 800; font-size: 17px; letter-spacing: .02em; box-shadow: 0 4px 14px #c49c4840;
        display: inline-flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; cursor: pointer;
        transition: background .16s, transform .12s, color .16s, box-shadow .16s;
    }
    .vfr3-btn:hover { background: var(--main-btn-hover); color: var(--main-btn-hover-text); transform: translateY(-2px) scale(1.03); box-shadow: 0 6px 18px #c49c4840; }

    /* ===== MODE DROPDOWN (thay cho chip cũ) ===== */
    .mode-dropdown {
        position: absolute;
        top: 20px;
        left: 24px;
        z-index: 2005;
        display: none; /* chỉ hiện khi đã đăng nhập (STAFF_OK) */
    }
    body.has-staff .mode-dropdown { display: block; }

    #mode-btn {
        background: #fffbe8;
        color: #775d17;
        border: 1.3px solid #ffe082;
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 14.5px;
        cursor: pointer;
        box-shadow: 0 2px 10px #f7cf3a25;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    #mode-btn i.fa-caret-down { opacity: 0.9; }

    .mode-menu {
        display: none;
        position: absolute;
        top: 110%;
        left: 0;
        min-width: 170px;
        background: #fffbe8;
        border: 1.3px solid #ffe082;
        border-radius: 12px;
        box-shadow: 0 6px 22px #c49c4840;
        overflow: hidden;
    }
    .mode-dropdown.open .mode-menu { display: block; }

    .mode-menu a {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        text-decoration: none;
        color: #333;
        font-weight: 600;
        white-space: nowrap;
        transition: background 0.16s, color 0.13s;
        border-bottom: 1px solid #eee2b8;
    }
    .mode-menu a:last-child { border-bottom: none; }
    .mode-menu a:hover {
        background: #ffe082;
        color: #35523A;
    }
    .mode-menu a.active {
        background: #fff1b8;
        color: #6b4e07;
    }

    /* Darkmode cho dropdown */
    body.darkmode #mode-btn { background: #ffe082; color: #232; border-color: #ffe082; }
    body.darkmode .mode-menu { background: #ffe082; border-color: #ffe082; }
    body.darkmode .mode-menu a { color: #232; border-bottom-color: #f2d97a; }
    body.darkmode .mode-menu a:hover { background: #ffec9a; color: #1a2d27; }
    body.darkmode .mode-menu a.active { background: #ffe795; color: #1a2d27; }

    /* ===== MODE OVERLAY (popup chọn department sau khi nhập Staff ID) ===== */
    #mode-overlay {
        position: fixed;
        inset: 0;
        z-index: 30000;
        display: none;                 /* JS sẽ bật = 'flex' khi cần */
        align-items: center;
        justify-content: center;
        background: rgba(35,42,55,0.22);
        backdrop-filter: blur(2px);
    }
    #mode-card {
        background: #fffbe8;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 40px #c49c4844;
        width: min(560px, 92vw);
        text-align: center;
        border: 1.5px solid #ffe082;
    }
    #mode-card h3 {
        margin: 0 0 14px;
        color: #c49c48;
    }
    .mode-actions {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 6px;
    }
    .mode-btn {
        min-width: 160px;
        padding: 12px 18px;
        border-radius: 12px;
        border: none;
        background: var(--main-btn);
        color: var(--main-btn-text);
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 4px 12px #c49c4830;
        transition: background .16s, transform .12s, color .16s, box-shadow .16s;
    }
    .mode-btn:hover {
        background: var(--main-btn-hover);
        color: var(--main-btn-hover-text);
        transform: translateY(-2px);
    }

    /* Khi overlay mở, khóa cuộn body cho đỡ giật */
    body.modal-open { overflow: hidden; }

    /* Darkmode cho card */
    body.darkmode #mode-card { background: #ffe082; border-color: #ffe082; }
    body.darkmode #mode-card h3 { color: #232; }
    /* Nút quét QR – đối xứng nút đổi ngôn ngữ */
    #qr-btn{
    position:absolute; top:20px; left:32px; z-index:22;
    background:#ffe082; color:#35523A; border-radius:100px; 
    font-size:15px; padding:5px 12px; border:none; font-weight:600;
    box-shadow:0 2px 10px #bca96b22; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }
    #qr-btn:hover{ background:#ffd25b; color:#1b3429 }

    /* Overlay quét QR */
    #qr-overlay{
    display:none; position:fixed; inset:0; z-index:30000;
    background:rgba(35,42,55,0.22); backdrop-filter:blur(2px);
    align-items:center; justify-content:center; padding:16px;
    }
    #qr-card{
    background:#fffbe8; border:1.5px solid #ffe082; border-radius:18px;
    width:min(560px, 94vw); box-shadow:0 8px 40px #c49c4844; 
    padding:16px 16px 18px 16px; color:#333;
    }
    #qr-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;
    }
    #qr-title{ font-size:18px; font-weight:800; color:#b78e24; margin:4px 0 }
    #qr-close{
    background:#c49c48; color:#fff; border:none; border-radius:10px; font-weight:700;
    padding:6px 10px; cursor:pointer;
    }
    #qr-close:hover{ background:#35523A; color:#ffe082 }

    /* Khung camera */
    #qr-reader{
    width:100%; background:#00000010; border:2px solid #c49c48; border-radius:12px; overflow:hidden;
    aspect-ratio: 4 / 3; /* giúp ổn định khung hình trên mobile/desktop */
    }

    /* Nhãn kết quả */
    #qr-result{ margin-top:8px; font-weight:700; color:#b78e24; text-align:center; font-size:14px }

    /* Dark mode */
    body.darkmode #qr-card{ background:#ffe082; border-color:#ffe082; color:#232 }
    body.darkmode #qr-title{ color:#232 }
    body.darkmode #qr-btn{ background:#6c837f; color:#fefefe }
    body.darkmode #qr-btn:hover{ background:#4f6a66; color:#fff }
    </style>
</head>
<body>
    {% if not session.get('staff_id') %}
    <!-- Staff ID overlay -->
    <div id="staff-id-overlay" style="position:fixed;z-index:30000;top:0;left:0;width:100vw;height:100vh;background:rgba(35,42,55,0.22);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;">
        <form method="POST" id="staff-id-form"
            style="background:#fffbe8; border-radius:18px; padding:34px 36px; box-shadow:0 8px 40px #c49c4844; min-width:330px; max-width:94vw;">
            <h3 style="color:#c49c48; text-align:center; font-size:22px; margin-bottom:14px;">Staff ID</h3>
            <input type="text" name="staff_id" id="staff_id_input" list="staff_id_history" autocomplete="off"
                    placeholder="(VD: 19797 - Nguyễn Văn A)" required autofocus
                    pattern="^\d+\s*-\s*[\p{L}\s]+$"
                    style="width:100%; font-size:18px; margin-bottom:17px; border-radius:8px; border:1.3px solid #c49c48; padding:11px;">
            <datalist id="staff_id_history"></datalist>
            <button type="submit" name="action" value="set_staff_id"
                style="width:100%; background:#c49c48; color:#fff; font-size:17px; padding:11px; border-radius:7px; border:none;cursor:pointer;">
            Submit    
            </button>
            {% if message %}
            <div class="error-message" style="margin-top:12px; color:#e33; text-align:center;">{{ message }}</div>
            {% endif %}
        </form>
    </div>
    {% endif %}

    {% if session.get('staff_id') %}
    <!-- Chọn chế độ -->
    <div id="mode-overlay">
      <div id="mode-card">
        <h3>Choose Department</h3>
        <div class="mode-actions">
            <button class="mode-btn" id="btn-mode-testlab"><i class="fa fa-flask"></i> TEST LAB</button>
            <button class="mode-btn" id="btn-mode-vfr3"><i class="fa fa-industry"></i> VFR3</button>
        </div>
        <div style="margin-top:10px; font-size:13px; color:#8b6b1e;">Can change later</div>
      </div>
    </div>
    {% endif %}

    <div style="opacity:{% if not session.get('staff_id') %}0.22{% else %}1{% endif %}; pointer-events:{% if not session.get('staff_id') %}none{% else %}auto{% endif %}; transition:opacity 0.22s;">
        {% if session.get('staff_id') %}
        <!-- Nút chọn MODE (dropdown trái) -->
        <div class="mode-dropdown" aria-label="Chọn chế độ" title="Chọn chế độ">
            <button id="mode-btn">
                <i class="fa fa-layer-group"></i>
                <span id="mode-current">TEST LAB</span>
                <i class="fa fa-caret-down"></i>
            </button>
            <div class="mode-menu" id="mode-menu">
                <a href="#" data-mode="TEST_LAB" id="mode-item-testlab"><i class="fa fa-flask"></i> TEST LAB</a>
                <a href="#" data-mode="VFR3" id="mode-item-vfr3"><i class="fa fa-industry"></i> VFR3</a>
                <!-- Sau này thêm bộ phận khác chỉ cần add thêm:
                <a href="#" data-mode="ABC"><i class="fa fa-..."></i> ABC</a>
                -->
            </div>
        </div>
        {% endif %}
        <div class="center-form">
            <!-- Nút quét QR (góc trái trên trong box) -->
            <button id="qr-btn" title="Quét QR Report">
                <i class="fa fa-qrcode"></i> <span>QR</span>
            </button>
            <!-- Nút chuyển ngôn ngữ -->
            <div style="position:absolute; top:20px; right:32px; z-index:22;">
                <button id="lang-btn" title="Đổi ngôn ngữ/Change language" style="background:#ffe082; color:#35523A; border-radius:100px; font-size:15px; padding:5px 16px; border:none; font-weight:600; box-shadow:0 2px 10px #bca96b22; cursor:pointer;">
                    <i class="fa fa-language"></i> <span>EN</span>
                </button>
            </div>

            <img src="/static/logo_vfr.jpg" alt="VFR Logo" style="display:block; margin: 30px auto 18px auto; max-width:190px;"/>
            <h2 class="text-title">Product Search</h2>

            {# =============== KHỐI KHI CHƯA ĐĂNG NHẬP TEST LAB VÀ CHƯA VFR3_OK =============== #}
            {% if not session.get('auth_ok') and not session.get('vfr3_ok') %}
                <!-- Cụm nút TEST LAB mặc định -->
                <div class="request-menu-row">
                    <a href="/tfr_request_form" class="request-btn"><i class="fa fa-file-circle-plus"></i> <span class="text-create-rq">Create Request</span></a>
                    <a href="/tfr_request_status" class="request-btn"><i class="fa fa-search"></i> <span class="text-rq-status">RQ Submitted</span></a>
                </div>

                <!-- Panel VFR3 (sẽ thế chỗ cụm trên khi chuyển sang VFR3 mode) -->
                <div id="vfr3-panel" class="request-menu-row">
                    <a href="/vfr3/wax" class="vfr3-btn"><i class="fa fa-cubes"></i> <span class="text-vfr3-wax">Mẫu sáp</span></a>
                    <a href="/vfr3/sand-casting" class="vfr3-btn"><i class="fa fa-mountain"></i> <span class="text-vfr3-sand">Mẫu đúc cát</span></a>
                    <a href="/vfr3/ceramic-plaster" class="vfr3-btn"><i class="fa fa-flask"></i> <span class="text-vfr3-ceramic">Mẫu ceramic thạch cao</span></a>
                </div>

                <!-- Form đăng nhập (chỉ hiện khi chưa VFR3_OK) -->
                <form method="POST" class="form-pw login-row" style="margin-top:26px;">
                    <div style="position:relative; flex:1; min-width:0;">
                        <input type="password" name="password" id="login-password" placeholder="Nhập mật khẩu" required class="pw-input text-password" style="padding-right:38px;">
                        <button type="button" id="toggle-pw" tabindex="-1" title="Hiện/Ẩn mật khẩu" aria-label="Hiện/Ẩn mật khẩu" style="position:absolute; right:10px; top:0; height:100%; background:transparent; border:none; cursor:pointer;">
                            <i class="fa fa-eye" id="eye-icon"></i>
                        </button>
                    </div>
                    <button name="action" value="login" class="pw-btn text-login-btn">Đăng nhập</button>
                </form>
                {% if message %}
                    <div class="error-message">{{ message }}</div>
                {% endif %}

            {# =============== KHỐI TEST LAB / VFR3 SAU KHI ĐĂNG NHẬP =============== #}
            {% else %}
                <!-- Panel VFR3: LUÔN render trong DOM khi đã login; hiển thị khi body.vfr3-mode -->
                <div id="vfr3-panel" class="request-menu-row">
                    <a href="/vfr3/wax" class="vfr3-btn"><i class="fa fa-cubes"></i> <span class="text-vfr3-wax">Mẫu sáp</span></a>
                    <a href="/vfr3/sand-casting" class="vfr3-btn"><i class="fa fa-mountain"></i> <span class="text-vfr3-sand">Mẫu đúc cát</span></a>
                    <a href="/vfr3/ceramic-plaster" class="vfr3-btn"><i class="fa fa-flask"></i> <span class="text-vfr3-ceramic">Mẫu ceramic thạch cao</span></a>
                </div>

                <!-- Góc phải: menu và logout khi đã đăng nhập TEST LAB -->
                <div style="position: fixed; top: 22px; right: 28px; z-index: 2001;">
                  <div class="dropdown">
                    <button class="btn-more" onclick="toggleRequestDropdown()" title="Test Request">
                      <i class="fa fa-list-ul"></i>
                    </button>
                    <div id="requestDropdownMenu" class="dropdown-content">
                        <a href="/tfr_request_form"><i class="fa fa-file-circle-plus"></i> <span class="text-create-rq">Create Request</span></a>
                        <a href="/tfr_request_status"><i class="fa fa-search"></i> <span class="text-rq-status">RQ Submitted</span></a>
                        <a href="/tfr_request_archive"><i class="fa fa-archive"></i> <span class="text-trf">TRF</span></a>
                        {% if session.get('role') in ['stl', 'superadmin'] %}
                            <a href="javascript:void(0)" onclick="confirmExportExcel()"><i class="fa fa-file-export"></i> <span class="text-update-inf">Update INF</span></a>
                            <a href="/print_qr"><i class="fa fa-qrcode"></i> <span class="text-print-qr">Print QR</span></a>
                            <a href="/testlab/dashboard"><i class="fa fa-chart-line"></i> Dashboard</a>
                        {% endif %}
                    </div>
                  </div>
                </div>
                <div class="logout-link">
                    <a href="/logout"><i class="fa fa-sign-out-alt"></i> <span class="text-logout">Đăng xuất</span></a>
                </div>
            {% endif %}

        {% if session.get('auth_ok') and session.get('staff_id') and report_list %}
            <form method="GET" action="/go_report">
                <input type="text" name="report" placeholder="Nhập REPORT#">
                <br>
                <button type="submit"><i class="fa fa-search"></i> Xem thông tin</button>
            </form>
            <div class="staff-id">
                <b>ID Nhân viên:</b> {{ session.get('staff_id') }}
            </div>
            <h3 style="margin-top:36px; color:var(--main-th);">Danh sách report:</h3>
            <div class="status-summary-board">
              <div class="status-summary-scroll">
                <table class="status-summary-table">
                  <thead>
                    <tr>
                      <th>TRẠNG THÁI</th>
                      {% for t in summary_by_type %}
                        <th>{{ t.short }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="late-col"><b>LATE</b></td>
                      {% for t in summary_by_type %}<td class="late-col">{{ t.late }}</td>{% endfor %}
                    </tr>
                    <tr>
                      <td class="due-col"><b>DUE</b></td>
                      {% for t in summary_by_type %}<td class="due-col">{{ t.due }}</td>{% endfor %}
                    </tr>
                    <tr>
                      <td class="must-col"><b>MUST</b></td>
                      {% for t in summary_by_type %}<td class="must-col">{{ t.must }}</td>{% endfor %}
                    </tr>
                    <tr>
                      <td class="active-col"><b>ACTIVE</b></td>
                      {% for t in summary_by_type %}<td class="active-col">{{ t.active }}</td>{% endfor %}
                    </tr>
                    <tr class="total-row">
                      <td><b>TOTAL</b></td>
                      {% for t in summary_by_type %}<td><b>{{ t.total }}</b></td>{% endfor %}
                    </tr>
                  </tbody>   
                </table>
              </div>
            </div>
            <div class="counter-block" style="margin-top:24px; padding:14px 0; background:#f6f3e9; border-radius:10px; text-align:center; font-size:17px; font-weight:bold;margin-bottom: 18px;">
                <div>Đơn hoàn thành giờ HC (8:00–16:45): <span style="color:#2e7d32;">{{ counter.office }}</span></div>
                <div>Đơn hoàn thành giờ OT (16:45–23:59): <span style="color:#a32121;">{{ counter.ot }}</span></div>
            </div>
            <div class="toolbar-top">
                <div class="stat-btn-bar">
                    <a href="{{ url_for('view_counter_log') }}"
                        class="main-btn"
                        style="background:#4e8573; color:#fff9d1; border-radius:12px; font-size:18px; font-weight:600; padding:12px 38px; display:inline-block; box-shadow:0 3px 13px #2b3938aa; letter-spacing:0.04em; text-decoration:none; transition:background 0.22s, color 0.22s;">
                        <i class="fa fa-table" style="margin-right:7px;"></i>
                        Xem bảng thống kê từng ngày
                    </a>
                </div>
                <form method="get" id="item-search-form" class="item-search-form">
                    <label for="item_search" class="item-search-label">Tìm ITEM#</label>
                    <input type="text" id="item_search" name="item_search" placeholder="Nhập mã ITEM#" value="{{ request.args.get('item_search', '') }}" class="item-search-input">
                    <button type="submit" class="item-search-btn"><i class="fa fa-search"></i> Tìm</button>
                </form>
                <form method="get" class="type-filter-form" id="filter-form" style="margin:0; text-align:left;">
                    <label for="type_of" class="type-filter-label">Type of</label>
                    <select name="type_of" id="type_of" onchange="this.form.submit()" class="type-filter-select">
                        <option value="">Tất cả</option>
                        {% for t in type_of_set %}
                        <option value="{{ t }}" {% if t == selected_type %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                    <label class="type-filter-label">Status</label>
                    <div class="dropdown-status-filter" style="margin-right:2px;">
                    <button type="button" class="dropdown-status-btn" onclick="toggleStatusDropdown()">
                        {% if not selected_status or selected_status == [''] %}
                        All
                        {% else %}
                        {% for s in selected_status %}{{ s }}{% if not loop.last %}, {% endif %}{% endfor %}
                        {% endif %}
                        <i class="fa fa-caret-down" style="margin-left:4px;"></i>
                    </button>
                    <div class="dropdown-status-menu" id="dropdown-status-menu" style="display:none;">
                        <label><input type="checkbox" name="status" value="" {% if not selected_status or selected_status == [''] %}checked{% endif %}> All</label>
                        {% for s in status_set %}
                        <label><input type="checkbox" name="status" value="{{s}}" {% if s in selected_status %}checked{% endif %}>{{ s }}</label>
                        {% endfor %}
                        <div class="status-filter-btn-box"><button type="submit">Lọc</button></div>
                    </div>
                    </div>
                    <label for="page_size" class="type-filter-label">Hiển thị</label>
                    <select name="page_size" id="page_size" class="type-filter-select" onchange="updatePageSize()">
                        <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
                        <option value="15" {% if page_size == 15 %}selected{% endif %}>15</option>
                        <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
                    </select>
                    <span style="font-size:12px;color:#a1887f;">/trang</span>
                </form>
            </div>

            <div class="table-responsive">
            <div id="report-table-box">
                <table id="report-table">
                    <thead>
                        <tr>
                            <th>REPORT#</th>
                            <th>ITEM#</th>
                            <th>TYPE OF</th>
                            <th>STATUS</th>
                            <th>LOG IN DATE</th>
                            <th>ETD</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in report_list %}
                        <tr class="report-row">
                            <td>{{ r.report }}</td>
                            <td>{{ r.item }}</td>
                            <td>{{ r.type_of }}</td>
                            <td><span class="{% if r.status == 'LATE' %}status-late{% elif r.status == 'MUST' %}status-must{% elif r.status == 'DUE' %}status-due{% endif %}">{{ r.status }}</span></td>
                            <td>{{ r.log_date }}</td>
                            <td>{{ r.etd or "" }}</td>
                            <td><a href="/update?report={{ r.report }}"><button><i class="fa fa-edit"></i> Xem</button></a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="text-align:center; margin:18px 0;">
                    <button id="prev-btn" style="display:none; font-size:17px; padding:8px 24px; border-radius:8px; background:#ffe082; color:#232323; border:none; cursor:pointer; margin-right:10px;">&#8592; Quay lại</button>
                    <button id="load-more-btn" style="display:none; font-size:17px; padding:8px 32px; border-radius:8px; background:#ffe082; color:#232323; border:none; cursor:pointer;">Tiếp theo</button>
                </div>
            </div>
            </div>

            <div class="status-info-box">
                <div class="status-info-row">
                    <span class="status-label late">LATE</span>: trễ hạn
                    <span class="status-sep">|</span>
                    <span class="status-label due">DUE</span>: hôm nay
                    <span class="status-sep">|</span>
                    <span class="status-label must">MUST</span>: ngày mai
                    <span class="status-sep">|</span>
                    <span class="status-label active">ACTIVE</span>: đang theo dõi
                </div>
            </div>
        {% endif %}
        </div>
    </div>

    <button id="theme-btn" title="Chuyển Dark/Light mode"><i class="fa fa-moon"></i></button>

    <script>
        // --- PREF SYNC (darkmode, lang) ---
        function setPref(key, value) {
            localStorage.setItem("vfr-" + key, value);
            fetch('/set_pref', { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ key, value }) });
        }

        // --- INIT VAR from backend/session ---
        let INIT_DARK = {{ 'true' if darkmode in ('1', 1, True) else 'false' }};
        let INIT_LANG = "{{ lang or 'vi' }}";

        // --- STAFF ID AUTOCOMPLETE & VALIDATION ---
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(function(){ var inp = document.getElementById('staff_id_input'); if(inp) inp.focus(); }, 180);
            let staffIdInput = document.getElementById("staff_id_input");
            let datalist = document.getElementById("staff_id_history");
            if (staffIdInput && datalist) {
                let history = [];
                try { history = JSON.parse(localStorage.getItem("staff_id_history") || "[]"); } catch {}
                datalist.innerHTML = "";
                history.forEach(function(id) { let opt = document.createElement("option"); opt.value = id; datalist.appendChild(opt); });
                if(history.length) staffIdInput.value = history[history.length-1];

                staffIdInput.form.addEventListener('submit', function(e) {
                    let val = staffIdInput.value.trim();
                    let regex = /^\d+\s*-\s*[\p{L}\s]+$/u;
                    if (!regex.test(val)) {
                        e.preventDefault();
                        alert("Vui lòng nhập đúng định dạng: Mã số - Họ tên (VD: 19797 - Nguyễn Văn A)");
                        staffIdInput.focus();
                        return false;
                    }
                    if(val) {
                        let idx = history.indexOf(val);
                        if(idx !== -1) history.splice(idx,1);
                        history.push(val);
                        if(history.length > 10) history = history.slice(-10);
                        localStorage.setItem("staff_id_history", JSON.stringify(history));
                    }
                });
            }
        });

        // --- DARKMODE SYNC ---
        function applyDarkMode(dark) {
            document.body.classList.toggle('darkmode', dark);
            document.body.classList.toggle('dark', dark);
            let themeBtn = document.getElementById('theme-btn');
            if (themeBtn) themeBtn.innerHTML = dark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
            setPref("darkmode", dark ? "1" : "0");
        }
        document.addEventListener('DOMContentLoaded', function() {
            let dark = (typeof INIT_DARK === "boolean" ? INIT_DARK : (INIT_DARK == "true"));
            if (localStorage.getItem("vfr-darkmode") !== null) dark = localStorage.getItem("vfr-darkmode") === "1";
            applyDarkMode(dark);
            let themeBtn = document.getElementById('theme-btn');
            if (themeBtn) { themeBtn.onclick = function() { dark = !dark; applyDarkMode(dark); }; }

            // PHÂN TRANG
            let chunkSize = typeof PAGE_SIZE !== "undefined" ? PAGE_SIZE : (typeof page_size !== "undefined" ? page_size : 10);
            if (typeof chunkSize !== "number") { try { chunkSize = parseInt(chunkSize); } catch {} }
            if (!chunkSize || isNaN(chunkSize)) chunkSize = 10;
            const tableBox = document.getElementById('report-table-box');
            if (tableBox) {
                const rows = Array.from(document.querySelectorAll('.report-row'));
                const btnNext = document.getElementById('load-more-btn');
                const btnPrev = document.getElementById('prev-btn');
                let startIdx = 0;
                function showChunk(idx) {
                    rows.forEach((row, i) => { row.style.display = (i >= idx && i < idx + chunkSize) ? '' : 'none'; });
                    btnPrev && (btnPrev.style.display = (idx <= 0) ? 'none' : '');
                    btnNext && (btnNext.style.display = (idx + chunkSize >= rows.length) ? 'none' : '');
                    if (rows.length > 0) { window.scrollTo({ top: tableBox.offsetTop, behavior: 'smooth' }); }
                }
                btnNext && btnNext.addEventListener('click', function() { if (startIdx + chunkSize < rows.length) { startIdx += chunkSize; showChunk(startIdx); } });
                btnPrev && btnPrev.addEventListener('click', function() { startIdx = Math.max(0, startIdx - chunkSize); showChunk(startIdx); });
                if (rows.length > chunkSize) { btnNext && (btnNext.style.display = ''); }
                showChunk(0);
                window.updatePageSize = function() { let form = document.getElementById("filter-form"); if(form){ form.submit(); } }
            }
        });

        // --- SHOW/HIDE PASSWORD ---
        document.addEventListener('DOMContentLoaded', function() {
            var togglePw = document.getElementById('toggle-pw');
            if (togglePw) {
                togglePw.onclick = function() {
                    var pw = document.getElementById('login-password');
                    var icon = document.getElementById('eye-icon');
                    if (pw.type === "password") { pw.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
                    else { pw.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
                };
            }
        });

        // --- LANGUAGE SYNC ---
        function applyLang(lang) {
            const LANG = {
                vi: {
                    "text-title": "V.F.R",
                    "text-create-rq": "Tạo Request",
                    "text-rq-status": "Trạng thái đã gửi",
                    "text-trf": "Lưu trữ",
                    "text-update-inf": "Cập nhật INF",
                    "text-logout": "Đăng xuất",
                    "text-item-label": "🔎 MÃ ITEM",
                    "text-search-btn": "Tìm",
                    "text-view-report": "Xem report",
                    "text-th-item": "ITEM#",
                    "text-th-report": "REPORT#",
                    "text-th-type": "LOẠI",
                    "text-th-status": "TRẠNG THÁI",
                    "text-th-action": "Hành động",
                    "text-notfound": "Không tìm thấy mã ITEM này!",
                    "text-login-btn": "Đăng nhập",
                    "text-password": "Nhập mật khẩu",
                    "text-staff-id": "Nhập ID Nhân viên",
                    "text-confirm": "Xác nhận",
                    "text-vfr3-wax": "Mẫu sáp",
                    "text-vfr3-sand": "Mẫu đúc cát",
                    "text-vfr3-ceramic": "Mẫu ceramic thạch cao",
                    "text-print-qr": "In QR",
                },
                en: {
                    "text-title": "V.F.R",
                    "text-create-rq": "Create Request",
                    "text-rq-status": "RQ Submitted",
                    "text-trf": "TRF",
                    "text-update-inf": "Update INF",
                    "text-logout": "Logout",
                    "text-item-label": "🔎 ITEM#",
                    "text-search-btn": "Search",
                    "text-view-report": "View report",
                    "text-th-item": "ITEM#",
                    "text-th-report": "REPORT#",
                    "text-th-type": "TYPE OF",
                    "text-th-status": "STATUS",
                    "text-th-action": "Action",
                    "text-notfound": "ITEM not found!",
                    "text-login-btn": "Login",
                    "text-password": "Enter password",
                    "text-staff-id": "Enter Staff ID",
                    "text-confirm": "Confirm",
                    "text-vfr3-wax": "Wax Sample",
                    "text-vfr3-sand": "Sand Casting Sample",
                    "text-vfr3-ceramic": "Ceramic Plaster Sample",
                    "text-print-qr": "Print QR",
                }
            };
            for (const key in LANG[lang]) {
                let els = document.getElementsByClassName(key);
                for (let i = 0; i < els.length; i++) {
                    if (els[i].tagName === "INPUT" && key === "text-password") {
                        els[i].placeholder = LANG[lang][key];
                    } else {
                        els[i].innerHTML = LANG[lang][key];
                    }
                }
            }
            let langBtn = document.getElementById('lang-btn');
            if (langBtn && langBtn.children[1]) {
                langBtn.children[1].innerText = lang === "en" ? "VI" : "EN";
            }
            setPref("lang", lang);
            localStorage.setItem("vfr-lang", lang);
        }
        document.addEventListener('DOMContentLoaded', function() {
            let lang = INIT_LANG || "vi";
            if (localStorage.getItem("vfr-lang")) lang = localStorage.getItem("vfr-lang");
            applyLang(lang);
            let langBtn = document.getElementById('lang-btn');
            if (langBtn) { langBtn.onclick = function() { lang = (lang === "en" ? "vi" : "en"); applyLang(lang); }; }
        });

        // --- DROPDOWN FILTER STATUS ---
        function toggleStatusDropdown() {
            var el = document.getElementById('dropdown-status-menu');
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
            setTimeout(function() { document.addEventListener('click', closeStatusDropdown); }, 20);
        }
        function closeStatusDropdown(event) {
            var el = document.getElementById('dropdown-status-menu');
            var btn = document.querySelector('.dropdown-status-btn');
            if (!el.contains(event.target) && !btn.contains(event.target)) {
                el.style.display = 'none';
                document.removeEventListener('click', closeStatusDropdown);
            }
        }

        // --- DROPDOWN REQUEST MENU (góc phải) ---
        function toggleRequestDropdown() {
            var menu = document.getElementById('requestDropdownMenu');
            menu.classList.toggle('show');
        }
        document.addEventListener('click', function(event) {
            var menu = document.getElementById('requestDropdownMenu');
            var btn = document.querySelector('.btn-more');
            if (menu && btn && !btn.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // --- EXPORT EXCEL (nếu có) ---
        function confirmExportExcel() { if(confirm("Bạn chắc chắn muốn chạy Update INF?")) { runExportExcel(); } }
        function runExportExcel() {
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch('/run_export_excel', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert(data.message || (data.success ? 'Đã chạy xong Export!' : 'Có lỗi!'));
                    if(data.success && data.reload) window.location.reload();
                })
                .catch(e => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert('Lỗi không kết nối được server!');
                });
        }
        document.addEventListener('DOMContentLoaded', function() { var overlay = document.getElementById('loading-overlay'); if(overlay) overlay.style.display = 'none'; });

        // === MODE (TEST LAB / VFR3) ===
        const STAFF_OK = {{ 'true' if session.get('staff_id') else 'false' }};

        // Cập nhật class body để hiển thị dropdown khi đã có staff_id (để CSS show/hide)
        document.addEventListener('DOMContentLoaded', function () {
            if (STAFF_OK) document.body.classList.add('has-staff');
        });

        function applyMode(mode) {
            const body = document.body;
            const current = document.getElementById('mode-current');
            const itemTL  = document.getElementById('mode-item-testlab');
            const itemV3  = document.getElementById('mode-item-vfr3');

            if (mode === 'VFR3') {
                body.classList.add('vfr3-mode');
                if (current) current.textContent = 'VFR3';
            } else {
                body.classList.remove('vfr3-mode');
                if (current) current.textContent = 'TEST LAB';
            }

            if (itemTL) itemTL.classList.toggle('active', mode === 'TEST_LAB');
            if (itemV3) itemV3.classList.toggle('active', mode === 'VFR3');
        }

        function setMode(mode) {
            localStorage.setItem('vfr-mode', mode);
            applyMode(mode);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.getElementById('mode-overlay');
            const btnTL   = document.getElementById('btn-mode-testlab');
            const btnV3   = document.getElementById('btn-mode-vfr3');

            // Dropdown elements
            const ddWrap  = document.querySelector('.mode-dropdown');
            const btnOpen = document.getElementById('mode-btn');
            const menu    = document.getElementById('mode-menu');

            // Áp dụng mode đã lưu
            const saved = localStorage.getItem('vfr-mode') || 'TEST_LAB';
            applyMode(saved);

            // == HIỆN OVERLAY nếu có Staff ID và CHƯA chọn mode lần nào ==
            if (STAFF_OK && overlay && !localStorage.getItem('vfr-mode')) {
                // đảm bảo dropdown không mở đè
                if (ddWrap) ddWrap.classList.remove('open');
                overlay.style.display = 'flex';
                document.body.classList.add('modal-open'); // khóa cuộn
            }

            // Nút chọn trên overlay
            function chooseAndClose(mode) {
                setMode(mode);
                if (overlay) overlay.style.display = 'none';
                document.body.classList.remove('modal-open'); // mở lại cuộn
            }
            if (btnTL) btnTL.onclick = () => chooseAndClose('TEST_LAB');
            if (btnV3) btnV3.onclick = () => chooseAndClose('VFR3');

            // Toggle dropdown (góc trái)
            if (btnOpen && ddWrap) {
                btnOpen.addEventListener('click', function (e) {
                    e.stopPropagation();
                    ddWrap.classList.toggle('open');
                });
            }

            // Chọn item trong menu
            if (menu) {
                menu.addEventListener('click', function (e) {
                    const a = e.target.closest('a[data-mode]');
                    if (!a) return;
                    e.preventDefault();
                    const mode = a.getAttribute('data-mode');
                    setMode(mode);
                    ddWrap && ddWrap.classList.remove('open');
                });
            }

            // Đóng dropdown khi click ra ngoài
            document.addEventListener('click', function (e) {
                if (!ddWrap) return;
                if (!ddWrap.contains(e.target)) ddWrap.classList.remove('open');
            });

            // Đóng overlay khi click ra ngoài (tùy chọn)
            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) {
                        // Nếu muốn bắt buộc chọn, có thể bỏ đoạn này đi
                        overlay.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    }
                });
            }
        });
        (function(){
        let qrLoaded = false;
        let html5qr = null;
        const $ = (id)=>document.getElementById(id);

        function ensureLib(){
            return new Promise((res, rej)=>{
            if (qrLoaded || window.Html5Qrcode){ qrLoaded = true; return res(); }
            const s = document.createElement('script');
            s.src = "https://unpkg.com/html5-qrcode";
            s.onload = ()=>{ qrLoaded = true; res(); };
            s.onerror = ()=>rej(new Error("Không tải được thư viện html5-qrcode"));
            document.head.appendChild(s);
            });
        }

        // === PHÁT HIỆN HỖ TRỢ CAMERA LIVE ===
        function cameraLiveSupported(){
            // Cần secure context (HTTPS hoặc localhost) + getUserMedia
            const secureOK = (window.isSecureContext === true) || /^https?:\/\/(localhost|127\.0\.0\.1)/.test(location.href);
            const gumOK = !!(navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function');
            // Tránh 1 số in-app browser phổ biến
            const ua = navigator.userAgent || '';
            const inApp = /(FBAN|FBAV|Instagram|Line\/|Zalo|ZaloPC|TikTok|KAKAOTALK|WeChat)/i.test(ua);
            return secureOK && gumOK && !inApp;
        }

        function parseAndGo(text){
            const resultEl = $('qr-result');
            if (resultEl) resultEl.textContent = "✅ Đã quét: " + text;

            if (/report=/.test(text)) { window.location.href = text; return; }
            const m = String(text || '').trim();
            if (/^([A-Z]{1,4}-?\d{3,8})$/.test(m) || /^TL-\d{4,8}$/i.test(m)) {
            window.location.href = "/update?report=" + encodeURIComponent(m);
            } else {
            alert("Mã QR không hợp lệ: " + text);
            }
        }

        async function startScan(){
            const overlay = $('qr-overlay');
            const reader  = $('qr-reader');
            const fileBtn = $('qr-file'); // input file
            const resultEl= $('qr-result');

            if (!overlay || !reader){ alert("Thiếu phần tử overlay/reader trong DOM."); return; }

            // Nếu KHÔNG hỗ trợ camera live -> fallback sang file capture (ảnh QR)
            if (!cameraLiveSupported()){
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
            // Ẩn khung camera, hiện hướng dẫn
            reader.style.display = 'none';
            if (resultEl) resultEl.textContent = "Trình duyệt không hỗ trợ camera trực tiếp. Vui lòng bấm 'Ảnh QR' để chụp/tải ảnh mã QR.";
            if (fileBtn) fileBtn.click(); // tự bật lựa chọn ảnh/camera
            return;
            }

            // Hỗ trợ camera live
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');

            try{
            await stopScan();
            await ensureLib();
            html5qr = new Html5Qrcode('qr-reader');
            reader.style.display = ''; // đảm bảo hiện khung
            await html5qr.start(
                { facingMode: "environment" },
                {
                fps: 10,
                qrbox: (vw, vh)=>{
                    const min = Math.min(vw, vh);
                    const box = Math.min(320, Math.floor(min * 0.7));
                    return { width: box, height: box };
                }
                },
                (decodedText)=>{ stopScan().then(()=>parseAndGo(decodedText)); },
                ()=>{} // ignore frame errors
            );
            }catch(err){
            await stopScan();
            overlay.style.display = 'flex'; // vẫn giữ overlay để dùng ảnh QR
            document.body.classList.add('modal-open');
            reader.style.display = 'none';
            if (resultEl) resultEl.textContent = "Không mở được camera. Vui lòng dùng 'Ảnh QR' để quét.";
            // tự bật file capture cho nhanh
            if (fileBtn) fileBtn.click();
            }
        }

        async function stopScan(){
            if (html5qr){
            try{ await html5qr.stop(); }catch(_){}
            try{ await html5qr.clear(); }catch(_){}
            html5qr = null;
            }
        }

        async function decodeImageFile(file){
            await ensureLib();
            const tmpId = "qr-file-reader-tmp";
            let tmp = $(tmpId);
            if (!tmp){ tmp = document.createElement('div'); tmp.id = tmpId; tmp.style.display = "none"; document.body.appendChild(tmp); }
            const qr = new Html5Qrcode(tmpId);
            const result = await qr.scanFile(file, true);
            await qr.clear();
            return result;
        }

        window.addEventListener('DOMContentLoaded', ()=>{
            const btnOpen = $('qr-btn');
            const btnClose= $('qr-close');
            const fileInp = $('qr-file');
            const overlay = $('qr-overlay');

            if (btnOpen){
            btnOpen.addEventListener('click', ()=>{ startScan(); });
            }
            if (btnClose){
            btnClose.addEventListener('click', async ()=>{
                await stopScan();
                if (overlay) overlay.style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            }
            if (overlay){
            overlay.addEventListener('click', async (e)=>{
                if (e.target === overlay){
                await stopScan();
                overlay.style.display = 'none';
                document.body.classList.remove('modal-open');
                }
            });
            }
            if (fileInp){
            fileInp.addEventListener('change', async function(){
                const f = this.files && this.files[0];
                if (!f) return;
                const resultEl = $('qr-result');
                if (resultEl) resultEl.textContent = "Đang đọc ảnh QR...";
                try{
                const text = await decodeImageFile(f);
                parseAndGo(text);
                }catch(_){
                if (resultEl) resultEl.textContent = "Không đọc được mã từ ảnh. Hãy chụp rõ, đủ sáng.";
                }finally{
                this.value = "";
                }
            });
            }
        });
        })();
    </script>

    <div id="loading-overlay" style="display:none;position:fixed;z-index:20005;top:0;left:0;width:100vw;height:100vh;background:rgba(60,60,60,0.34);backdrop-filter:blur(1px);display:flex;align-items:center;justify-content:center;">
      <div style="background:#fffbe8ee;padding:32px 44px;border-radius:18px;box-shadow:0 2px 16px #2224;display:flex;flex-direction:column;align-items:center;">
        <div class="loader" style="margin-bottom:18px;">
          <i class="fa fa-spinner fa-spin" style="font-size:44px;color:#c49c48;"></i>
        </div>
        <div style="font-size:19px; font-weight:600; color:#b78e24; text-align:center;">
          Đang xuất dữ liệu Excel...<br>Vui lòng chờ 1-2 phút!
        </div>
      </div>
    </div>
    <!-- Overlay quét QR -->
    <div id="qr-overlay" role="dialog" aria-modal="true">
      <div id="qr-card">
        <div id="qr-head">
          <div id="qr-title">📷 Quét mã QR Report</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label for="qr-file" style="background:#ffe082;color:#232;padding:6px 10px;border-radius:10px; font-weight:700; cursor:pointer;">
              Ảnh QR
            </label>
            <input id="qr-file" type="file" accept="image/*" capture="environment" style="display:none;">
            <button id="qr-close" type="button">Đóng</button>
          </div>
        </div>
        <div id="qr-reader"></div>
        <div id="qr-result"></div>
        <div style="font-size:12px;color:#8b6b1e; margin-top:8px; text-align:center">
          Hướng camera hoặc tải ảnh QR. Nếu QR chứa URL /update?report=..., sẽ tự mở; nếu chỉ có REPORT#, sẽ tự chuyển sang /update.
        </div>
      </div>
    </div>
</body>
</html>
